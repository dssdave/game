<!DOCTYPE html>
<html>
<head>
    <title>Simple 3D Princess RPG</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            background: #000;
        }
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #fff;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
        }
        #dialogue {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: #fff;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            max-width: 600px;
        }
    </style>
    <!-- Include Three.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <div id="ui">
        Flowers: <span id="flowers">0</span> |
        Coins: <span id="coins">0</span> |
        Gems: <span id="gems">0</span> |
        Potions: <span id="potions">0</span> |
        Health: <span id="health">100</span> |
        Location: <span id="location">Town</span>
    </div>
    <div id="dialogue"></div>

    <script>
        // Scene setup
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Game state
        class Game {
            constructor() {
                this.scene = 'town';
                this.flowers = 0;
                this.coins = 0;
                this.gems = 0;
                this.potions = 0;
                this.health = 100;
                this.player = {
                    x: 0,
                    z: 0,
                    speed: 0.5,
                    yaw: 0,
                    object: null
                };
                this.dialogue = '';
                this.dialogueTimer = 0;
                this.objects = [];
                this.initScene();
            }
            showDialogue(text) {
                this.dialogue = text;
                this.dialogueTimer = 120; // Display for 2 seconds (60 FPS)
            }
            initScene() {
                // Ground
                const groundGeometry = new THREE.PlaneGeometry(50, 50);
                const groundMaterial = new THREE.MeshBasicMaterial({ color: 0x6bb26b, side: THREE.DoubleSide });
                const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                ground.rotation.x = Math.PI / 2;
                scene.add(ground);

                // Player (simple cube for princess)
                const playerGeometry = new THREE.BoxGeometry(1, 2, 1);
                const playerMaterial = new THREE.MeshBasicMaterial({ color: 0xff69b4 }); // Pink for princess
                this.player.object = new THREE.Mesh(playerGeometry, playerMaterial);
                this.player.object.position.set(this.player.x, 1, this.player.z);
                scene.add(this.player.object);

                // Objects (buildings, collectibles)
                this.objects = this.createObjects(this.scene);
                this.objects.forEach(obj => scene.add(obj.mesh));
            }
            createObjects(scene) {
                const objects = [];
                if (scene === 'town') {
                    // Castle (large cube)
                    const castleGeometry = new THREE.BoxGeometry(5, 5, 5);
                    const castleMaterial = new THREE.MeshBasicMaterial({ color: 0x808080 }); // Grey for stone
                    const castle = new THREE.Mesh(castleGeometry, castleMaterial);
                    castle.position.set(10, 2.5, 10);
                    objects.push({ mesh: castle, type: 'building', x: 10, z: 10 });

                    // House (smaller cube)
                    const houseGeometry = new THREE.BoxGeometry(3, 3, 3);
                    const houseMaterial = new THREE.MeshBasicMaterial({ color: 0x808080 }); // Grey for stone
                    const house = new THREE.Mesh(houseGeometry, houseMaterial);
                    house.position.set(-10, 1.5, -10);
                    objects.push({ mesh: house, type: 'building', x: -10, z: -10 });

                    // Door for castle (red cube at bottom-left)
                    const doorGeometry = new THREE.BoxGeometry(1, 2, 0.5);
                    const doorMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 }); // Red for door
                    const castleDoor = new THREE.Mesh(doorGeometry, doorMaterial);
                    castleDoor.position.set(7.5, 1, 7.5); // Bottom-left of castle
                    objects.push({ mesh: castleDoor, type: 'door', x: 7.5, z: 7.5, building: 'castle' });

                    // Door for house (red cube at bottom-left)
                    const houseDoor = new THREE.Mesh(doorGeometry, doorMaterial);
                    houseDoor.position.set(-11.5, 1, -11.5); // Bottom-left of house
                    objects.push({ mesh: houseDoor, type: 'door', x: -11.5, z: -11.5, building: 'house' });

                    // Flowers (small spheres, magenta)
                    const flowerGeometry = new THREE.SphereGeometry(0.3, 16, 16);
                    const flowerMaterial = new THREE.MeshBasicMaterial({ color: 0xff00ff });
                    const flower1 = new THREE.Mesh(flowerGeometry, flowerMaterial);
                    flower1.position.set(5, 0.3, 5);
                    objects.push({ mesh: flower1, type: 'flower', x: 5, z: 5 });

                    const flower2 = new THREE.Mesh(flowerGeometry, flowerMaterial);
                    flower2.position.set(-5, 0.3, 0);
                    objects.push({ mesh: flower2, type: 'flower', x: -5, z: 0 });

                    // Coins (small spheres, gold)
                    const coinGeometry = new THREE.SphereGeometry(0.3, 16, 16);
                    const coinMaterial = new THREE.MeshBasicMaterial({ color: 0xffd700 });
                    const coin1 = new THREE.Mesh(coinGeometry, coinMaterial);
                    coin1.position.set(0, 0.3, 5);
                    objects.push({ mesh: coin1, type: 'coin', x: 0, z: 5 });

                    const coin2 = new THREE.Mesh(coinGeometry, coinMaterial);
                    coin2.position.set(5, 0.3, -5);
                    objects.push({ mesh: coin2, type: 'coin', x: 5, z: -5 });

                    // Gems (small octahedrons, cyan)
                    const gemGeometry = new THREE.OctahedronGeometry(0.3, 0);
                    const gemMaterial = new THREE.MeshBasicMaterial({ color: 0x00ffff });
                    const gem = new THREE.Mesh(gemGeometry, gemMaterial);
                    gem.position.set(-5, 0.3, 5);
                    objects.push({ mesh: gem, type: 'gem', x: -5, z: 5 });

                    // Potions (small cylinders, orange)
                    const potionGeometry = new THREE.CylinderGeometry(0.2, 0.2, 0.8, 32);
                    const potionMaterial = new THREE.MeshBasicMaterial({ color: 0xff4500 });
                    const potion = new THREE.Mesh(potionGeometry, potionMaterial);
                    potion.position.set(0, 0.4, -5);
                    objects.push({ mesh: potion, type: 'potion', x: 0, z: -5 });

                    // Shop (small cube, yellow)
                    const shopGeometry = new THREE.BoxGeometry(2, 2, 2);
                    const shopMaterial = new THREE.MeshBasicMaterial({ color: 0xffff00 });
                    const shop = new THREE.Mesh(shopGeometry, shopMaterial);
                    shop.position.set(0, 1, 0);
                    objects.push({ mesh: shop, type: 'shop', x: 0, z: 0 });
                } else if (scene === 'castle') {
                    // Simple castle interior (large room)
                    const roomGeometry = new THREE.BoxGeometry(20, 5, 20);
                    const roomMaterial = new THREE.MeshBasicMaterial({ color: 0xdeb887 }); // Tan for interior
                    const room = new THREE.Mesh(roomGeometry, roomMaterial);
                    room.position.set(0, 2.5, 0);
                    objects.push({ mesh: room, type: 'room', x: 0, z: 0 });

                    // NPC (king, blue cube)
                    const npcGeometry = new THREE.BoxGeometry(1, 2, 1);
                    const npcMaterial = new THREE.MeshBasicMaterial({ color: 0x00008b });
                    const npc = new THREE.Mesh(npcGeometry, npcMaterial);
                    npc.position.set(5, 1, 5);
                    objects.push({ mesh: npc, type: 'npc', x: 5, z: 5 });

                    // Door (red cube to exit)
                    const doorGeometry = new THREE.BoxGeometry(1, 2, 0.5);
                    const doorMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
                    const door = new THREE.Mesh(doorGeometry, doorMaterial);
                    door.position.set(-9.5, 1, -9.5); // Bottom-left exit
                    objects.push({ mesh: door, type: 'door', x: -9.5, z: -9.5, building: 'town' });
                } else if (scene === 'house') {
                    // Simple house interior (small room)
                    const roomGeometry = new THREE.BoxGeometry(10, 3, 10);
                    const roomMaterial = new THREE.MeshBasicMaterial({ color: 0xdeb887 }); // Tan for interior
                    const room = new THREE.Mesh(roomGeometry, roomMaterial);
                    room.position.set(0, 1.5, 0);
                    objects.push({ mesh: room, type: 'room', x: 0, z: 0 });

                    // NPC (villager, blue cube)
                    const npcGeometry = new THREE.BoxGeometry(1, 2, 1);
                    const npcMaterial = new THREE.MeshBasicMaterial({ color: 0x00008b });
                    const npc = new THREE.Mesh(npcGeometry, npcMaterial);
                    npc.position.set(3, 1, 3);
                    objects.push({ mesh: npc, type: 'npc', x: 3, z: 3 });

                    // Door (red cube to exit)
                    const doorGeometry = new THREE.BoxGeometry(1, 2, 0.5);
                    const doorMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
                    const door = new THREE.Mesh(doorGeometry, doorMaterial);
                    door.position.set(-4.5, 1, -4.5); // Bottom-left exit
                    objects.push({ mesh: door, type: 'door', x: -4.5, z: -4.5, building: 'town' });

                    // Hidden gem (cyan octahedron)
                    const gemGeometry = new THREE.OctahedronGeometry(0.3, 0);
                    const gemMaterial = new THREE.MeshBasicMaterial({ color: 0x00ffff });
                    const gem = new THREE.Mesh(gemGeometry, gemMaterial);
                    gem.position.set(0, 0.3, 0);
                    objects.push({ mesh: gem, type: 'gem', x: 0, z: 0 });
                }
                return objects;
            }
            updateObjects() {
                scene.remove(...this.objects.map(obj => obj.mesh));
                this.objects = this.createObjects(this.scene);
                this.objects.forEach(obj => scene.add(obj.mesh));
            }
        }

        let game = new Game();

        // Camera setup
        camera.position.set(0, 10, 20);
        camera.lookAt(0, 0, 0);

        // Lighting
        const ambientLight = new THREE.AmbientLight(0x404040); // Soft white light
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
        directionalLight.position.set(0, 10, 0);
        scene.add(directionalLight);

        // Input handling
        const keys = {};
        document.addEventListener('keydown', (e) => keys[e.key] = true);
        document.addEventListener('keyup', (e) => keys[e.key] = false);

        document.addEventListener('mousedown', () => {
            document.body.requestPointerLock();
        });

        document.addEventListener('mousemove', (event) => {
            if (document.pointerLockElement === document.body) {
                const movementX = event.movementX || event.mozMovementX || event.webkitMovementX || 0;
                game.player.yaw += movementX * 0.002;
            }
        });

        // Update and render loop
        function update() {
            game.updateDayNight();

            let dx = 0, dz = 0;
            if (keys['ArrowUp']) dz -= game.player.speed;
            if (keys['ArrowDown']) dz += game.player.speed;
            if (keys['ArrowLeft']) dx -= game.player.speed;
            if (keys['ArrowRight']) dx += game.player.speed;

            const newX = game.player.x + dx * Math.cos(game.player.yaw) + dz * Math.sin(game.player.yaw);
            const newZ = game.player.z - dx * Math.sin(game.player.yaw) + dz * Math.cos(game.player.yaw);

            if (!game.objects.some(obj => {
                const distX = Math.abs(obj.x - newX);
                const distZ = Math.abs(obj.z - newZ);
                return (obj.type === 'building' || obj.type === 'wall') && distX < 2.5 && distZ < 2.5;
            })) {
                game.player.x = newX;
                game.player.z = newZ;
            }

            game.player.object.position.set(game.player.x, 1, game.player.z);
            game.player.object.rotation.y = -game.player.yaw;

            // Camera follows player
            camera.position.set(game.player.x, 10, game.player.z + 20);
            camera.lookAt(game.player.x, 1, game.player.z);

            // Check for interactions
            game.objects.forEach(obj => {
                const distX = Math.abs(obj.x - game.player.x);
                const distZ = Math.abs(obj.z - game.player.z);
                if (distX < 1 && distZ < 1) {
                    if (obj.type === 'flower') {
                        game.flowers++;
                        scene.remove(obj.mesh);
                        game.objects = game.objects.filter(o => o !== obj);
                        game.showDialogue('You picked a flower! *Sparkle*');
                    } else if (obj.type === 'coin') {
                        game.coins++;
                        scene.remove(obj.mesh);
                        game.objects = game.objects.filter(o => o !== obj);
                        game.showDialogue('You found a coin!');
                    } else if (obj.type === 'gem') {
                        game.gems++;
                        scene.remove(obj.mesh);
                        game.objects = game.objects.filter(o => o !== obj);
                        game.showDialogue('You found a gem!');
                    } else if (obj.type === 'potion') {
                        game.potions++;
                        scene.remove(obj.mesh);
                        game.objects = game.objects.filter(o => o !== obj);
                        game.showDialogue('You found a potion!');
                    } else if (obj.type === 'door') {
                        if (game.scene === 'town') {
                            if (obj.building === 'castle') game.scene = 'castle';
                            else if (obj.building === 'house') game.scene = 'house';
                            game.player.x = 0;
                            game.player.z = 0;
                            game.player.yaw = 0;
                            game.updateObjects();
                            game.showDialogue(`Entered the ${game.scene}!`);
                        } else if (game.scene !== 'town' && obj.building === 'town') {
                            game.scene = 'town';
                            game.player.x = obj.x;
                            game.player.z = obj.z;
                            game.player.yaw = 0;
                            game.updateObjects();
                            game.showDialogue('Returned to the town!');
                        }
                    } else if (obj.type === 'npc') {
                        if (game.scene === 'town' && !game.questStatus.townGuard) {
                            game.showDialogue('Town Guard: Princess, the king needs a flower. Bring one to the castle!');
                            game.questStatus.townGuard = true;
                        } else if (game.scene === 'town' && game.questStatus.townGuard) {
                            game.showDialogue('Town Guard: Have you given the flower to the king?');
                        } else if (game.scene === 'castle' && !game.questStatus.castleKing && game.flowers > 0) {
                            game.showDialogue('King: Thank you! Here’s a gem.');
                            game.gems++;
                            game.flowers--;
                            game.questStatus.castleKing = true;
                        } else if (game.scene === 'castle' && game.questStatus.castleKing) {
                            game.showDialogue('King: You’re a hero!');
                        } else if (game.scene === 'house' && !game.questStatus.villagerQuest) {
                            game.showDialogue('Villager: I lost my gem. Find it, and I’ll give you a potion!');
                            game.questStatus.villagerQuest = true;
                        } else if (game.scene === 'house' && game.questStatus.villagerQuest && game.gems > 0) {
                            game.showDialogue('Villager: Thank you! Here’s a potion.');
                            game.potions++;
                            game.gems--;
                            game.questStatus.villagerQuest = false;
                        }
                    } else if (obj.type === 'shop') {
                        if (game.coins >= 5) {
                            game.coins -= 5;
                            game.potions++;
                            game.showDialogue('Shopkeeper: Here’s a potion for 5 coins!');
                        } else {
                            game.showDialogue('Shopkeeper: Need 5 coins for a potion!');
                        }
                    }
                }
            });

            if (Object.values(keys).some(k => k)) {
                game.player.frame = (game.player.frame + 1) % 30;
            }

            // Update dialogue
            if (game.dialogueTimer > 0) {
                game.dialogueTimer--;
                if (game.dialogueTimer === 0) {
                    game.dialogue = '';
                }
            }
            document.getElementById('dialogue').textContent = game.dialogue;

            // Update UI
            document.getElementById('flowers').textContent = game.flowers;
            document.getElementById('coins').textContent = game.coins;
            document.getElementById('gems').textContent = game.gems;
            document.getElementById('potions').textContent = game.potions;
            document.getElementById('health').textContent = game.health;
            document.getElementById('location').textContent = game.scene.charAt(0).toUpperCase() + game.scene.slice(1);
        }

        function animate() {
            requestAnimationFrame(animate);
            update();
            renderer.render(scene, camera);
        }

        animate();

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
