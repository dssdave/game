<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=no">
  <title>Princess Donia’s Town – Enhanced RPG</title>
  <style>
    html, body { margin:0; padding:0; background:#000; font-family:Arial, sans-serif; overflow:hidden; user-select:none; touch-action:manipulation; }
    #gameContainer { position:relative; width:100vw; height:100vh; }
    canvas { display:block; }
    #ui, #ballCount, #dialogue, #controls, #errorMessage, #guardPopup, #healthBar, #inventory {
      background:rgba(0,0,0,0.7); border:4px solid #fff; border-radius:5px; color:#fff; font-size:28px; padding:20px 30px; position:absolute; z-index:10;
    }
    #ui { top:10px; left:10px; }
    #ballCount { top:10px; right:10px; }
    #dialogue { bottom:10px; left:10px; max-width:600px; display:none; }
    #controls { bottom:10px; right:10px; font-size:20px; }
    #errorMessage { top:50%; left:50%; transform:translate(-50%,-50%); display:none; text-align:center; }
    #guardPopup { bottom:50%; left:50%; transform:translate(-50%,50%); display:none; text-align:center; }
    #healthBar { top:10px; left:50%; transform:translateX(-50%); width:300px; height:20px; background:#333; border:3px solid #fff; border-radius:10px; overflow:hidden; z-index:10; }
    #healthFill { width:100%; height:100%; background:#00ff00; transition:width 0.3s, background 0.3s; }
    #toggleUIBtn { position:absolute; top:10px; left:50%; transform:translateX(-50%); z-index:11; font-size:24px; padding:10px 20px; background:#333; color:#fff; border:2px solid #fff; border-radius:5px; cursor:pointer; }
    #inventory { display:none; top:50%; left:50%; transform:translate(-50%,-50%); padding:30px; border:4px solid #ffd700; border-radius:15px; font-size:24px; text-align:center; z-index:20; }
    #dpadContainer {
      position:absolute; bottom:16vh; left:5vw; z-index:15;
      display:grid; grid-template-columns:80px 80px 80px; grid-template-rows:80px 80px 80px; gap:10px;
    }
    #dpadContainer button {
      width:80px; height:80px; background:rgba(255,255,255,0.3); border:3px solid #fff; border-radius:10px;
      font-size:32px; color:#fff; cursor:pointer;
    }
    #actionContainer {
      position:absolute; bottom:16vh; right:5vw; z-index:15;
      display:flex; flex-direction:column; gap:15px;
    }
    #actionContainer button {
      width:80px; height:80px; background:rgba(255,100,100,0.6); border:3px solid #fff; border-radius:50%;
      font-size:20px; color:#fff;
    }
    @media (max-width:768px) {
      #ui, #ballCount, #dialogue, #controls { font-size:16px; padding:10px 15px; }
      #dpadContainer { grid-template-columns:60px 60px 60px; grid-template-rows:60px 60px 60px; gap:8px; }
      #dpadContainer button { width:60px; height:60px; font-size:24px; }
      #actionContainer button { width:60px; height:60px; font-size:16px; }
      #healthBar { width:200px; }
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <button id="toggleUIBtn">Toggle UI</button>
    <div id="ui">
      Flowers: <span id="flowers">0</span> |
      Coins: <span id="coins">0</span> |
      Gems: <span id="gems">0</span> |
      Potions: <span id="potions">0</span> |
      Keys: <span id="keys">0</span> |
      Artifacts: <span id="artifacts">0</span> |
      Health: <span id="health">100</span> |
      Time: <span id="time">Day</span> |
      Location: <span id="location">Town</span>
    </div>
    <div id="ballCount">Magic Orbs Thrown: <span id="ballCountValue">0</span></div>
    <div id="dialogue"></div>
    <div id="controls">
      Touch: D-Pad = move/turn<br>
      A = throw orb, B = jump<br>
      Desktop: WASD/Arrows, Space, B
    </div>
    <div id="errorMessage">WebGL not supported or failed to initialize.</div>
    <div id="guardPopup"></div>
    <div id="healthBar"><div id="healthFill"></div></div>
    <div id="inventory">
      <div>Flowers Collected: <span id="invFlowers">0</span></div>
      <div style="margin-top:20px;">Quest: Collect 10 flowers to restore the garden</div>
    </div>

    <!-- Classic D-Pad -->
    <div id="dpadContainer">
      <div></div>
      <button id="btnUp">↑</button>
      <div></div>
      <button id="btnLeft">←</button>
      <div></div>
      <button id="btnRight">→</button>
      <div></div>
      <button id="btnDown">↓</button>
      <div></div>
    </div>

    <!-- Action Buttons -->
    <div id="actionContainer">
      <button id="btnOrb">A Orb</button>
      <button id="btnJump">B Jump</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    const outsideScene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 3000);
    const keysPressed = {};
    const dpad = {up:false, down:false, left:false, right:false};
    let game = null;

    // Safe DOM setup after load
    window.addEventListener('load', () => {
      // D-Pad
      ['btnUp','btnDown','btnLeft','btnRight'].forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
          btn.addEventListener('touchstart', e => { e.preventDefault(); dpad[id.slice(3).toLowerCase()] = true; }, {passive:false});
          btn.addEventListener('touchend', () => dpad[id.slice(3).toLowerCase()] = false);
          btn.addEventListener('mousedown', () => dpad[id.slice(3).toLowerCase()] = true);
          btn.addEventListener('mouseup', () => dpad[id.slice(3).toLowerCase()] = false);
        }
      });

      // Actions
      const btnOrb = document.getElementById('btnOrb');
      const btnJump = document.getElementById('btnJump');
      if (btnOrb) {
        btnOrb.addEventListener('click', () => game?.throwBall());
        btnOrb.addEventListener('touchstart', e => {e.preventDefault(); game?.throwBall();});
      }
      if (btnJump) {
        btnJump.addEventListener('click', () => game?.jump());
        btnJump.addEventListener('touchstart', e => {e.preventDefault(); game?.jump();});
      }

      // Toggle UI
      const toggleBtn = document.getElementById('toggleUIBtn');
      if (toggleBtn) {
        toggleBtn.onclick = () => {
          ["ui","ballCount","dialogue","controls","guardPopup","errorMessage","healthBar"].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = el.style.display === "none" ? "block" : "none";
          });
        };
      }

      // Start game
      try {
        game = new Game();
        window.game = game;
      } catch (e) {
        console.error(e);
        const err = document.getElementById('errorMessage');
        if (err) err.style.display = 'block';
      }
    });

    class Game {
      constructor() {
        const canvas = document.getElementById('gameCanvas');
        if (!canvas) return;

        const isMobile = /iPad|iPhone|iPod|Android/i.test(navigator.userAgent);
        let gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        if (!gl) {
          const err = document.getElementById('errorMessage');
          if (err) err.style.display = 'block';
          return;
        }

        this.renderer = new THREE.WebGLRenderer({canvas, context: gl, antialias: !isMobile});
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, isMobile ? 1 : 2));
        this.renderer.shadowMap.enabled = !isMobile;

        this.player = {x:0, y:0.5, z:0, yaw:0, jumpVelocity:0, object:null, bobTime:0};
        this.flowers = 0; this.health = 100; this.ballCount = 0; this.thrownBalls = [];
        this.dayNightCounter = 0; this.time = "Day";
        this.outsideObjects = []; this.npcs = [];

        this.questActive = false; this.questComplete = false;

        this.initWorld();
        this.createPlayer();
        this.createTownFeatures();
        this.startAnimation();
      }

      generateCobblestoneTexture() {
        const canvas = document.createElement('canvas');
        canvas.width = canvas.height = 256;
        const ctx = canvas.getContext('2d');
        for (let y = 0; y < 256; y += 32) {
          for (let x = 0; x < 256; x += 32) {
            const shade = 100 + Math.random() * 40;
            ctx.fillStyle = `rgb(${shade},${shade-10},${shade-20})`;
            ctx.fillRect(x, y, 32, 32);
            ctx.strokeStyle = '#555';
            ctx.strokeRect(x, y, 32, 32);
          }
        }
        const tex = new THREE.CanvasTexture(canvas);
        tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
        tex.repeat.set(4, 4);
        return tex;
      }

      initWorld() {
        outsideScene.background = new THREE.Color(0x87CEEB);

        // Grass ground
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshStandardMaterial({color: 0x6bb26b}));
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        outsideScene.add(ground);

        // Cobblestone paths
        const pathMat = new THREE.MeshStandardMaterial({map: this.generateCobblestoneTexture()});
        const pathNS = new THREE.Mesh(new THREE.PlaneGeometry(12, 200), pathMat);
        pathNS.rotation.x = -Math.PI / 2; pathNS.position.set(0, 0.02, 0);
        outsideScene.add(pathNS);
        const pathEW = new THREE.Mesh(new THREE.PlaneGeometry(200, 12), pathMat);
        pathEW.rotation.x = -Math.PI / 2; pathEW.position.set(0, 0.02, 0);
        outsideScene.add(pathEW);

        const ambient = new THREE.AmbientLight(0xffffff, 0.6);
        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(50, 100, 50);
        dirLight.castShadow = true;
        outsideScene.add(ambient, dirLight);

        this.createSun();
        this.createMoon();
        this.createStars();
        this.createFireflies();
      }

      createSun() {
        const sun = new THREE.Mesh(new THREE.SphereGeometry(10, 16, 16), new THREE.MeshBasicMaterial({color: 0xffee00}));
        sun.position.set(0, 200, -200);
        this.sunMesh = sun;
        outsideScene.add(sun);
      }

      createMoon() {
        const moon = new THREE.Mesh(new THREE.SphereGeometry(6, 16, 16), new THREE.MeshBasicMaterial({color: 0xddddff}));
        moon.position.set(-100, 150, 100);
        moon.visible = false;
        this.moonMesh = moon;
        outsideScene.add(moon);
      }

      createStars() {
        const count = 300;
        const positions = new Float32Array(count * 3);
        for (let i = 0; i < count; i++) {
          const r = 300 + Math.random() * 200;
          const a = Math.random() * Math.PI * 2;
          positions[i*3] = Math.cos(a) * r;
          positions[i*3+1] = 50 + Math.random() * 100;
          positions[i*3+2] = Math.sin(a) * r;
        }
        const geo = new THREE.BufferGeometry();
        geo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        const mat = new THREE.PointsMaterial({color: 0xffffff, size: 1.5});
        this.starsMesh = new THREE.Points(geo, mat);
        this.starsMesh.visible = false;
        outsideScene.add(this.starsMesh);
      }

      createFireflies() {
        const count = 80;
        const positions = new Float32Array(count * 3);
        for (let i = 0; i < count; i++) {
          positions[i*3] = (Math.random() - 0.5) * 300;
          positions[i*3+1] = 5 + Math.random() * 20;
          positions[i*3+2] = (Math.random() - 0.5) * 300;
        }
        const geo = new THREE.BufferGeometry();
        geo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        const mat = new THREE.PointsMaterial({color: 0xffff88, size: 3, transparent: true});
        this.fireflies = new THREE.Points(geo, mat);
        this.fireflies.visible = false;
        outsideScene.add(this.fireflies);
      }

      createPlayer() {
        const g = new THREE.Group();
        const dress = new THREE.Mesh(new THREE.ConeGeometry(0.6, 1.6, 16), new THREE.MeshStandardMaterial({color: 0xff69b4}));
        dress.position.y = 0.7; g.add(dress);
        const torso = new THREE.Mesh(new THREE.CylinderGeometry(0.35, 0.4, 0.8, 16), new THREE.MeshStandardMaterial({color: 0xffa0d0}));
        torso.position.y = 1.2; g.add(torso);
        const head = new THREE.Mesh(new THREE.SphereGeometry(0.3, 16, 16), new THREE.MeshStandardMaterial({color: 0xffddc1}));
        head.position.y = 1.8; g.add(head);
        const hair = new THREE.Mesh(new THREE.CylinderGeometry(0.35, 0.45, 1.2, 16), new THREE.MeshStandardMaterial({color: 0xb5651d}));
        hair.position.y = 1.9; g.add(hair);
        const crown = new THREE.Mesh(new THREE.TorusGeometry(0.32, 0.08, 8, 16), new THREE.MeshStandardMaterial({color: 0xffd700, emissive: 0xffd700, emissiveIntensity: 0.8}));
        crown.rotation.x = Math.PI / 2; crown.position.y = 2.15; g.add(crown);
        const armGeo = new THREE.CylinderGeometry(0.1, 0.1, 0.9, 8);
        const armMat = new THREE.MeshStandardMaterial({color: 0xffddc1});
        const leftArm = new THREE.Mesh(armGeo, armMat);
        leftArm.position.set(-0.5, 1.3, 0); leftArm.rotation.z = 0.3; leftArm.userData.arm = true; g.add(leftArm);
        const rightArm = leftArm.clone(); rightArm.position.x = 0.5; rightArm.rotation.z = -0.3; g.add(rightArm);
        g.position.set(this.player.x, this.player.y, this.player.z);
        this.player.object = g;
        outsideScene.add(g);
      }

      createBench(x, z, rot = 0) {
        const g = new THREE.Group();
        const seat = new THREE.Mesh(new THREE.BoxGeometry(3, 0.3, 0.8), new THREE.MeshStandardMaterial({color: 0x8b4513}));
        seat.position.y = 0.5; g.add(seat);
        const leg = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.8, 0.2), new THREE.MeshStandardMaterial({color: 0x654321}));
        [-1.2, 1.2].forEach(px => [-0.3, 0.3].forEach(pz => {
          const l = leg.clone(); l.position.set(px, 0.2, pz); g.add(l);
        }));
        g.position.set(x, 0, z); g.rotation.y = rot;
        outsideScene.add(g);
        this.outsideObjects.push({type:'decoration', x, z, boundingRadius:2});
      }

      createStatueFountain() {
        const g = new THREE.Group();
        const base = new THREE.Mesh(new THREE.CylinderGeometry(4, 4, 1, 16), new THREE.MeshStandardMaterial({color: 0x808080}));
        base.position.y = 0.5; g.add(base);
        const water = new THREE.Mesh(new THREE.CylinderGeometry(3.8, 3.8, 0.3, 16), new THREE.MeshStandardMaterial({color: 0x1e90ff, transparent:true, opacity:0.7}));
        water.position.y = 1.15; g.add(water);
        const statue = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.5, 2, 16), new THREE.MeshStandardMaterial({color: 0xffffff}));
        statue.position.y = 2; g.add(statue);
        const head = new THREE.Mesh(new THREE.SphereGeometry(0.3, 16, 16), new THREE.MeshStandardMaterial({color: 0xffddc1}));
        head.position.y = 3.2; g.add(head);
        g.position.set(0, 0, 0);
        outsideScene.add(g);
        this.outsideObjects.push({type:'decoration', x:0, z:0, boundingRadius:5});
      }

      createNPC(color, x, z) {
        const g = new THREE.Group();
        const body = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.5, 1.2, 16), new THREE.MeshStandardMaterial({color}));
        body.position.y = 0.6; g.add(body);
        const head = new THREE.Mesh(new THREE.SphereGeometry(0.3, 16, 16), new THREE.MeshStandardMaterial({color: 0xffddc1}));
        head.position.y = 1.4; g.add(head);
        g.position.set(x, 0.5, z);
        outsideScene.add(g);
        this.npcs.push({object: g, angle: Math.random() * Math.PI * 2, speed: 0.01 + Math.random() * 0.01, radius: 20 + Math.random() * 30});
        this.outsideObjects.push({type:'npc', x, z, boundingRadius:1});
      }

      createCastle() {
        const g = new THREE.Group();
        const mat = new THREE.MeshStandardMaterial({color: 0x888888});
        const base = new THREE.Mesh(new THREE.BoxGeometry(20, 10, 20), mat);
        base.position.y = 5; g.add(base);
        g.position.set(40, 0, 40);
        outsideScene.add(g);
        this.outsideObjects.push({type:'building', x:40, z:40, boundingRadius:12});
      }

      createHouse() {
        const g = new THREE.Group();
        const mat = new THREE.MeshStandardMaterial({color: 0x8b4513});
        const base = new THREE.Mesh(new THREE.BoxGeometry(12, 8, 10), mat);
        base.position.y = 4; g.add(base);
        g.position.set(-40, 0, -40);
        outsideScene.add(g);
        this.outsideObjects.push({type:'building', x:-40, z:-40, boundingRadius:10});
      }

      createCafe() {
        const g = new THREE.Group();
        const mat = new THREE.MeshStandardMaterial({color: 0x888888});
        const base = new THREE.Mesh(new THREE.BoxGeometry(12, 7, 10), mat);
        base.position.y = 3.5; g.add(base);
        g.position.set(70, 0, -30);
        outsideScene.add(g);
        this.outsideObjects.push({type:'building', x:70, z:-30, boundingRadius:10});
      }

      createGuard() {
        const g = new THREE.Group();
        const body = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.5, 1.2, 16), new THREE.MeshStandardMaterial({color: 0x000000}));
        body.position.y = 0.6; g.add(body);
        g.position.set(45, 0.5, 55.5);
        outsideScene.add(g);
        this.outsideObjects.push({type:'guard', x:45, z:55.5, boundingRadius:3});
      }

      createFlowers(count) {
        for (let i = 0; i < count; i++) {
          const x = Math.random() * 160 - 80;
          const z = Math.random() * 160 - 80;
          const f = new THREE.Group();
          const stem = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 1, 8), new THREE.MeshStandardMaterial({color: 0x008000}));
          stem.position.y = 0.5; f.add(stem);
          const bloom = new THREE.Mesh(new THREE.SphereGeometry(0.25, 12, 12), new THREE.MeshStandardMaterial({color: 0xff1493}));
          bloom.position.y = 1; f.add(bloom);
          f.position.set(x, 0, z);
          outsideScene.add(f);
          this.outsideObjects.push({type:'flower', mesh:f, x, z});
        }
      }

      createTownFeatures() {
        this.createStatueFountain();
        this.createCastle(); this.createHouse(); this.createCafe(); this.createGuard();
        this.createBench(15, 10, 0); this.createBench(-15, 10, Math.PI);
        this.createBench(10, -15, 0); this.createBench(-10, -15, Math.PI);
        this.createBench(40, 30, Math.PI/2);
        this.createNPC(0xff0000, 20, 10); this.createNPC(0x00ff00, -20, 10);
        this.createNPC(0x0000ff, 10, -20); this.createNPC(0xffff00, -10, -20);
        this.createNPC(0xff00ff, 30, 0); this.createNPC(0x00ffff, 0, 30);
        this.createFlowers(30);
      }

      update() {
        this.updateDayNight();
        this.updateNPCs();
        this.updateFireflies();
        this.updateMovement();
        this.updateCamera();
        this.updatePickups();
        this.updateCollisions();
        this.updateQuest();
        this.updateBalls();
        this.updateHealthBar();
      }

      updateDayNight() {
        this.dayNightCounter = (this.dayNightCounter + 1) % 18000;
        this.time = this.dayNightCounter < 9000 ? "Day" : "Night";
        document.getElementById('time').textContent = this.time;
        outsideScene.background = new THREE.Color(this.time === "Day" ? 0x87CEEB : 0x000033);
        this.sunMesh.visible = this.time === "Day";
        this.moonMesh.visible = this.time === "Night";
        this.starsMesh.visible = this.time === "Night";
        this.fireflies.visible = this.time === "Night";
      }

      updateNPCs() {
        this.npcs.forEach(n => {
          n.angle += n.speed;
          n.object.position.x += Math.cos(n.angle) * 0.2;
          n.object.position.z += Math.sin(n.angle) * 0.2;
          n.object.rotation.y = n.angle + Math.PI / 2;
        });
      }

      updateFireflies() {
        if (this.fireflies && this.fireflies.visible) {
          const pos = this.fireflies.geometry.attributes.position.array;
          const t = Date.now() * 0.001;
          for (let i = 1; i < pos.length; i += 3) pos[i] += Math.sin(t + i) * 0.03;
          this.fireflies.geometry.attributes.position.needsUpdate = true;
        }
      }

      updateMovement() {
        let forward = 0, turn = 0;
        if (keysPressed['w'] || keysPressed['ArrowUp'] || dpad.up) forward += 1;
        if (keysPressed['s'] || keysPressed['ArrowDown'] || dpad.down) forward -= 1;
        if (keysPressed['a'] || keysPressed['ArrowLeft'] || dpad.left) turn += 1;
        if (keysPressed['d'] || keysPressed['ArrowRight'] || dpad.right) turn -= 1;

        const speed = 0.12;
        const dir = new THREE.Vector3(Math.sin(this.player.yaw), 0, Math.cos(this.player.yaw));
        const move = dir.multiplyScalar(forward * speed);
        this.player.x += move.x; this.player.z += move.z;
        this.player.yaw -= turn * 0.03;

        if (this.player.jumpVelocity) {
          this.player.jumpVelocity -= 0.02;
          this.player.y += this.player.jumpVelocity;
          if (this.player.y < 0.5) { this.player.y = 0.5; this.player.jumpVelocity = 0; }
        }

        const moving = Math.abs(forward) > 0.1;
        if (moving) this.player.bobTime += 0.15;
        this.player.object.position.y = this.player.y + (moving ? Math.sin(this.player.bobTime) * 0.05 : 0);
        this.player.object.position.x = this.player.x;
        this.player.object.position.z = this.player.z;
        this.player.object.rotation.y = this.player.yaw;

        this.player.object.traverse(c => {
          if (c.userData.arm) c.rotation.z = Math.sin(this.player.bobTime) * 0.6 * (c.position.x > 0 ? -1 : 1);
        });
      }

      updateCamera() {
        const offset = new THREE.Vector3(-Math.sin(this.player.yaw) * 18, 12, -Math.cos(this.player.yaw) * 18);
        camera.position.lerp(this.player.object.position.clone().add(offset), 0.1);
        camera.lookAt(this.player.object.position.x, this.player.object.position.y + 1.5, this.player.object.position.z);
      }

      updatePickups() {
        for (let i = this.outsideObjects.length - 1; i >= 0; i--) {
          const o = this.outsideObjects[i];
          if (o.type === 'flower') {
            const dx = this.player.x - o.x;
            const dz = this.player.z - o.z;
            if (dx * dx + dz * dz < 4) {
              this.flowers++;
              document.getElementById('flowers').textContent = this.flowers;
              document.getElementById('invFlowers').textContent = this.flowers;
              this.createSparkles(o.x, 1, o.z);
              outsideScene.remove(o.mesh);
              this.outsideObjects.splice(i, 1);
            }
          }
        }
      }

      createSparkles(x, y, z) {
        for (let i = 0; i < 15; i++) {
          const s = new THREE.Mesh(new THREE.SphereGeometry(0.1, 8, 8), new THREE.MeshBasicMaterial({color: 0xffff00}));
          s.position.set(x + (Math.random() - 0.5), y + Math.random(), z + (Math.random() - 0.5));
          s.userData = {vel: new THREE.Vector3((Math.random() - 0.5) * 0.1, 0.1 + Math.random() * 0.1, (Math.random() - 0.5) * 0.1), life: 60};
          outsideScene.add(s);
          this.thrownBalls.push(s);
        }
      }

      updateCollisions() {
        const dx = this.player.x - 45;
        const dz = this.player.z - 55.5;
        if (dx * dx + dz * dz < 25) {
          const popup = document.getElementById('guardPopup');
          popup.textContent = "Greetings, Princess Donia!";
          popup.style.display = 'block';
          setTimeout(() => popup.style.display = 'none', 2000);
        }
      }

      updateQuest() {
        if (!this.questActive && this.flowers >= 1) {
          this.showDialogue("A gentle spirit whispers: Please collect 10 flowers to restore the garden's magic!");
          this.questActive = true;
        }
        if (this.questActive && !this.questComplete && this.flowers >= 10) {
          this.showDialogue("Thank you, Princess! The garden blooms again.");
          this.questComplete = true;
        }
      }

      throwBall() {
        const dir = new THREE.Vector3(Math.sin(this.player.yaw), 0.3, Math.cos(this.player.yaw)).normalize().multiplyScalar(0.8);
        const ball = new THREE.Mesh(new THREE.SphereGeometry(0.3, 16, 16), new THREE.MeshStandardMaterial({color: 0xff4500, emissive: 0xff4500, emissiveIntensity: 2}));
        ball.position.copy(this.player.object.position);
        ball.position.y += 1;
        const light = new THREE.PointLight(0xff4500, 2, 15);
        ball.add(light);
        ball.userData = {velocity: dir, timer: 0};
        outsideScene.add(ball);
        this.thrownBalls.push(ball);
        this.ballCount++;
        document.getElementById('ballCountValue').textContent = this.ballCount;
        this.showDialogue("Magic Orb!");
      }

      jump() {
        if (this.player.y <= 0.51) {
          this.player.jumpVelocity = 0.35;
          this.showDialogue("♪ Jump! ♪");
        }
      }

      updateBalls() {
        for (let i = this.thrownBalls.length - 1; i >= 0; i--) {
          const b = this.thrownBalls[i];
          if (b.userData.velocity) {
            b.position.add(b.userData.velocity);
            b.userData.velocity.y -= 0.015;
            b.userData.timer++;
            if (b.userData.timer > 200 || b.position.y < 0) {
              outsideScene.remove(b);
              this.thrownBalls.splice(i, 1);
            }
          } else if (b.userData.life) {
            b.userData.life--;
            b.position.add(b.userData.vel);
            b.scale.multiplyScalar(0.95);
            if (b.userData.life <= 0) {
              outsideScene.remove(b);
              this.thrownBalls.splice(i, 1);
            }
          }
        }
      }

      updateHealthBar() {
        const fill = document.getElementById('healthFill');
        if (fill) {
          fill.style.width = this.health + '%';
          fill.style.background = this.health < 30 ? '#ff0000' : '#00ff00';
        }
      }

      showDialogue(text) {
        const dlg = document.getElementById('dialogue');
        if (dlg) {
          dlg.textContent = text;
          dlg.style.display = 'block';
          clearTimeout(this.dlgTimeout);
          this.dlgTimeout = setTimeout(() => dlg.style.display = 'none', 2500);
        }
      }

      startAnimation() {
        const animate = () => {
          requestAnimationFrame(animate);
          this.update();
          this.renderer.render(outsideScene, camera);
        };
        animate();
      }
    }
  </script>
</body>
</html>
