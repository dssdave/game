<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Princess Doniaâ€™s Town - Enhanced 3D RPG</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background: #000;
        font-family: Arial, sans-serif;
      }
      #gameContainer {
        position: relative;
        width: 100vw;
        height: 100vh;
      }
      canvas {
        display: block;
      }

      /* Default large UI style (desktop) */
      #ui,
      #ballCount,
      #dialogue,
      #controls,
      #errorMessage,
      #guardPopup {
        background: rgba(0,0,0,0.7);
        border: 4px solid #fff;
        border-radius: 5px;
        color: #fff;
        font-size: 28px; /* bigger text */
        padding: 40px 80px; /* more padding around text */
      }
      #ui,
      #ballCount,
      #dialogue,
      #controls {
        position: absolute;
        z-index: 10;
      }
      #ui {
        top: 10px;
        left: 10px;
      }
      #ballCount {
        top: 10px;
        right: 10px;
      }
      #dialogue {
        bottom: 10px;
        left: 10px;
        max-width: 600px;
      }
      #controls {
        bottom: 10px;
        right: 10px;
      }
      #errorMessage {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: none;
        z-index: 20;
      }
      #guardPopup {
        position: absolute;
        bottom: 50%;
        left: 50%;
        transform: translate(-50%,50%);
        display: none;
        z-index: 50;
        text-align: center;
      }

      /* Joystick containers: slightly higher & closer together */
      #joystickLeft,
      #joystickRight {
        position: absolute;
        width: 12vw;
        height: 12vw;
        min-width: 60px;
        min-height: 60px;
        max-width: 80px;
        max-height: 80px;
        opacity: 0.5;
        z-index: 15;
      }
      #joystickLeft {
        bottom: 14vh;
        left: 10vw;
      }
      #joystickRight {
        bottom: 14vh;
        right: 10vw;
      }

      /* Button to toggle UI */
      #toggleUIBtn {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 11;
        font-size: 24px;
        padding: 10px 20px;
        background: #333;
        color: #fff;
        border: 2px solid #fff;
        border-radius: 5px;
        cursor: pointer;
      }

      /* Smaller UI on narrow screens (mobile) via media query */
      @media (max-width: 768px) {
        #ui,
        #ballCount,
        #dialogue,
        #controls,
        #guardPopup,
        #errorMessage {
          font-size: 16px; /* smaller text on mobile */
          padding: 20px 30px; /* reduce padding */
        }
        #toggleUIBtn {
          font-size: 16px;
        }
      }
    </style>

    <!-- Include Three.js and NippleJS from CDNs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>
  </head>
  <body>
    <div id="gameContainer">
      <canvas id="gameCanvas"></canvas>

      <!-- Button to hide/show UI -->
      <button id="toggleUIBtn">Toggle UI</button>

      <div id="ui">
        Flowers: <span id="flowers">0</span> |
        Coins: <span id="coins">0</span> |
        Gems: <span id="gems">0</span> |
        Potions: <span id="potions">0</span> |
        Keys: <span id="keys">0</span> |
        Artifacts: <span id="artifacts">0</span> |
        Health: <span id="health">100</span> |
        Time: <span id="time">Day</span> |
        Location: <span id="location">Town</span>
      </div>

      <div id="ballCount">
        Balls Thrown: <span id="ballCountValue">0</span>
      </div>

      <div id="dialogue"></div>

      <div id="controls">
        Controls:<br>
        Joysticks/Arrow Keys: Move<br>
        Joysticks/Mouse: Look Around<br>
        Tap Center/Space: Throw Ball
      </div>

      <div id="joystickLeft"></div>
      <div id="joystickRight"></div>

      <div id="errorMessage">
        WebGL is not supported in your browser. Please use a modern browser.
      </div>

      <div id="guardPopup"></div>
    </div>

    <script>
      // Button logic to hide/show UI
      function toggleUI() {
        const uiIDs = ["ui","ballCount","dialogue","controls","guardPopup","errorMessage"];
        for (let id of uiIDs) {
          const elem = document.getElementById(id);
          if (!elem) continue;
          if (elem.style.display === "none") {
            elem.style.display = "block";
          } else {
            elem.style.display = "none";
          }
        }
      }
      document.getElementById('toggleUIBtn').addEventListener('click', toggleUI);

      try {
        const errorMessage = document.getElementById('errorMessage');
        const gameCanvas = document.getElementById('gameCanvas');
        if (!window.WebGLRenderingContext) {
          errorMessage.style.display = 'block';
          gameCanvas.style.display = 'none';
          throw new Error('WebGL not supported');
        }

        // Basic Three.js setup
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
        const renderer = new THREE.WebGLRenderer({ canvas: gameCanvas });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        gameCanvas.style.display = 'block';

        // We'll store references for NPC, mermaid, bird, etc.
        let npcBlueData = { angle: 0, speed: 0.001, radius: 120, object: null };
        let npcYellowData = { object: null, pathIndex: 0, speed: 0.03, target: null, boundingRadius:1 };
        let birdData = { angle: 0, speed: 0.002, radius: 140, object: null };

        class Game {
          constructor() {
            // Game state
            this.scene = 'town';
            this.flowers = 0;
            this.coins = 0;
            this.gems = 0;
            this.potions = 0;
            this.keys = 0;
            this.artifacts = 0;
            this.health = 100;
            this.time = 'Day';
            this.dayNightCycle = 0;

            this.player = {
              x: 0,
              z: 0,
              speedKeyboard: 0.1,
              speedJoystick: 0.05,
              yaw: 0,
              pitch: -0.2,
              object: null,
              lastMoveVec: new THREE.Vector3(1,0,0),
              waterSplashTimer: 0
            };

            this.dialogue = '';
            this.dialogueTimer = 0;
            this.objects = [];
            this.buildingPositions = [];
            this.ballCount = 0;
            this.thrownBalls = [];
            this.collectionGlow = null;
            this.joystickLeft = null;
            this.joystickRight = null;
            this.keysPressed = {};
            this.sceneObj = scene;
            this.camera = camera;
            this.renderer = renderer;
            this.itemRange = 80;

            // For day/night
            this.sunMesh = null;
            this.moonMesh = null;
            this.starsMesh = null;

            // Interactions
            this.guardObject = null;
            this.guardMessageShown = false;
            this.npcBlueMessageShown = false;
            this.mermaidMessageShown = false;
            this.npcYellowMessageShown = false;

            this.initScene();
            this.initJoysticks();
            this.initKeyboardMouse();
            this.startAnimation();
          }

          /*-----------------------------------------
            1) Scene creation
          -----------------------------------------*/
          initScene() {
            // Ground
            const groundGeo = new THREE.PlaneGeometry(300,300);
            const groundMat = new THREE.MeshStandardMaterial({ color: 0x6bb26b, side: THREE.DoubleSide });
            const ground = new THREE.Mesh(groundGeo, groundMat);
            ground.rotation.x = Math.PI/2;
            this.sceneObj.add(ground);

            // Sky
            const skyGeo = new THREE.SphereGeometry(1000,60,40);
            const skyMat = new THREE.ShaderMaterial({
              uniforms: {
                topColor: { value: new THREE.Color(0x87ceeb) },
                bottomColor: { value: new THREE.Color(0x2f4f4f) },
                offset: { value: 0.5 },
                exponent: { value: 0.6 }
              },
              vertexShader: `
                varying vec3 vWorldPosition;
                void main() {
                  vec4 worldPosition = modelMatrix * vec4(position, 1.0);
                  vWorldPosition = worldPosition.xyz;
                  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
              `,
              fragmentShader: `
                uniform vec3 topColor;
                uniform vec3 bottomColor;
                uniform float offset;
                uniform float exponent;
                varying vec3 vWorldPosition;
                void main() {
                  float h = normalize(vWorldPosition + vec3(0.0, offset, 0.0)).y;
                  gl_FragColor = vec4(
                    mix(bottomColor, topColor, max(pow(max(h, 0.0), exponent), 0.0)),
                    1.0
                  );
                }
              `,
              side: THREE.BackSide
            });
            const sky = new THREE.Mesh(skyGeo, skyMat);
            sky.name = 'sky';
            this.sceneObj.add(sky);

            // Lighting
            const ambient = new THREE.AmbientLight(0x404040, 0.6);
            this.sceneObj.add(ambient);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(10,20,10);
            this.sceneObj.add(dirLight);

            // Rolling hills
            this.createRollingHills();
            // Beach + water
            this.createBeach();
            // Characters
            this.createPlayerModel();
            this.createBlueNPC();
            this.createYellowNPC();
            this.createGuardAtCastle();
            this.createMermaid();
            this.createBird();  /* IMPORTANT: createBird() is defined below! */
            // Boundary
            this.createBoundary();
            // Buildings
            this.createCastle();
            this.createHouse();
            this.createFountain();
            this.createCafe();
            // Shrubs behind house
            this.addShrubsAndTreesBehindHouse();

            // Items
            this.createFlowers(10);
            this.createCoins(8);
            this.createGems(4);
            this.createPotions(3);
            this.createKeys(2);
            this.createArtifacts(2);

            // Day/Night
            this.createSun();
            this.createMoon();
            this.createStars();
          }

          createRollingHills() {
            // 100 hills, radius ~80..140, placed Â±(300..800)
            for(let i=0;i<100;i++){
              const r=80+Math.random()*60;
              const x=(Math.random()>0.5?1:-1)*(300+Math.random()*500);
              const z=(Math.random()>0.5?1:-1)*(300+Math.random()*500);
              const hillGeo=new THREE.SphereGeometry(r,16,16);
              const hillMat=new THREE.MeshStandardMaterial({ color:0x228b22, roughness:0.9 });
              const hill=new THREE.Mesh(hillGeo,hillMat);
              hill.position.set(x,-r/2,z);
              this.sceneObj.add(hill);
            }
          }

          createBeach() {
            // Beach plane
            const beachGeo = new THREE.PlaneGeometry(300,30);
            const beachMat = new THREE.MeshStandardMaterial({
              color: 0xD2B48C,
              polygonOffset:true,
              polygonOffsetFactor:-1,
              polygonOffsetUnits:1
            });
            const beach = new THREE.Mesh(beachGeo, beachMat);
            beach.rotation.x = -Math.PI/2;
            beach.position.set(0,0.01,-40);
            this.sceneObj.add(beach);
            this.objects.push({ mesh: beach, type:'beach', x:0, z:-40, boundingRadius:0 });

            // Water plane
            const waterGeo = new THREE.PlaneGeometry(300,30);
            const waterMat = new THREE.MeshStandardMaterial({
              color: 0x1E90FF,
              transparent:true,
              opacity:0.8,
              polygonOffset:true,
              polygonOffsetFactor:-2,
              polygonOffsetUnits:1
            });
            const water = new THREE.Mesh(waterGeo, waterMat);
            water.rotation.x = -Math.PI/2;
            water.position.set(0,0.02,-70);
            this.sceneObj.add(water);
            this.objects.push({ mesh: water, type:'water', x:0, z:-70, boundingRadius:0 });
          }

          /*-----------------------------------------
            2) Character creation
          -----------------------------------------*/
          createPlayerModel() {
            const group=new THREE.Group();
            // Body
            const body=new THREE.Mesh(
              new THREE.CylinderGeometry(0.4,0.5,1.2,16),
              new THREE.MeshStandardMaterial({ color:0xff69b4 })
            );
            body.position.set(0,0.6,0);
            body.userData.isBodyPart=true;
            group.add(body);

            // Head
            const head=new THREE.Mesh(
              new THREE.SphereGeometry(0.3,16,16),
              new THREE.MeshStandardMaterial({ color:0xffddc1 })
            );
            head.position.set(0,1.4,0);
            head.userData.isBodyPart=true;
            group.add(head);

            // Hair on top
            const hair=new THREE.Mesh(
              new THREE.SphereGeometry(0.4,16,16),
              new THREE.MeshStandardMaterial({ color:0x4b2e05 })
            );
            hair.position.set(0,1.75,0);
            group.add(hair);

            // Crown
            const crown=new THREE.Mesh(
              new THREE.TorusGeometry(0.25,0.09,8,16),
              new THREE.MeshStandardMaterial({ color:0xffd700 })
            );
            crown.rotation.x=Math.PI/2;
            crown.position.set(0,1.95,0);
            group.add(crown);

            // Arms
            const armGeo=new THREE.CylinderGeometry(0.1,0.1,0.8,8);
            const skinMat=new THREE.MeshStandardMaterial({ color:0xffddc1 });
            const leftArm=new THREE.Mesh(armGeo,skinMat);
            leftArm.position.set(-0.5,1.0,0);
            leftArm.userData.isBodyPart=true;
            group.add(leftArm);
            const rightArm=new THREE.Mesh(armGeo,skinMat);
            rightArm.position.set(0.5,1.0,0);
            rightArm.userData.isBodyPart=true;
            group.add(rightArm);

            // Legs
            const legGeo=new THREE.CylinderGeometry(0.12,0.12,0.8,8);
            const leftLeg=new THREE.Mesh(legGeo,skinMat);
            leftLeg.position.set(-0.2,0.2,0);
            leftLeg.userData.isBodyPart=true;
            group.add(leftLeg);
            const rightLeg=new THREE.Mesh(legGeo,skinMat);
            rightLeg.position.set(0.2,0.2,0);
            rightLeg.userData.isBodyPart=true;
            group.add(rightLeg);

            group.position.set(0,0.5,0);
            this.player.object=group;
            this.sceneObj.add(group);
          }

          createBlueNPC() {
            const group=new THREE.Group();
            // Body
            const body=new THREE.Mesh(
              new THREE.CylinderGeometry(0.4,0.5,1.2,16),
              new THREE.MeshStandardMaterial({ color:0x0000ff })
            );
            body.position.set(0,0.6,0);
            group.add(body);

            // Head
            const head=new THREE.Mesh(
              new THREE.SphereGeometry(0.3,16,16),
              new THREE.MeshStandardMaterial({ color:0xffddc1 })
            );
            head.position.set(0,1.4,0);
            group.add(head);

            // Hair on top
            const hair=new THREE.Mesh(
              new THREE.SphereGeometry(0.4,16,16),
              new THREE.MeshStandardMaterial({ color:0x4b2e05 })
            );
            hair.position.set(0,1.75,0);
            group.add(hair);

            // Arms
            const armGeo=new THREE.CylinderGeometry(0.1,0.1,0.8,8);
            const skinMat=new THREE.MeshStandardMaterial({ color:0xffddc1 });
            const leftArm=new THREE.Mesh(armGeo,skinMat);
            leftArm.position.set(-0.5,1.0,0);
            group.add(leftArm);
            const rightArm=new THREE.Mesh(armGeo,skinMat);
            rightArm.position.set(0.5,1.0,0);
            group.add(rightArm);

            // Legs
            const legGeo=new THREE.CylinderGeometry(0.12,0.12,0.8,8);
            const leftLeg=new THREE.Mesh(legGeo,skinMat);
            leftLeg.position.set(-0.2,0.2,0);
            group.add(leftLeg);
            const rightLeg=new THREE.Mesh(legGeo,skinMat);
            rightLeg.position.set(0.2,0.2,0);
            group.add(rightLeg);

            group.position.set(120,0.5,0);
            this.sceneObj.add(group);
            this.objects.push({ mesh:group, type:'npc', x:120, z:0, boundingRadius:1 });
            npcBlueData.object=group;
          }

          createYellowNPC() {
            const group=new THREE.Group();
            // Body (shorter)
            const body=new THREE.Mesh(
              new THREE.CylinderGeometry(0.4,0.5,1.0,16),
              new THREE.MeshStandardMaterial({ color:0xffff00 })
            );
            body.position.set(0,0.5,0);
            group.add(body);

            // Head
            const head=new THREE.Mesh(
              new THREE.SphereGeometry(0.3,16,16),
              new THREE.MeshStandardMaterial({ color:0xffddc1 })
            );
            head.position.set(0,1.1,0);
            group.add(head);

            // Hair on top
            const hair=new THREE.Mesh(
              new THREE.SphereGeometry(0.4,16,16),
              new THREE.MeshStandardMaterial({ color:0x4b2e05 })
            );
            hair.position.set(0,1.45,0);
            group.add(hair);

            // Arms
            const armGeo=new THREE.CylinderGeometry(0.1,0.1,0.6,8);
            const skinMat=new THREE.MeshStandardMaterial({ color:0xffddc1 });
            const leftArm=new THREE.Mesh(armGeo,skinMat);
            leftArm.position.set(-0.5,0.8,0);
            group.add(leftArm);
            const rightArm=new THREE.Mesh(armGeo,skinMat);
            rightArm.position.set(0.5,0.8,0);
            group.add(rightArm);

            // Legs
            const legGeo=new THREE.CylinderGeometry(0.12,0.12,0.6,8);
            const leftLeg=new THREE.Mesh(legGeo,skinMat);
            leftLeg.position.set(-0.2,0,0);
            group.add(leftLeg);
            const rightLeg=new THREE.Mesh(legGeo,skinMat);
            rightLeg.position.set(0.2,0,0);
            group.add(rightLeg);

            group.position.set(-30,0.3,30);
            this.sceneObj.add(group);
            this.objects.push({ mesh:group, type:'npc', x:-30, z:30, boundingRadius:1 });
            npcYellowData.object=group;
          }

          createGuardAtCastle() {
            const group=new THREE.Group();
            const body=new THREE.Mesh(
              new THREE.CylinderGeometry(0.4,0.5,1.2,16),
              new THREE.MeshStandardMaterial({ color:0x000000 })
            );
            body.position.set(0,0.6,0);
            group.add(body);

            const head=new THREE.Mesh(
              new THREE.SphereGeometry(0.3,16,16),
              new THREE.MeshStandardMaterial({ color:0xffddc1 })
            );
            head.position.set(0,1.4,0);
            group.add(head);

            // Hair on top
            const hair=new THREE.Mesh(
              new THREE.SphereGeometry(0.4,16,16),
              new THREE.MeshStandardMaterial({ color:0x4b2e05 })
            );
            hair.position.set(0,1.75,0);
            group.add(hair);

            const armGeo=new THREE.CylinderGeometry(0.1,0.1,0.8,8);
            const skinMat=new THREE.MeshStandardMaterial({ color:0xffddc1 });
            const leftArm=new THREE.Mesh(armGeo,skinMat);
            leftArm.position.set(-0.5,1.0,0);
            group.add(leftArm);
            const rightArm=new THREE.Mesh(armGeo,skinMat);
            rightArm.position.set(0.5,1.0,0);
            group.add(rightArm);

            const legGeo=new THREE.CylinderGeometry(0.12,0.12,0.8,8);
            const leftLeg=new THREE.Mesh(legGeo,skinMat);
            leftLeg.position.set(-0.2,0.2,0);
            group.add(leftLeg);
            const rightLeg=new THREE.Mesh(legGeo,skinMat);
            rightLeg.position.set(0.2,0.2,0);
            group.add(rightLeg);

            group.position.set(45,0.5,50.5);
            this.sceneObj.add(group);
            this.objects.push({ mesh:group, type:'guard', x:45, z:50.5, boundingRadius:3 });
            this.guardObject=group;
          }

          createMermaid() {
            const group=new THREE.Group();
            // Body
            const body=new THREE.Mesh(
              new THREE.CylinderGeometry(0.4,0.5,0.6,16),
              new THREE.MeshStandardMaterial({ color:0xff69b4 })
            );
            body.position.set(0,0.9,0);
            group.add(body);

            // Head
            const head=new THREE.Mesh(
              new THREE.SphereGeometry(0.3,16,16),
              new THREE.MeshStandardMaterial({ color:0xffddc1 })
            );
            head.position.set(0,1.4,0);
            group.add(head);

            // Hair on top
            const hair=new THREE.Mesh(
              new THREE.SphereGeometry(0.4,16,16),
              new THREE.MeshStandardMaterial({ color:0x4b2e05 })
            );
            hair.position.set(0,1.8,0); // higher
            group.add(hair);

            // Arms
            const armGeo=new THREE.CylinderGeometry(0.1,0.1,0.6,8);
            const skinMat=new THREE.MeshStandardMaterial({ color:0xffddc1 });
            const leftArm=new THREE.Mesh(armGeo,skinMat);
            leftArm.position.set(-0.5,1.1,0);
            group.add(leftArm);
            const rightArm=new THREE.Mesh(armGeo,skinMat);
            rightArm.position.set(0.5,1.1,0);
            group.add(rightArm);

            // Submerged
            group.position.set(20,-0.5,-70);
            this.sceneObj.add(group);
            this.objects.push({ mesh:group, type:'mermaid', x:20, z:-70, boundingRadius:3 });
          }

          /* The missing createBird() function! */
          createBird() {
            const bird = new THREE.Mesh(
              new THREE.SphereGeometry(0.5,8,8),
              new THREE.MeshStandardMaterial({ color: 0xffffff })
            );
            bird.position.set(0,30,0);
            this.sceneObj.add(bird);
            birdData.object = bird;
          }

          /*-----------------------------------------
            3) Boundary
          -----------------------------------------*/
          createBoundary() {
            for(let x=-130;x<=130;x+=4){
              this.addShrub(x,-130);
              this.addShrub(x,130);
            }
            for(let z=-130;z<=130;z+=4){
              this.addShrub(-130,z);
              this.addShrub(130,z);
            }
          }
          addShrub(x,z){
            const geo=new THREE.CylinderGeometry(1,1,2,8);
            const mat=new THREE.MeshStandardMaterial({ color:0x228b22 });
            const shrub=new THREE.Mesh(geo,mat);
            shrub.position.set(x,1,z);
            this.sceneObj.add(shrub);
            this.objects.push({ mesh:shrub, type:'boundary', x, z, boundingRadius:2 });
          }

          /*-----------------------------------------
            4) Buildings
          -----------------------------------------*/
          createCastle() {
            const group=new THREE.Group();
            const keep=new THREE.Mesh(
              new THREE.BoxGeometry(20,10,20),
              new THREE.MeshStandardMaterial({ color:0xcccccc })
            );
            keep.position.set(0,5,0);
            group.add(keep);

            const towerGeo=new THREE.CylinderGeometry(3,3,15,16);
            const towerMat=new THREE.MeshStandardMaterial({ color:0xcccccc });
            [[10,7.5,10],[-10,7.5,10],[10,7.5,-10],[-10,7.5,-10]].forEach(pos=>{
              const tower=new THREE.Mesh(towerGeo,towerMat);
              tower.position.set(pos[0],pos[1],pos[2]);
              group.add(tower);
            });

            const door=new THREE.Mesh(
              new THREE.PlaneGeometry(4,6),
              new THREE.MeshStandardMaterial({ color:0x553300, side:THREE.DoubleSide })
            );
            door.position.set(0,3,10.01);
            group.add(door);

            // "Daddy's Castle" sign
            const canvas=document.createElement('canvas');
            canvas.width=512; canvas.height=128;
            const ctx=canvas.getContext('2d');
            ctx.fillStyle='black'; ctx.fillRect(0,0,512,128);
            ctx.fillStyle='white'; ctx.font='60px Arial';
            ctx.fillText("Daddy's Castle",50,80);
            const tex=new THREE.Texture(canvas);
            tex.needsUpdate=true;
            const signMat=new THREE.MeshBasicMaterial({ map:tex });
            const signGeo=new THREE.PlaneGeometry(12,3);
            const signMesh=new THREE.Mesh(signGeo,signMat);
            signMesh.position.set(0,8,10.1);
            group.add(signMesh);

            group.position.set(40,0,40);
            this.sceneObj.add(group);
            this.objects.push({ mesh:group, type:'building', x:40, z:40, boundingRadius:15 });
            this.buildingPositions.push({ x:40, z:40 });
          }

          createHouse() {
            const group=new THREE.Group();
            const base=new THREE.Mesh(
              new THREE.BoxGeometry(10,6,8),
              new THREE.MeshStandardMaterial({ color:0x8b4513 })
            );
            base.position.set(0,3,0);
            group.add(base);

            // Roof at y=6 + half(4)=8
            const roof=new THREE.Mesh(
              new THREE.ConeGeometry(6,4,4),
              new THREE.MeshStandardMaterial({ color:0x800000 })
            );
            roof.position.set(0,6+2,0);
            roof.rotation.y=Math.PI/4;
            group.add(roof);

            const door=new THREE.Mesh(
              new THREE.PlaneGeometry(2,4),
              new THREE.MeshStandardMaterial({ color:0x553300, side:THREE.DoubleSide })
            );
            door.position.set(0,2,4.01);
            group.add(door);

            // Windows
            const winGeo=new THREE.PlaneGeometry(1,1);
            const winMat=new THREE.MeshStandardMaterial({ color:0x87ceeb, transparent:true, opacity:0.5, side:THREE.DoubleSide });
            const w1=new THREE.Mesh(winGeo,winMat);
            w1.position.set(-2,3,4.02);
            const w2=new THREE.Mesh(winGeo,winMat.clone());
            w2.position.set(2,3,4.02);
            group.add(w1,w2);

            // House sign at y=5
            const canvas=document.createElement('canvas');
            canvas.width=128; canvas.height=32;
            const ctx=canvas.getContext('2d');
            ctx.fillStyle='black'; ctx.fillRect(0,0,128,32);
            ctx.fillStyle='white'; ctx.font='16px Arial';
            ctx.fillText("Donia's House",5,22);
            const tex=new THREE.Texture(canvas);
            tex.needsUpdate=true;
            const signMat=new THREE.MeshBasicMaterial({ map:tex, transparent:true });
            const signGeo=new THREE.PlaneGeometry(4,1);
            const signMesh=new THREE.Mesh(signGeo,signMat);
            signMesh.position.set(0,5,4.05);
            group.add(signMesh);

            group.position.set(-40,0,-40);
            this.sceneObj.add(group);
            this.objects.push({ mesh:group, type:'building', x:-40, z:-40, boundingRadius:10 });
            this.buildingPositions.push({ x:-40, z:-40 });
          }

          createFountain() {
            const group=new THREE.Group();
            const base=new THREE.Mesh(
              new THREE.CylinderGeometry(3,3,1,16),
              new THREE.MeshStandardMaterial({ color:0x808080 })
            );
            base.position.set(0,0.5,0);
            group.add(base);

            const bowl=new THREE.Mesh(
              new THREE.TorusGeometry(3,0.3,16,32),
              new THREE.MeshStandardMaterial({ color:0x808080 })
            );
            bowl.rotation.x=Math.PI/2;
            bowl.position.y=1;
            group.add(bowl);

            const water=new THREE.Mesh(
              new THREE.CylinderGeometry(2.8,2.8,0.2,16),
              new THREE.MeshStandardMaterial({ color:0x00ffff, transparent:true, opacity:0.6 })
            );
            water.position.set(0,1.1,0);
            group.add(water);

            group.position.set(0,0,20);
            this.sceneObj.add(group);
            this.objects.push({ mesh:group, type:'decoration', x:0, z:20, boundingRadius:5 });
          }

          createCafe() {
            const group=new THREE.Group();
            const base=new THREE.Mesh(
              new THREE.BoxGeometry(10,5,8),
              new THREE.MeshStandardMaterial({ color:0x888888 })
            );
            base.position.set(0,2.5,0);
            group.add(base);

            const door=new THREE.Mesh(
              new THREE.PlaneGeometry(2,3),
              new THREE.MeshStandardMaterial({ color:0x553300, side:THREE.DoubleSide })
            );
            door.position.set(0,1.5,4.01);
            group.add(door);

            const canvas=document.createElement('canvas');
            canvas.width=256; canvas.height=64;
            const ctx=canvas.getContext('2d');
            ctx.fillStyle='black'; ctx.fillRect(0,0,256,64);
            ctx.fillStyle='white'; ctx.font='30px Arial'; ctx.textAlign='center';
            ctx.fillText("Donia's Cafe",128,40);
            const tex=new THREE.Texture(canvas);
            tex.needsUpdate=true;
            const signMat=new THREE.MeshBasicMaterial({ map:tex, transparent:true });
            const signGeo=new THREE.PlaneGeometry(8,2);
            const signMesh=new THREE.Mesh(signGeo,signMat);
            signMesh.position.set(0,3.5,4.05);
            group.add(signMesh);

            group.position.set(70,0,-30);
            this.sceneObj.add(group);
            this.objects.push({ mesh:group, type:'building', x:70, z:-30, boundingRadius:10 });
            this.buildingPositions.push({ x:70, z:-30 });
          }

          addShrubsAndTreesBehindHouse(){
            const baseX=-40, baseZ=-40;
            for(let i=0;i<10;i++){
              const offsetX=(Math.random()*14)-7;
              const offsetZ=(Math.random()*10)+6;
              const x=baseX+offsetX;
              const z=baseZ-offsetZ;
              const isTree=Math.random()<0.5;
              if(isTree){
                const trunk=new THREE.Mesh(
                  new THREE.CylinderGeometry(0.2,0.2,2,8),
                  new THREE.MeshStandardMaterial({ color:0x8b4513 })
                );
                trunk.position.set(x,1,z);
                const leaves=new THREE.Mesh(
                  new THREE.SphereGeometry(1,8,8),
                  new THREE.MeshStandardMaterial({ color:0x228b22 })
                );
                leaves.position.set(x,3,z);
                this.sceneObj.add(trunk, leaves);
                this.objects.push({ mesh:trunk, type:'decoration', x, z, boundingRadius:2 });
              } else {
                const shrub=new THREE.Mesh(
                  new THREE.SphereGeometry(1,8,8),
                  new THREE.MeshStandardMaterial({ color:0x228b22 })
                );
                shrub.position.set(x,1,z);
                this.sceneObj.add(shrub);
                this.objects.push({ mesh:shrub, type:'decoration', x, z, boundingRadius:2 });
              }
            }
          }

          /*-----------------------------------------
            5) Items
          -----------------------------------------*/
          createFlowers(count){ /* ... */ }
          createCoins(count){ /* ... */ }
          createGems(count){ /* ... */ }
          createPotions(count){ /* ... */ }
          createKeys(count){ /* ... */ }
          createArtifacts(count){ /* ... */ }

          /*-----------------------------------------
            6) Sun, Moon, Stars
          -----------------------------------------*/
          createSun(){ /* ... */ }
          createMoon(){ /* ... */ }
          createStars(){ /* ... */ }

          /*-----------------------------------------
            7) Animation & Update
          -----------------------------------------*/
          startAnimation(){ /* ... */ }
          update(){ /* ... */ }
          updateDayNight(){ /* ... */ }
          updateBalls(){ /* ... */ }
          spawnRipple(x,z){ /* ... */ }
          updatePlayer(){ /* ... */ }

          /* NPC updates */
          updateBlueNPC(){ /* ... */ }
          updateYellowNPC(){ /* ... */ }
          getRandomBuildingTarget(){ /* ... */ }
          updateBird(){ /* ... */ }
          updateCollisions(){ /* ... */ }
          updateCamera(){ /* ... */ }
          updatePickups(){ /* ... */ }

          /*-----------------------------------------
            8) Utility
          -----------------------------------------*/
          showDialogue(text){ /* ... */ }
          showGuardPopup(text){ /* ... */ }
          throwBall(){ /* ... */ }
          startCollectionGlow(){ /* ... */ }

          initJoysticks(){ /* ... */ }
          initKeyboardMouse(){ /* ... */ }
        }

        // Finally, create the game
        const game = new Game();
      } catch(error){
        console.error('Error initializing the game:',error);
      }
    </script>
  </body>
</html>
