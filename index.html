<!DOCTYPE html>
<html>
<head>
    <title>Enhanced 3D Princess RPG</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            background: #000;
        }
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        canvas {
            display: block;
        }
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #fff;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 10;
        }
        #dialogue {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: #fff;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            max-width: 600px;
            z-index: 10;
        }
        #errorMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 5px;
            z-index: 20;
            display: none;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 18px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 5px;
            z-index: 20;
        }
    </style>
    <!-- Include Three.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="ui">
            Flowers: <span id="flowers">0</span> | 
            Coins: <span id="coins">0</span> | 
            Gems: <span id="gems">0</span> | 
            Potions: <span id="potions">0</span> | 
            Keys: <span id="keys">0</span> | 
            Artifacts: <span id="artifacts">0</span> | 
            Health: <span id="health">100</span> | 
            Mana: <span id="mana">50</span> | 
            Time: <span id="time">Day</span> | 
            Location: <span id="location">Town</span>
        </div>
        <div id="dialogue"></div>
        <div id="errorMessage">WebGL is not supported in your browser. Please use a modern browser like Chrome, Firefox, or Edge.</div>
        <div id="loading">Loading game... Please wait.</div>
    </div>

    <script>
        // Error handling for WebGL
        try {
            if (!window.WebGLRenderingContext) {
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('gameCanvas').style.display = 'none';
                document.getElementById('ui').style.display = 'none';
                document.getElementById('dialogue').style.display = 'none';
                throw new Error('WebGL not supported');
            }

            // Scene setup
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('gameCanvas') });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('loading').style.display = 'none';

            // Game state
            let game;

            class Game {
                constructor() {
                    this.scene = 'town';
                    this.flowers = 0;
                    this.coins = 0;
                    this.gems = 0;
                    this.potions = 0;
                    this.keys = 0;
                    this.artifacts = 0;
                    this.health = 100;
                    this.mana = 50;
                    this.time = 'Day';
                    this.dayNightCycle = 0;
                    this.player = {
                        x: 0,
                        z: 0,
                        speed: 0.5,
                        yaw: 0,
                        pitch: 0,
                        object: null
                    };
                    this.dialogue = '';
                    this.dialogueTimer = 0;
                    this.objects = []; // Properly initialize objects array
                    this.npcs = [];
                    this.quests = {
                        townGuard: { active: false, completed: false },
                        castleKing: { active: false, completed: false },
                        villager: { active: false, completed: false }
                    };
                    this.initScene();
                }
                showDialogue(text) {
                    this.dialogue = text;
                    this.dialogueTimer = 120; // Display for 2 seconds (60 FPS)
                }
                updateDayNight() {
                    this.dayNightCycle = (this.dayNightCycle + 1) % 1200; // 20-second cycle (60 FPS)
                    this.time = this.dayNightCycle < 600 ? 'Day' : 'Night';
                }
                initScene() {
                    // Ground (detailed terrain with grass texture)
                    const groundGeometry = new THREE.PlaneGeometry(100, 100, 50, 50);
                    const groundMaterial = new THREE.MeshStandardMaterial({ 
                        color: 0x6bb26b, 
                        side: THREE.DoubleSide,
                        roughness: 0.8,
                        metalness: 0.1 
                    });
                    const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                    ground.rotation.x = Math.PI / 2;
                    ground.castShadow = true;
                    ground.receiveShadow = true;
                    scene.add(ground);

                    // Skybox (day/night effect with gradient)
                    const skyGeometry = new THREE.SphereGeometry(500, 60, 40);
                    const skyMaterial = new THREE.ShaderMaterial({
                        uniforms: {
                            topColor: { value: new THREE.Color(0x87ceeb) },
                            bottomColor: { value: new THREE.Color(0x2f4f4f) },
                            offset: { value: 0.5 },
                            exponent: { value: 0.6 }
                        },
                        vertexShader: `
                            varying vec3 vWorldPosition;
                            void main() {
                                vec4 worldPosition = modelMatrix * vec4(position, 1.0);
                                vWorldPosition = worldPosition.xyz;
                                gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                            }
                        `,
                        fragmentShader: `
                            uniform vec3 topColor;
                            uniform vec3 bottomColor;
                            uniform float offset;
                            uniform float exponent;
                            varying vec3 vWorldPosition;
                            void main() {
                                float h = normalize(vWorldPosition + offset).y;
                                gl_FragColor = vec4(mix(bottomColor, topColor, max(pow(max(h, 0.0), exponent), 0.0)), 1.0);
                            }
                        `,
                        side: THREE.BackSide
                    });
                    const sky = new THREE.Mesh(skyGeometry, skyMaterial);
                    sky.material.uniforms.topColor.value.set(this.time === 'Day' ? 0x87ceeb : 0x2f4f4f);
                    sky.material.uniforms.bottomColor.value.set(this.time === 'Day' ? 0x87ceeb : 0x2f4f4f);
                    sky.name = 'sky';
                    scene.add(sky);

                    // Princess (detailed model with dress, crown, and face)
                    const princessBodyGeometry = new THREE.CylinderGeometry(0.5, 0.5, 1.5, 32);
                    const princessBodyMaterial = new THREE.MeshStandardMaterial({ color: 0xff69b4, metalness: 0.1, roughness: 0.5 }); // Pink dress
                    const princessBody = new THREE.Mesh(princessBodyGeometry, princessBodyMaterial);
                    princessBody.position.y = 0.75;
                    princessBody.castShadow = true;

                    const princessHeadGeometry = new THREE.SphereGeometry(0.4, 32, 32);
                    const princessHeadMaterial = new THREE.MeshStandardMaterial({ color: 0xffe4c4, metalness: 0.1, roughness: 0.5 }); // Skin tone
                    const princessHead = new THREE.Mesh(princessHeadGeometry, princessHeadMaterial);
                    princessHead.position.y = 1.65;
                    princessHead.castShadow = true;

                    const crownGeometry = new THREE.TorusGeometry(0.45, 0.05, 16, 32);
                    const crownMaterial = new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 0.9, roughness: 0.2 }); // Gold crown
                    const crown = new THREE.Mesh(crownGeometry, crownMaterial);
                    crown.position.y = 2.05;
                    crown.rotation.x = Math.PI / 2;
                    crown.castShadow = true;

                    const princessGroup = new THREE.Group();
                    princessGroup.add(princessBody, princessHead, crown);
                    princessGroup.position.set(this.player.x, 1, this.player.z);
                    this.player.object = princessGroup;
                    scene.add(princessGroup);

                    // Lighting (advanced setup with soft shadows)
                    const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
                    scene.add(ambientLight);
                    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    directionalLight.position.set(10, 20, 10);
                    directionalLight.castShadow = true;
                    directionalLight.shadow.mapSize.width = 4096;
                    directionalLight.shadow.mapSize.height = 4096;
                    directionalLight.shadow.camera.near = 0.5;
                    directionalLight.shadow.camera.far = 100;
                    directionalLight.shadow.camera.left = -50;
                    directionalLight.shadow.camera.right = 50;
                    directionalLight.shadow.camera.top = 50;
                    directionalLight.shadow.camera.bottom = -50;
                    scene.add(directionalLight);

                    // Castle (majestic, multi-towered structure)
                    const castleBaseGeometry = new THREE.BoxGeometry(20, 10, 20);
                    const castleBaseMaterial = new THREE.MeshStandardMaterial({ color: 0x808080, metalness: 0.3, roughness: 0.6 });
                    const castleBase = new THREE.Mesh(castleBaseGeometry, castleBaseMaterial);
                    castleBase.position.set(40, 5, 40);
                    castleBase.castShadow = true;
                    castleBase.receiveShadow = true;

                    const castleTowerGeometry = new THREE.CylinderGeometry(3, 3, 15, 32);
                    const castleTowerMaterial = new THREE.MeshStandardMaterial({ color: 0x808080, metalness: 0.3, roughness: 0.6 });
                    const tower1 = new THREE.Mesh(castleTowerGeometry, castleTowerMaterial);
                    tower1.position.set(40, 12.5, 40);
                    tower1.castShadow = true;
                    tower1.receiveShadow = true;

                    const tower2 = new THREE.Mesh(castleTowerGeometry, castleTowerMaterial.clone());
                    tower2.position.set(50, 12.5, 40);
                    tower2.castShadow = true;
                    tower2.receiveShadow = true;

                    const tower3 = new THREE.Mesh(castleTowerGeometry, castleTowerMaterial.clone());
                    tower3.position.set(30, 12.5, 40);
                    tower3.castShadow = true;
                    tower3.receiveShadow = true;

                    const castleGroup = new THREE.Group();
                    castleGroup.add(castleBase, tower1, tower2, tower3);
                    this.objects.push({ mesh: castleGroup, type: 'building', x: 40, z: 40 });

                    // House (cozy, detailed structure with roof)
                    const houseBaseGeometry = new THREE.BoxGeometry(6, 6, 6);
                    const houseBaseMaterial = new THREE.MeshStandardMaterial({ color: 0x8b4513, metalness: 0.2, roughness: 0.7 }); // Wood brown
                    const houseBase = new THREE.Mesh(houseBaseGeometry, houseBaseMaterial);
                    houseBase.position.set(-40, 3, -40);
                    houseBase.castShadow = true;
                    houseBase.receiveShadow = true;

                    const houseRoofGeometry = new THREE.ConeGeometry(4, 4, 32);
                    const houseRoofMaterial = new THREE.MeshStandardMaterial({ color: 0x800000, metalness: 0.2, roughness: 0.7 }); // Red roof
                    const houseRoof = new THREE.Mesh(houseRoofGeometry, houseRoofMaterial);
                    houseRoof.position.set(-40, 7, -40);
                    houseRoof.castShadow = true;
                    houseRoof.receiveShadow = true;

                    const houseGroup = new THREE.Group();
                    houseGroup.add(houseBase, houseRoof);
                    this.objects.push({ mesh: houseGroup, type: 'building', x: -40, z: -40 });

                    // Castle door (ornate golden door)
                    const doorGeometry = new THREE.PlaneGeometry(2, 4);
                    const doorMaterial = new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 0.9, roughness: 0.2, side: THREE.DoubleSide }); // Gold
                    const castleDoor = new THREE.Mesh(doorGeometry, doorMaterial);
                    castleDoor.position.set(35, 2, 40); // Front-left of castle
                    castleDoor.rotation.y = Math.PI / 2;
                    this.objects.push({ mesh: castleDoor, type: 'door', x: 35, z: 40, building: 'castle' });

                    // House door (wooden door)
                    const houseDoor = new THREE.Mesh(doorGeometry, new THREE.MeshStandardMaterial({ color: 0x8b4513, metalness: 0.2, roughness: 0.7, side: THREE.DoubleSide }));
                    houseDoor.position.set(-42, 2, -40); // Front-left of house
                    houseDoor.rotation.y = Math.PI / 2;
                    this.objects.push({ mesh: houseDoor, type: 'door', x: -42, z: -40, building: 'house' });

                    // Flowers (detailed blossoms)
                    const flowerStemGeometry = new THREE.CylinderGeometry(0.1, 0.1, 0.5, 8);
                    const flowerStemMaterial = new THREE.MeshStandardMaterial({ color: 0x228b22, metalness: 0.1, roughness: 0.8 });
                    const flowerPetalsGeometry = new THREE.TorusGeometry(0.3, 0.1, 16, 32);
                    const flowerPetalsMaterial = new THREE.MeshStandardMaterial({ color: 0xff00ff, metalness: 0.1, roughness: 0.8 });

                    const flower1Group = new THREE.Group();
                    const stem1 = new THREE.Mesh(flowerStemGeometry, flowerStemMaterial);
                    stem1.position.y = 0.25;
                    const petals1 = new THREE.Mesh(flowerPetalsGeometry, flowerPetalsMaterial);
                    petals1.position.y = 0.75;
                    petals1.rotation.x = Math.PI / 2;
                    flower1Group.add(stem1, petals1);
                    flower1Group.position.set(10, 0, 10);
                    flower1Group.castShadow = true;
                    this.objects.push({ mesh: flower1Group, type: 'flower', x: 10, z: 10 });

                    const flower2Group = new THREE.Group();
                    const stem2 = new THREE.Mesh(flowerStemGeometry, flowerStemMaterial);
                    stem2.position.y = 0.25;
                    const petals2 = new THREE.Mesh(flowerPetalsGeometry, flowerPetalsMaterial);
                    petals2.position.y = 0.75;
                    petals2.rotation.x = Math.PI / 2;
                    flower2Group.add(stem2, petals2);
                    flower2Group.position.set(-10, 0, 0);
                    flower2Group.castShadow = true;
                    this.objects.push({ mesh: flower2Group, type: 'flower', x: -10, z: 0 });

                    // Coins (shiny gold coins)
                    const coinGeometry = new THREE.CircleGeometry(0.5, 32);
                    const coinMaterial = new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 0.9, roughness: 0.2 });
                    const coin1 = new THREE.Mesh(coinGeometry, coinMaterial);
                    coin1.position.set(0, 0.5, 10);
                    coin1.rotation.x = Math.PI / 2;
                    coin1.castShadow = true;
                    this.objects.push({ mesh: coin1, type: 'coin', x: 0, z: 10 });

                    const coin2 = new THREE.Mesh(coinGeometry, coinMaterial.clone());
                    coin2.position.set(10, 0.5, -10);
                    coin2.rotation.x = Math.PI / 2;
                    coin2.castShadow = true;
                    this.objects.push({ mesh: coin2, type: 'coin', x: 10, z: -10 });

                    // Gems (prismatic crystals)
                    const gemGeometry = new THREE.OctahedronGeometry(0.5, 0);
                    const gemMaterial = new THREE.MeshStandardMaterial({ color: 0x00ffff, metalness: 0.5, roughness: 0.5 });
                    const gem = new THREE.Mesh(gemGeometry, gemMaterial);
                    gem.position.set(-10, 0.5, 10);
                    gem.castShadow = true;
                    this.objects.push({ mesh: gem, type: 'gem', x: -10, z: 10 });

                    // Potions (glass bottles with glowing liquid)
                    const potionBaseGeometry = new THREE.CylinderGeometry(0.3, 0.3, 0.8, 32);
                    const potionBaseMaterial = new THREE.MeshStandardMaterial({ color: 0xffffff, metalness: 0.8, roughness: 0.2 }); // Glass
                    const potionLiquidGeometry = new THREE.CylinderGeometry(0.25, 0.25, 0.6, 32);
                    const potionLiquidMaterial = new THREE.MeshStandardMaterial({ color: 0xff4500, metalness: 0.1, roughness: 0.7 }); // Orange liquid
                    const potionBase = new THREE.Mesh(potionBaseGeometry, potionBaseMaterial);
                    const potionLiquid = new THREE.Mesh(potionLiquidGeometry, potionLiquidMaterial);
                    potionLiquid.position.y = 0.1;
                    const potionGroup = new THREE.Group();
                    potionGroup.add(potionBase, potionLiquid);
                    potionGroup.position.set(0, 0.4, -10);
                    potionGroup.castShadow = true;
                    this.objects.push({ mesh: potionGroup, type: 'potion', x: 0, z: -10 });

                    // Keys (ornate golden keys)
                    const keyHandleGeometry = new THREE.SphereGeometry(0.2, 16, 16);
                    const keyShaftGeometry = new THREE.CylinderGeometry(0.1, 0.1, 0.8, 8);
                    const keyMaterial = new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 0.9, roughness: 0.2 });
                    const keyHandle = new THREE.Mesh(keyHandleGeometry, keyMaterial);
                    const keyShaft = new THREE.Mesh(keyShaftGeometry, keyMaterial);
                    keyShaft.position.y = -0.4;
                    const keyGroup = new THREE.Group();
                    keyGroup.add(keyHandle, keyShaft);
                    keyGroup.position.set(20, 0.5, 20);
                    keyGroup.rotation.x = Math.PI / 2;
                    keyGroup.castShadow = true;
                    this.objects.push({ mesh: keyGroup, type: 'key', x: 20, z: 20 });

                    // Artifacts (mystical orbs with glow)
                    const artifactGeometry = new THREE.SphereGeometry(0.5, 16, 16);
                    const artifactMaterial = new THREE.MeshStandardMaterial({ color: 0x9400d3, metalness: 0.5, roughness: 0.5 });
                    const artifact = new THREE.Mesh(artifactGeometry, artifactMaterial);
                    artifact.position.set(-20, 0.5, -20);
                    artifact.castShadow = true;

                    const glowGeometry = new THREE.SphereGeometry(0.6, 16, 16);
                    const glowMaterial = new THREE.MeshBasicMaterial({ 
                        color: 0xffeb3b, 
                        transparent: true, 
                        opacity: 0.5,
                        side: THREE.BackSide 
                    });
                    const glow = new THREE.Mesh(glowGeometry, glowMaterial);
                    glow.position.copy(artifact.position);
                    const artifactGroup = new THREE.Group();
                    artifactGroup.add(artifact, glow);
                    this.objects.push({ mesh: artifactGroup, type: 'artifact', x: -20, z: -20 });

                    // Shop (small shop with sign)
                    const shopBaseGeometry = new THREE.BoxGeometry(4, 4, 4);
                    const shopBaseMaterial = new THREE.MeshStandardMaterial({ color: 0xffff00, metalness: 0.2, roughness: 0.6 });
                    const shopBase = new THREE.Mesh(shopBaseGeometry, shopBaseMaterial);
                    shopBase.position.set(0, 2, 0);
                    shopBase.castShadow = true;
                    shopBase.receiveShadow = true;

                    const signGeometry = new THREE.PlaneGeometry(2, 1);
                    const signMaterial = new THREE.MeshStandardMaterial({ color: 0xff0000, side: THREE.DoubleSide });
                    const sign = new THREE.Mesh(signGeometry, signMaterial);
                    sign.position.set(0, 4.5, 2);
                    sign.rotation.y = Math.PI / 2;
                    const shopGroup = new THREE.Group();
                    shopGroup.add(shopBase, sign);
                    this.objects.push({ mesh: shopGroup, type: 'shop', x: 0, z: 0 });

                    // Castle interior objects
                    if (this.scene === 'castle') {
                        const roomGeometry = new THREE.BoxGeometry(40, 10, 40);
                        const roomMaterial = new THREE.MeshStandardMaterial({ color: 0xdeb887, metalness: 0.1, roughness: 0.8 });
                        const room = new THREE.Mesh(roomGeometry, roomMaterial);
                        room.position.set(0, 5, 0);
                        room.castShadow = true;
                        room.receiveShadow = true;
                        this.objects.push({ mesh: room, type: 'room', x: 0, z: 0 });

                        const wallGeometry = new THREE.BoxGeometry(2, 8, 40);
                        const wallMaterial = new THREE.MeshStandardMaterial({ color: 0x808080, metalness: 0.2, roughness: 0.7 });
                        const wall1 = new THREE.Mesh(wallGeometry, wallMaterial);
                        wall1.position.set(10, 4, 0);
                        wall1.castShadow = true;
                        wall1.receiveShadow = true;
                        this.objects.push({ mesh: wall1, type: 'wall', x: 10, z: 0 });

                        const wall2 = new THREE.Mesh(wallGeometry, wallMaterial.clone());
                        wall2.position.set(-10, 4, 0);
                        wall2.castShadow = true;
                        wall2.receiveShadow = true;
                        this.objects.push({ mesh: wall2, type: 'wall', x: -10, z: 0 });

                        const kingBodyGeometry = new THREE.CylinderGeometry(0.5, 0.5, 2, 32);
                        const kingBodyMaterial = new THREE.MeshStandardMaterial({ color: 0x00008b, metalness: 0.3, roughness: 0.6 });
                        const kingBody = new THREE.Mesh(kingBodyGeometry, kingBodyMaterial);
                        kingBody.position.set(15, 1, 15);
                        kingBody.castShadow = true;
                        this.objects.push({ mesh: kingBody, type: 'npc', x: 15, z: 15, role: 'king' });

                        const crownGeometry = new THREE.TorusGeometry(0.5, 0.05, 16, 32);
                        const crownMaterial = new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 0.9, roughness: 0.2 });
                        const crown = new THREE.Mesh(crownGeometry, crownMaterial);
                        crown.position.set(15, 2.5, 15);
                        crown.rotation.x = Math.PI / 2;
                        crown.castShadow = true;
                        this.objects.push({ mesh: crown, type: 'crown', x: 15, z: 15 });

                        const doorGeometry = new THREE.PlaneGeometry(2, 4);
                        const doorMaterial = new THREE.MeshStandardMaterial({ color: 0xffd700, side: THREE.DoubleSide });
                        const door = new THREE.Mesh(doorGeometry, doorMaterial);
                        door.position.set(-19, 2, -19); // Bottom-left exit
                        door.rotation.y = Math.PI / 2;
                        this.objects.push({ mesh: door, type: 'door', x: -19, z: -19, building: 'town' });

                        const artifactGeometry = new THREE.SphereGeometry(0.5, 16, 16);
                        const artifactMaterial = new THREE.MeshStandardMaterial({ color: 0x9400d3, metalness: 0.5, roughness: 0.5 });
                        const artifact = new THREE.Mesh(artifactGeometry, artifactMaterial);
                        artifact.position.set(0, 0.5, 0);
                        artifact.castShadow = true;

                        const glowGeometry = new THREE.SphereGeometry(0.6, 16, 16);
                        const glowMaterial = new THREE.MeshBasicMaterial({ 
                            color: 0xffeb3b, 
                            transparent: true, 
                            opacity: 0.5,
                            side: THREE.BackSide 
                        });
                        const glow = new THREE.Mesh(glowGeometry, glowMaterial);
                        glow.position.copy(artifact.position);
                        const artifactGroup = new THREE.Group();
                        artifactGroup.add(artifact, glow);
                        this.objects.push({ mesh: artifactGroup, type: 'artifact', x: 0, z: 0 });
                    }

                    // House interior objects
                    if (this.scene === 'house') {
                        const roomGeometry = new THREE.BoxGeometry(20, 6, 20);
                        const roomMaterial = new THREE.MeshStandardMaterial({ color: 0xdeb887, metalness: 0.1, roughness: 0.8 });
                        const room = new THREE.Mesh(roomGeometry, roomMaterial);
                        room.position.set(0, 3, 0);
                        room.castShadow = true;
                        room.receiveShadow = true;
                        this.objects.push({ mesh: room, type: 'room', x: 0, z: 0 });

                        const wallGeometry = new THREE.BoxGeometry(2, 5, 20);
                        const wallMaterial = new THREE.MeshStandardMaterial({ color: 0x808080, metalness: 0.2, roughness: 0.7 });
                        const wall1 = new THREE.Mesh(wallGeometry, wallMaterial);
                        wall1.position.set(5, 2.5, 0);
                        wall1.castShadow = true;
                        wall1.receiveShadow = true;
                        this.objects.push({ mesh: wall1, type: 'wall', x: 5, z: 0 });

                        const villagerBodyGeometry = new THREE.CylinderGeometry(0.5, 0.5, 2, 32);
                        const villagerBodyMaterial = new THREE.MeshStandardMaterial({ color: 0x00008b, metalness: 0.3, roughness: 0.6 });
                        const villagerBody = new THREE.Mesh(villagerBodyGeometry, villagerBodyMaterial);
                        villagerBody.position.set(8, 1, 8);
                        villagerBody.castShadow = true;
                        this.objects.push({ mesh: villagerBody, type: 'npc', x: 8, z: 8, role: 'villager' });

                        const doorGeometry = new THREE.PlaneGeometry(2, 4);
                        const doorMaterial = new THREE.MeshStandardMaterial({ color: 0x8b4513, side: THREE.DoubleSide });
                        const door = new THREE.Mesh(doorGeometry, doorMaterial);
                        door.position.set(-9, 2, -9); // Bottom-left exit
                        door.rotation.y = Math.PI / 2;
                        this.objects.push({ mesh: door, type: 'door', x: -9, z: -9, building: 'town' });

                        const gemGeometry = new THREE.OctahedronGeometry(0.5, 0);
                        const gemMaterial = new THREE.MeshStandardMaterial({ color: 0x00ffff, metalness: 0.5, roughness: 0.5 });
                        const gem = new THREE.Mesh(gemGeometry, gemMaterial);
                        gem.position.set(0, 0.5, 0);
                        gem.castShadow = true;
                        this.objects.push({ mesh: gem, type: 'gem', x: 0, z: 0 });
                    }

                    this.objects.forEach(obj => scene.add(obj.mesh));
                }
                createNPCs(scene) {
                    const npcs = [];
                    if (scene === 'town') {
                        const npcGeometry = new THREE.CylinderGeometry(0.5, 0.5, 2, 32);
                        const npcMaterial = new THREE.MeshStandardMaterial({ color: 0x00008b, metalness: 0.3, roughness: 0.6 });
                        const guard = new THREE.Mesh(npcGeometry, npcMaterial);
                        guard.position.set(0, 1, 0);
                        guard.castShadow = true;
                        npcs.push({ mesh: guard, x: 0, z: 0, role: 'guard' });
                    }
                    return npcs;
                }
                updateObjects() {
                    scene.remove(...this.objects.map(obj => obj.mesh));
                    scene.remove(...this.npcs.map(npc => npc.mesh));
                    this.objects = this.createObjects(this.scene);
                    this.npcs = this.createNPCs(this.scene);
                    this.objects.forEach(obj => scene.add(obj.mesh));
                    this.npcs.forEach(npc => scene.add(npc.mesh));
                }
            }

            // Initialize game after scene setup
            game = new Game();

            // Camera setup
            camera.position.set(0, 10, 20);
            camera.lookAt(0, 0, 0);

            // Input handling
            const keys = {};
            document.addEventListener('keydown', (e) => keys[e.key] = true);
            document.addEventListener('keyup', (e) => keys[e.key] = false);

            document.addEventListener('mousedown', () => {
                document.body.requestPointerLock();
            });

            document.addEventListener('mousemove', (event) => {
                if (document.pointerLockElement === document.body) {
                    const movementX = event.movementX || event.mozMovementX || event.webkitMovementX || 0;
                    const movementY = event.movementY || event.mozMovementY || event.webkitMovementY || 0;
                    game.player.yaw += movementX * 0.002;
                    game.player.pitch = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, game.player.pitch + movementY * 0.002));
                }
            });

            // Update and render loop
            function update() {
                game.updateDayNight();

                let dx = 0, dz = 0;
                if (keys['ArrowUp']) dz -= game.player.speed;
                if (keys['ArrowDown']) dz += game.player.speed;
                if (keys['ArrowLeft']) dx -= game.player.speed;
                if (keys['ArrowRight']) dx += game.player.speed;

                const newX = game.player.x + dx * Math.cos(game.player.yaw) + dz * Math.sin(game.player.yaw);
                const newZ = game.player.z - dx * Math.sin(game.player.yaw) + dz * Math.cos(game.player.yaw);

                if (!game.objects.some(obj => {
                    const distX = Math.abs(obj.x - newX);
                    const distZ = Math.abs(obj.z - newZ);
                    return (obj.type === 'building' || obj.type === 'wall') && distX < 5 && distZ < 5;
                })) {
                    game.player.x = newX;
                    game.player.z = newZ;
                }

                game.player.object.position.set(game.player.x, 1, game.player.z);
                game.player.object.rotation.y = -game.player.yaw;

                // Camera follows player with pitch control
                camera.position.set(
                    game.player.x + 15 * Math.sin(game.player.yaw) * Math.cos(game.player.pitch),
                    15 + 15 * Math.sin(game.player.pitch),
                    game.player.z + 15 * Math.cos(game.player.yaw) * Math.cos(game.player.pitch)
                );
                camera.lookAt(game.player.x, 1, game.player.z);

                // NPC interactions
                game.npcs.forEach(npc => {
                    const distX = Math.abs(npc.x - game.player.x);
                    const distZ = Math.abs(npc.z - game.player.z);
                    if (distX < 2 && distZ < 2) {
                        if (npc.role === 'guard' && !game.quests.townGuard.completed) {
                            if (!game.quests.townGuard.active) {
                                game.showDialogue('Town Guard: Princess, the king needs a flower for his crown. Bring one to the castle!');
                                game.quests.townGuard.active = true;
                            } else if (game.flowers > 0) {
                                game.showDialogue('Town Guard: Thank you! Here’s a key.');
                                game.keys++;
                                game.flowers--;
                                game.quests.townGuard.completed = true;
                            } else {
                                game.showDialogue('Town Guard: Do you have a flower for the king?');
                            }
                        }
                    }
                });

                // Object interactions
                game.objects.forEach(obj => {
                    const distX = Math.abs(obj.x - game.player.x);
                    const distZ = Math.abs(obj.z - game.player.z);
                    if (distX < 1 && distZ < 1) {
                        if (obj.type === 'flower') {
                            game.flowers++;
                            scene.remove(obj.mesh);
                            game.objects = game.objects.filter(o => o !== obj);
                            game.showDialogue('You picked a radiant flower! *Sparkle*');
                        } else if (obj.type === 'coin') {
                            game.coins++;
                            scene.remove(obj.mesh);
                            game.objects = game.objects.filter(o => o !== obj);
                            game.showDialogue('You found a glittering coin!');
                        } else if (obj.type === 'gem') {
                            game.gems++;
                            scene.remove(obj.mesh);
                            game.objects = game.objects.filter(o => o !== obj);
                            game.showDialogue('A dazzling gem shines in your hand!');
                        } else if (obj.type === 'potion') {
                            game.potions++;
                            game.health = Math.min(100, game.health + 20);
                            scene.remove(obj.mesh);
                            game.objects = game.objects.filter(o => o !== obj);
                            game.showDialogue('You drank a potion! Health restored.');
                        } else if (obj.type === 'key') {
                            game.keys++;
                            scene.remove(obj.mesh);
                            game.objects = game.objects.filter(o => o !== obj);
                            game.showDialogue('You found a golden key!');
                        } else if (obj.type === 'artifact') {
                            game.artifacts++;
                            scene.remove(obj.mesh);
                            game.objects = game.objects.filter(o => o !== obj);
                            game.showDialogue('You discovered a mystical artifact!');
                        } else if (obj.type === 'door') {
                            if (this.scene === 'town') {
                                if (obj.building === 'castle' && this.keys > 0) {
                                    this.scene = 'castle';
                                    this.keys--;
                                    this.player.x = 0;
                                    this.player.z = 0;
                                    this.player.yaw = 0;
                                    this.updateObjects();
                                    this.showDialogue('Entered the majestic castle!');
                                } else if (obj.building === 'house') {
                                    this.scene = 'house';
                                    this.player.x = 0;
                                    this.player.z = 0;
                                    this.player.yaw = 0;
                                    this.updateObjects();
                                    this.showDialogue('Entered the cozy house!');
                                } else {
                                    this.showDialogue('Need a key to enter the castle!');
                                }
                            } else if (this.scene !== 'town' && obj.building === 'town') {
                                this.scene = 'town';
                                this.player.x = obj.x;
                                this.player.z = obj.z;
                                this.player.yaw = 0;
                                this.updateObjects();
                                this.showDialogue('Returned to the town!');
                            }
                        } else if (obj.type === 'shop') {
                            if (this.coins >= 5) {
                                this.coins -= 5;
                                this.potions++;
                                this.health = Math.min(100, this.health + 20);
                                this.showDialogue('Shopkeeper: Bought a potion! Health restored.');
                            } else {
                                this.showDialogue('Shopkeeper: Need 5 coins for a potion!');
                            }
                        }
                    }
                });

                if (this.health <= 0) {
                    this.showDialogue('Game Over! You were defeated.');
                    this.health = 100;
                    this.mana = 50;
                    this.player.x = 0;
                    this.player.z = 0;
                    this.scene = 'town';
                    this.updateObjects();
                }

                if (Object.values(keys).some(k => k)) {
                    this.player.frame = (this.player.frame + 1) % 30;
                }

                // Update sky color for day/night
                const sky = scene.getObjectByName('sky');
                if (sky) {
                    sky.material.uniforms.topColor.value.set(this.time === 'Day' ? 0x87ceeb : 0x2f4f4f);
                    sky.material.uniforms.bottomColor.value.set(this.time === 'Day' ? 0x87ceeb : 0x2f4f4f);
                }
            }

            function animate() {
                requestAnimationFrame(animate);
                update();
                renderer.render(scene, camera);
            }

            animate();

            // Handle window resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        } catch (error) {
            console.error('WebGL Error:', error);
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('gameCanvas').style.display = 'none';
            document.getElementById('ui').style.display = 'none';
            document.getElementById('dialogue').style.display = 'none';
        }
    </script>
</body>
</html>
