<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=no">
  <title>Princess Donia’s Town – Enhanced RPG</title>
  <style>
    /* Your full style from previous version */
    /* (kept identical for space - includes D-Pad, actions, health bar, etc.) */
  </style>
</head>
<body>
  <!-- Your full HTML body from the D-Pad version -->
  <!-- Includes dpadContainer and actionContainer -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    // Your UI toggle, D-Pad listeners, action buttons code...

    class Game {
      constructor() {
        const canvas = document.getElementById('gameCanvas');
        const isMobile = /iPad|iPhone|iPod|Android/i.test(navigator.userAgent);

        let gl;
        try {
          gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        } catch (e) {}

        if (!gl) {
          document.getElementById('errorMessage').style.display = 'block';
          return;
        }

        this.renderer = new THREE.WebGLRenderer({
          canvas: canvas,
          context: gl,
          antialias: !isMobile,
          alpha: false
        });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, isMobile ? 1 : 2));
        this.renderer.shadowMap.enabled = !isMobile;

        // Your player, stats, etc.

        this.initWorld();
        this.createPlayer();
        this.createTownFeatures();
        this.startAnimation();
        this.initInput();
      }

      createSun() {
        const sunGeo = new THREE.SphereGeometry(10,16,16);
        const sunMat = new THREE.MeshBasicMaterial({color:0xffee00});
        this.sunMesh = new THREE.Mesh(sunGeo, sunMat);
        this.sunMesh.position.set(0,200,-200);
        outsideScene.add(this.sunMesh);
      }

      createMoon() {
        const moonGeo = new THREE.SphereGeometry(6,16,16);
        const moonMat = new THREE.MeshBasicMaterial({color:0xddddff});
        this.moonMesh = new THREE.Mesh(moonGeo, moonMat);
        this.moonMesh.position.set(-100,150,100);
        this.moonMesh.visible = false;
        outsideScene.add(this.moonMesh);
      }

      createStars() {
        const count = 300;
        const positions = new Float32Array(count*3);
        for(let i=0;i<count;i++){
          const r = 300 + Math.random()*200;
          const a = Math.random()*Math.PI*2;
          positions[i*3] = Math.cos(a)*r;
          positions[i*3+1] = 50 + Math.random()*100;
          positions[i*3+2] = Math.sin(a)*r;
        }
        const geo = new THREE.BufferGeometry();
        geo.setAttribute('position', new THREE.BufferAttribute(positions,3));
        const mat = new THREE.PointsMaterial({color:0xffffff, size:1.5});
        this.starsMesh = new THREE.Points(geo, mat);
        this.starsMesh.visible = false;
        outsideScene.add(this.starsMesh);
      }

      createFireflies() {
        const count = 80;
        const positions = new Float32Array(count*3);
        for(let i=0;i<count;i++){
          positions[i*3] = (Math.random()-0.5)*300;
          positions[i*3+1] = 5 + Math.random()*20;
          positions[i*3+2] = (Math.random()-0.5)*300;
        }
        const geo = new THREE.BufferGeometry();
        geo.setAttribute('position', new THREE.BufferAttribute(positions,3));
        const mat = new THREE.PointsMaterial({color:0xffff88, size:3, transparent:true});
        this.fireflies = new THREE.Points(geo, mat);
        this.fireflies.visible = false;
        outsideScene.add(this.fireflies);
      }

      // Rest of your functions (createPlayer, createTownFeatures, update*, etc.) unchanged from previous working version

      initWorld() {
        // ground, paths, lights...
        this.createSun();
        this.createMoon();
        this.createStars();
        this.createFireflies();
        // water, etc.
      }

      // ... full update loop, movement with D-Pad, etc.

    }

    window.onload = () => {
      try {
        game = new Game();
      } catch(e) {
        console.error(e);
        document.getElementById('errorMessage').style.display = 'block';
      }
    };
  </script>
</body>
</html>
