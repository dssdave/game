<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=no">
  <title>Princess Donia’s Town – Enhanced RPG</title>
  <style>
    html, body { margin:0; padding:0; background:#000; font-family:Arial, sans-serif; overflow:hidden; user-select:none; touch-action:manipulation; }
    #gameContainer { position:relative; width:100vw; height:100vh; }
    canvas { display:block; }
    #ui, #ballCount, #dialogue, #controls, #errorMessage, #guardPopup, #healthBar, #inventory {
      background:rgba(0,0,0,0.7); border:4px solid #fff; border-radius:5px; color:#fff; font-size:28px; padding:20px 30px; position:absolute; z-index:10;
    }
    #ui { top:10px; left:10px; }
    #ballCount { top:10px; right:10px; }
    #dialogue { bottom:10px; left:10px; max-width:600px; display:none; }
    #controls { bottom:10px; right:10px; font-size:20px; }
    #errorMessage { top:50%; left:50%; transform:translate(-50%,-50%); display:none; }
    #guardPopup { bottom:50%; left:50%; transform:translate(-50%,50%); display:none; text-align:center; }
    #healthBar { top:10px; left:50%; transform:translateX(-50%); width:300px; height:20px; background:#333; border:3px solid #fff; border-radius:10px; overflow:hidden; z-index:10; }
    #healthFill { width:100%; height:100%; background:#00ff00; transition:width 0.3s, background 0.3s; }
    #toggleUIBtn { position:absolute; top:10px; left:50%; transform:translateX(-50%); z-index:11; font-size:24px; padding:10px 20px; background:#333; color:#fff; border:2px solid #fff; border-radius:5px; cursor:pointer; }
    #inventory { display:none; top:50%; left:50%; transform:translate(-50%,-50%); padding:30px; border:4px solid #ffd700; border-radius:15px; font-size:24px; text-align:center; z-index:20; }
    #dpadContainer {
      position:absolute; bottom:16vh; left:5vw; z-index:15;
      display:grid; grid-template-columns:80px 80px 80px; grid-template-rows:80px 80px 80px; gap:10px;
    }
    #dpadContainer button {
      width:80px; height:80px; background:rgba(255,255,255,0.3); border:3px solid #fff; border-radius:10px;
      font-size:32px; color:#fff; cursor:pointer;
    }
    #actionContainer {
      position:absolute; bottom:16vh; right:5vw; z-index:15;
      display:flex; flex-direction:column; gap:15px;
    }
    #actionContainer button {
      width:80px; height:80px; background:rgba(255,100,100,0.6); border:3px solid #fff; border-radius:50%;
      font-size:20px; color:#fff;
    }
    @media (max-width:768px) {
      #ui, #ballCount, #dialogue, #controls { font-size:16px; padding:10px 15px; }
      #dpadContainer { grid-template-columns:60px 60px 60px; grid-template-rows:60px 60px 60px; }
      #dpadContainer button { width:60px; height:60px; font-size:24px; }
      #actionContainer button { width:60px; height:60px; }
      #healthBar { width:200px; }
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <button id="toggleUIBtn">Toggle UI</button>
    <div id="ui">
      Flowers: <span id="flowers">0</span> |
      Coins: <span id="coins">0</span> |
      Gems: <span id="gems">0</span> |
      Potions: <span id="potions">0</span> |
      Keys: <span id="keys">0</span> |
      Artifacts: <span id="artifacts">0</span> |
      Health: <span id="health">100</span> |
      Time: <span id="time">Day</span> |
      Location: <span id="location">Town</span>
    </div>
    <div id="ballCount">Magic Orbs Thrown: <span id="ballCountValue">0</span></div>
    <div id="dialogue"></div>
    <div id="controls">
      Touch: D-Pad = move/turn<br>
      A = throw orb, B = jump
    </div>
    <div id="errorMessage">WebGL not supported.</div>
    <div id="guardPopup"></div>
    <div id="healthBar"><div id="healthFill"></div></div>
    <div id="inventory">
      <div>Flowers: <span id="invFlowers">0</span></div>
      <div style="margin-top:20px;">Quest: Collect 10 flowers to restore the garden</div>
    </div>

    <!-- D-Pad Buttons (classic) -->
    <div id="dpadContainer">
      <button id="btnUp">↑</button>
      <button id="btnDown">↓</button>
      <button id="btnLeft">←</button>
      <button id="btnRight">→</button>
    </div>

    <!-- Action Buttons -->
    <div id="actionContainer">
      <button id="btnOrb">A Orb</button>
      <button id="btnJump">B Jump</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    // Toggle UI
    document.getElementById('toggleUIBtn').onclick = () => {
      ["ui","ballCount","dialogue","controls","guardPopup","errorMessage","healthBar"].forEach(id => {
        const el = document.getElementById(id);
        el.style.display = el.style.display === "none" ? "block" : "none";
      });
    };

    // D-Pad state
    const dpad = {up:false, down:false, left:false, right:false};

    ['btnUp','btnDown','btnLeft','btnRight'].forEach(id => {
      const btn = document.getElementById(id);
      btn.addEventListener('touchstart', e => { e.preventDefault(); dpad[id.slice(3).toLowerCase()] = true; }, {passive:false});
      btn.addEventListener('touchend', () => dpad[id.slice(3).toLowerCase()] = false);
      btn.addEventListener('mousedown', () => dpad[id.slice(3).toLowerCase()] = true);
      btn.addEventListener('mouseup', () => dpad[id.slice(3).toLowerCase()] = false);
      btn.addEventListener('mouseleave', () => dpad[id.slice(3).toLowerCase()] = false);
    });

    // Action buttons
    document.getElementById('btnOrb').addEventListener('click', () => game && game.throwBall());
    document.getElementById('btnOrb').addEventListener('touchstart', e => {e.preventDefault(); game && game.throwBall();});
    document.getElementById('btnJump').addEventListener('click', () => game && game.jump());
    document.getElementById('btnJump').addEventListener('touchstart', e => {e.preventDefault(); game && game.jump();});

    // Global
    const outsideScene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 3000);
    const keysPressed = {};
    let game = null;

    class Game {
      constructor() {
        this.renderer = new THREE.WebGLRenderer({canvas:document.getElementById('gameCanvas'), antialias:true});
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
        this.renderer.shadowMap.enabled = true;

        this.player = {x:0,y:0.5,z:0,yaw:0,jumpVelocity:0,object:null,bobTime:0};
        this.flowers=0; this.health=100; this.ballCount=0; this.thrownBalls=[];
        this.dayNightCounter=0; this.time="Day";
        this.outsideObjects=[]; this.npcs=[]; this.fireflies=null;

        this.questActive=false; this.questComplete=false;

        this.initWorld();
        this.createPlayer();
        this.createTownFeatures();
        this.startAnimation();
        this.initInput();
      }

      generateCobblestoneTexture() {
        const canvas = document.createElement('canvas');
        canvas.width = canvas.height = 256;
        const ctx = canvas.getContext('2d');
        for(let y=0; y<256; y+=32){
          for(let x=0; x<256; x+=32){
            const shade = 100 + Math.random()*40;
            ctx.fillStyle = `rgb(${shade},${shade-10},${shade-20})`;
            ctx.fillRect(x,y,32,32);
            ctx.strokeStyle = '#555';
            ctx.strokeRect(x,y,32,32);
          }
        }
        const tex = new THREE.CanvasTexture(canvas);
        tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
        tex.repeat.set(4,4);
        return tex;
      }

      initWorld() {
        outsideScene.background = new THREE.Color(0x87CEEB);

        // Main grass ground
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(500,500), new THREE.MeshStandardMaterial({color:0x6bb26b}));
        ground.rotation.x = -Math.PI/2; ground.receiveShadow=true;
        outsideScene.add(ground);

        // Cobblestone paths
        const pathMat = new THREE.MeshStandardMaterial({map:this.generateCobblestoneTexture()});
        const pathGeo = new THREE.PlaneGeometry(12,100);
        // Main north-south path
        const pathNS = new THREE.Mesh(pathGeo, pathMat);
        pathNS.rotation.x = -Math.PI/2; pathNS.position.set(0,0.02,0);
        outsideScene.add(pathNS);
        // East-west path
        const pathEW = new THREE.Mesh(new THREE.PlaneGeometry(100,12), pathMat);
        pathEW.rotation.x = -Math.PI/2; pathEW.position.set(0,0.02,0);
        outsideScene.add(pathEW);

        const ambient = new THREE.AmbientLight(0xffffff,0.6);
        const dirLight = new THREE.DirectionalLight(0xffffff,1);
        dirLight.position.set(50,100,50); dirLight.castShadow=true;
        outsideScene.add(ambient, dirLight);

        this.createSun(); this.createMoon(); this.createStars(); this.createFireflies();
      }

      createPlayer() { /* same beautiful princess as before */ 
        const g = new THREE.Group();
        const dress = new THREE.Mesh(new THREE.ConeGeometry(0.6,1.6,16), new THREE.MeshStandardMaterial({color:0xff69b4}));
        dress.position.y=0.7; g.add(dress);
        const torso = new THREE.Mesh(new THREE.CylinderGeometry(0.35,0.4,0.8,16), new THREE.MeshStandardMaterial({color:0xffa0d0}));
        torso.position.y=1.2; g.add(torso);
        const head = new THREE.Mesh(new THREE.SphereGeometry(0.3,16,16), new THREE.MeshStandardMaterial({color:0xffddc1}));
        head.position.y=1.8; g.add(head);
        const hair = new THREE.Mesh(new THREE.CylinderGeometry(0.35,0.45,1.2,16), new THREE.MeshStandardMaterial({color:0xb5651d}));
        hair.position.y=1.9; g.add(hair);
        const crown = new THREE.Mesh(new THREE.TorusGeometry(0.32,0.08,8,16), new THREE.MeshStandardMaterial({color:0xffd700,emissive:0xffd700,emissiveIntensity:0.8}));
        crown.rotation.x=Math.PI/2; crown.position.y=2.15; g.add(crown);
        const armGeo = new THREE.CylinderGeometry(0.1,0.1,0.9,8);
        const left = new THREE.Mesh(armGeo, new THREE.MeshStandardMaterial({color:0xffddc1}));
        left.position.set(-0.5,1.3,0); left.rotation.z=0.3; left.userData={arm:true}; g.add(left);
        const right = left.clone(); right.position.x=0.5; right.rotation.z=-0.3; g.add(right);
        g.position.set(this.player.x,this.player.y,this.player.z);
        this.player.object = g;
        outsideScene.add(g);
      }

      createBench(x,z,rot=0) {
        const g = new THREE.Group();
        const seat = new THREE.Mesh(new THREE.BoxGeometry(3,0.3,0.8), new THREE.MeshStandardMaterial({color:0x8b4513}));
        seat.position.y=0.5; g.add(seat);
        const leg = new THREE.Mesh(new THREE.BoxGeometry(0.2,0.8,0.2), new THREE.MeshStandardMaterial({color:0x654321}));
        leg.position.set(-1.2,0.2,0.3); g.add(leg); leg.clone().position.set(1.2,0.2,0.3); g.add(leg.clone());
        leg.clone().position.set(-1.2,0.2,-0.3); g.add(leg.clone());
        leg.clone().position.set(1.2,0.2,-0.3); g.add(leg.clone());
        g.position.set(x,0,z); g.rotation.y=rot;
        outsideScene.add(g);
        this.outsideObjects.push({type:'decoration',x,z,boundingRadius:2});
      }

      createStatueFountain() {
        const g = new THREE.Group();
        const base = new THREE.Mesh(new THREE.CylinderGeometry(4,4,1,16), new THREE.MeshStandardMaterial({color:0x808080}));
        base.position.y=0.5; g.add(base);
        const bowl = new THREE.Mesh(new THREE.TorusGeometry(4,0.5,16,32), new THREE.MeshStandardMaterial({color:0x808080}));
        bowl.rotation.x=Math.PI/2; bowl.position.y=1; g.add(bowl);
        const water = new THREE.Mesh(new THREE.CylinderGeometry(3.8,3.8,0.3,16), new THREE.MeshStandardMaterial({color:0x1e90ff,transparent:true,opacity:0.7}));
        water.position.y=1.15; g.add(water);
        // Princess statue
        const statue = new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.5,2,16), new THREE.MeshStandardMaterial({color:0xffffff}));
        statue.position.y=2; g.add(statue);
        const head = new THREE.Mesh(new THREE.SphereGeometry(0.3,16,16), new THREE.MeshStandardMaterial({color:0xffddc1}));
        head.position.y=3.2; g.add(head);
        g.position.set(0,0,0);
        outsideScene.add(g);
        this.outsideObjects.push({type:'decoration',x:0,z:0,boundingRadius:5});
      }

      createNPC(color,x,z) {
        const g = new THREE.Group();
        const body = new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.5,1.2,16), new THREE.MeshStandardMaterial({color}));
        body.position.y=0.6; g.add(body);
        const head = new THREE.Mesh(new THREE.SphereGeometry(0.3,16,16), new THREE.MeshStandardMaterial({color:0xffddc1}));
        head.position.y=1.4; g.add(head);
        g.position.set(x,0.5,z);
        outsideScene.add(g);
        this.npcs.push({object:g, angle:Math.random()*Math.PI*2, speed:0.01 + Math.random()*0.01, radius:20 + Math.random()*30});
        this.outsideObjects.push({type:'npc',x,z,boundingRadius:1});
      }

      createTownFeatures() {
        this.createStatueFountain(); // central square
        this.createCastle(); this.createHouse(); this.createCafe(); this.createGuard();
        // Benches around town
        this.createBench(10,10,0); this.createBench(-10,10,Math.PI);
        this.createBench(10,-10,0); this.createBench(-10,-10,Math.PI);
        this.createBench(40,30,Math.PI/2); this.createBench(-40,-20,0);
        // More NPCs walking
        this.createNPC(0xff0000, 15,15);
        this.createNPC(0x00ff00, -15,15);
        this.createNPC(0x0000ff, 15,-15);
        this.createNPC(0xffff00, -15,-15);
        this.createNPC(0xff00ff, 30,0);
        this.createNPC(0x00ffff, 0,30);
        this.createFlowers(30);
      }

      // Keep createCastle, createHouse, etc. from previous versions (simplified if needed)

      update() {
        this.updateDayNight();
        this.updateNPCs();
        this.updateMovement();
        this.updateCamera();
        this.updatePickups();
        this.updateCollisions();
        this.updateQuest();
        this.updateBalls();
        document.getElementById('healthFill').style.width = this.health+'%';
      }

      updateNPCs() {
        this.npcs.forEach(n => {
          n.angle += n.speed;
          n.object.position.x = n.object.position.x + Math.cos(n.angle)*0.5;
          n.object.position.z = n.object.position.z + Math.sin(n.angle)*0.5;
          n.object.rotation.y = n.angle;
        });
      }

      updateMovement() {
        let forward = 0, turn = 0;
        if(keysPressed['ArrowUp'] || keysPressed['w'] || dpad.up) forward += 1;
        if(keysPressed['ArrowDown'] || keysPressed['s'] || dpad.down) forward -= 1;
        if(keysPressed['ArrowLeft'] || keysPressed['a'] || dpad.left) turn += 1;
        if(keysPressed['ArrowRight'] || keysPressed['d'] || dpad.right) turn -= 1;

        const speed = 0.12;
        const dir = new THREE.Vector3(Math.sin(this.player.yaw),0,Math.cos(this.player.yaw));
        const move = dir.multiplyScalar(forward * speed);
        this.player.x += move.x; this.player.z += move.z;
        this.player.yaw -= turn * 0.03;

        // jump, bob, arms... (same as before)

        this.player.object.position.set(this.player.x, this.player.y, this.player.z);
        this.player.object.rotation.y = this.player.yaw;
      }

      // Rest of functions (throwBall, jump, showDialogue, etc.) same as previous full version

      throwBall() { /* glowing orb code from before */ }
      jump() { /* same */ }
      showDialogue(text) { /* same */ }

      startAnimation() {
        const animate = () => {
          requestAnimationFrame(animate);
          this.update();
          this.renderer.render(outsideScene, camera);
        };
        animate();
      }

      initInput() {
        document.addEventListener('keydown', e => keysPressed[e.key] = true);
        document.addEventListener('keyup', e => keysPressed[e.key] = false);
      }
    }

    window.onload = () => {
      try {
        game = new Game();
      } catch(e) {
        console.error(e);
        document.getElementById('errorMessage').style.display='block';
      }
    };
  </script>
</body>
</html>
