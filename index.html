<!DOCTYPE html>
<html>
<head>
    <title>Expanded 3D Princess RPG</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            background: #000;
        }
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        canvas {
            display: block;
        }
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #fff;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 10;
        }
        #dialogue {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: #fff;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            max-width: 600px;
            z-index: 10;
        }
        #errorMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 5px;
            z-index: 20;
            display: none;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 18px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 5px;
            z-index: 20;
        }
    </style>
    <!-- Include Three.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="ui">
            Flowers: <span id="flowers">0</span> | 
            Coins: <span id="coins">0</span> | 
            Gems: <span id="gems">0</span> | 
            Potions: <span id="potions">0</span> | 
            Keys: <span id="keys">0</span> | 
            Artifacts: <span id="artifacts">0</span> | 
            Health: <span id="health">100</span> | 
            Mana: <span id="mana">50</span> | 
            Time: <span id="time">Day</span> | 
            Location: <span id="location">Town</span>
        </div>
        <div id="dialogue"></div>
        <div id="errorMessage">WebGL is not supported in your browser. Please use a modern browser like Chrome, Firefox, or Edge.</div>
        <div id="loading">Loading game... Please wait.</div>
    </script>

    <script>
        // Error handling for WebGL
        try {
            if (!window.WebGLRenderingContext) {
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('gameCanvas').style.display = 'none';
                document.getElementById('ui').style.display = 'none';
                document.getElementById('dialogue').style.display = 'none';
                throw new Error('WebGL not supported');
            }

            // Scene setup
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('gameCanvas') });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('loading').style.display = 'none';

            // Game state
            class Game {
                constructor() {
                    this.scene = 'town';
                    this.flowers = 0;
                    this.coins = 0;
                    this.gems = 0;
                    this.potions = 0;
                    this.keys = 0;
                    this.artifacts = 0;
                    this.health = 100;
                    this.mana = 50;
                    this.time = 'Day';
                    this.dayNightCycle = 0;
                    this.player = {
                        x: 0,
                        z: 0,
                        speed: 0.5,
                        yaw: 0,
                        pitch: 0,
                        object: null
                    };
                    this.dialogue = '';
                    this.dialogueTimer = 0;
                    this.objects = [];
                    this.enemies = [];
                    this.npcs = [];
                    this.quests = {
                        townGuard: { active: false, completed: false },
                        castleKing: { active: false, completed: false },
                        villager: { active: false, completed: false }
                    };
                    this.initScene();
                }
                showDialogue(text) {
                    this.dialogue = text;
                    this.dialogueTimer = 120; // Display for 2 seconds (60 FPS)
                }
                initScene() {
                    // Ground (detailed terrain)
                    const groundGeometry = new THREE.PlaneGeometry(100, 100, 50, 50);
                    const groundMaterial = new THREE.MeshStandardMaterial({ color: 0x6bb26b, side: THREE.DoubleSide });
                    const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                    ground.rotation.x = Math.PI / 2;
                    ground.castShadow = true;
                    ground.receiveShadow = true;
                    scene.add(ground);

                    // Skybox (day/night effect)
                    const skyGeometry = new THREE.SphereGeometry(500, 60, 40);
                    const skyMaterial = new THREE.MeshBasicMaterial({
                        map: new THREE.TextureLoader().load('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII='),
                        side: THREE.BackSide
                    });
                    const sky = new THREE.Mesh(skyGeometry, skyMaterial);
                    sky.material.color.set(game.time === 'Day' ? 0x87ceeb : 0x2f4f4f);
                    scene.add(sky);

                    // Player (princess, detailed model)
                    const playerGeometry = new THREE.CylinderGeometry(0.5, 0.5, 2, 32);
                    const playerMaterial = new THREE.MeshStandardMaterial({ color: 0xff69b4, metalness: 0.1, roughness: 0.5 });
                    this.player.object = new THREE.Mesh(playerGeometry, playerMaterial);
                    this.player.object.position.set(this.player.x, 1, this.player.z);
                    this.player.object.castShadow = true;
                    scene.add(this.player.object);

                    // Lighting (advanced setup)
                    const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
                    scene.add(ambientLight);
                    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    directionalLight.position.set(10, 20, 10);
                    directionalLight.castShadow = true;
                    directionalLight.shadow.mapSize.width = 2048;
                    directionalLight.shadow.mapSize.height = 2048;
                    directionalLight.shadow.camera.near = 0.5;
                    directionalLight.shadow.camera.far = 50;
                    scene.add(directionalLight);

                    // Objects (buildings, collectibles, NPCs, enemies)
                    this.objects = this.createObjects(this.scene);
                    this.objects.forEach(obj => scene.add(obj.mesh));
                    this.enemies = this.createEnemies(this.scene);
                    this.enemies.forEach(enemy => scene.add(enemy.mesh));
                    this.npcs = this.createNPCs(this.scene);
                    this.npcs.forEach(npc => scene.add(npc.mesh));
                }
                createObjects(scene) {
                    const objects = [];
                    if (scene === 'town') {
                        // Castle (large detailed building)
                        const castleGeometry = new THREE.BoxGeometry(10, 10, 10);
                        const castleMaterial = new THREE.MeshStandardMaterial({ color: 0x808080, metalness: 0.2, roughness: 0.7 });
                        const castle = new THREE.Mesh(castleGeometry, castleMaterial);
                        castle.position.set(30, 5, 30);
                        castle.castShadow = true;
                        castle.receiveShadow = true;
                        objects.push({ mesh: castle, type: 'building', x: 30, z: 30 });

                        // House (smaller detailed building)
                        const houseGeometry = new THREE.BoxGeometry(6, 6, 6);
                        const houseMaterial = new THREE.MeshStandardMaterial({ color: 0x808080, metalness: 0.2, roughness: 0.7 });
                        const house = new THREE.Mesh(houseGeometry, houseMaterial);
                        house.position.set(-30, 3, -30);
                        house.castShadow = true;
                        house.receiveShadow = true;
                        objects.push({ mesh: house, type: 'building', x: -30, z: -30 });

                        // Castle door (red plane at entrance)
                        const doorGeometry = new THREE.PlaneGeometry(2, 4);
                        const doorMaterial = new THREE.MeshStandardMaterial({ color: 0xff0000, side: THREE.DoubleSide });
                        const castleDoor = new THREE.Mesh(doorGeometry, doorMaterial);
                        castleDoor.position.set(25, 2, 30); // Front-left of castle
                        castleDoor.rotation.y = Math.PI / 2;
                        objects.push({ mesh: castleDoor, type: 'door', x: 25, z: 30, building: 'castle' });

                        // House door (red plane at entrance)
                        const houseDoor = new THREE.Mesh(doorGeometry, doorMaterial);
                        houseDoor.position.set(-32, 2, -30); // Front-left of house
                        houseDoor.rotation.y = Math.PI / 2;
                        objects.push({ mesh: houseDoor, type: 'door', x: -32, z: -30, building: 'house' });

                        // Flowers (small spheres, magenta)
                        const flowerGeometry = new THREE.SphereGeometry(0.5, 16, 16);
                        const flowerMaterial = new THREE.MeshStandardMaterial({ color: 0xff00ff, metalness: 0.1, roughness: 0.8 });
                        const flower1 = new THREE.Mesh(flowerGeometry, flowerMaterial);
                        flower1.position.set(10, 0.5, 10);
                        flower1.castShadow = true;
                        objects.push({ mesh: flower1, type: 'flower', x: 10, z: 10 });

                        const flower2 = new THREE.Mesh(flowerGeometry, flowerMaterial);
                        flower2.position.set(-10, 0.5, 0);
                        flower2.castShadow = true;
                        objects.push({ mesh: flower2, type: 'flower', x: -10, z: 0 });

                        // Coins (small spheres, gold)
                        const coinGeometry = new THREE.SphereGeometry(0.5, 16, 16);
                        const coinMaterial = new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 0.9, roughness: 0.2 });
                        const coin1 = new THREE.Mesh(coinGeometry, coinMaterial);
                        coin1.position.set(0, 0.5, 10);
                        coin1.castShadow = true;
                        objects.push({ mesh: coin1, type: 'coin', x: 0, z: 10 });

                        const coin2 = new THREE.Mesh(coinGeometry, coinMaterial);
                        coin2.position.set(10, 0.5, -10);
                        coin2.castShadow = true;
                        objects.push({ mesh: coin2, type: 'coin', x: 10, z: -10 });

                        // Gems (small octahedrons, cyan)
                        const gemGeometry = new THREE.OctahedronGeometry(0.5, 0);
                        const gemMaterial = new THREE.MeshStandardMaterial({ color: 0x00ffff, metalness: 0.5, roughness: 0.5 });
                        const gem = new THREE.Mesh(gemGeometry, gemMaterial);
                        gem.position.set(-10, 0.5, 10);
                        gem.castShadow = true;
                        objects.push({ mesh: gem, type: 'gem', x: -10, z: 10 });

                        // Potions (small cylinders, orange)
                        const potionGeometry = new THREE.CylinderGeometry(0.3, 0.3, 1, 32);
                        const potionMaterial = new THREE.MeshStandardMaterial({ color: 0xff4500, metalness: 0.1, roughness: 0.7 });
                        const potion = new THREE.Mesh(potionGeometry, potionMaterial);
                        potion.position.set(0, 0.5, -10);
                        potion.castShadow = true;
                        objects.push({ mesh: potion, type: 'potion', x: 0, z: -10 });

                        // Keys (small keys, gold)
                        const keyGeometry = new THREE.CylinderGeometry(0.2, 0.2, 0.8, 8);
                        const keyMaterial = new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 0.9, roughness: 0.2 });
                        const key = new THREE.Mesh(keyGeometry, keyMaterial);
                        key.position.set(20, 0.5, 20);
                        key.rotation.x = Math.PI / 2;
                        key.castShadow = true;
                        objects.push({ mesh: key, type: 'key', x: 20, z: 20 });

                        // Artifacts (small orbs, purple)
                        const artifactGeometry = new THREE.SphereGeometry(0.5, 16, 16);
                        const artifactMaterial = new THREE.MeshStandardMaterial({ color: 0x9400d3, metalness: 0.5, roughness: 0.5 });
                        const artifact = new THREE.Mesh(artifactGeometry, artifactMaterial);
                        artifact.position.set(-20, 0.5, -20);
                        artifact.castShadow = true;
                        objects.push({ mesh: artifact, type: 'artifact', x: -20, z: -20 });

                        // Shop (small building, yellow)
                        const shopGeometry = new THREE.BoxGeometry(4, 4, 4);
                        const shopMaterial = new THREE.MeshStandardMaterial({ color: 0xffff00, metalness: 0.2, roughness: 0.6 });
                        const shop = new THREE.Mesh(shopGeometry, shopMaterial);
                        shop.position.set(0, 2, 0);
                        shop.castShadow = true;
                        shop.receiveShadow = true;
                        objects.push({ mesh: shop, type: 'shop', x: 0, z: 0 });
                    } else if (scene === 'castle') {
                        // Castle interior (multi-room design)
                        const roomGeometry = new THREE.BoxGeometry(40, 10, 40);
                        const roomMaterial = new THREE.MeshStandardMaterial({ color: 0xdeb887, metalness: 0.1, roughness: 0.8 });
                        const room = new THREE.Mesh(roomGeometry, roomMaterial);
                        room.position.set(0, 5, 0);
                        room.castShadow = true;
                        room.receiveShadow = true;
                        objects.push({ mesh: room, type: 'room', x: 0, z: 0 });

                        // Walls (to create rooms)
                        const wallGeometry = new THREE.BoxGeometry(2, 8, 40);
                        const wallMaterial = new THREE.MeshStandardMaterial({ color: 0x808080, metalness: 0.2, roughness: 0.7 });
                        const wall1 = new THREE.Mesh(wallGeometry, wallMaterial);
                        wall1.position.set(10, 4, 0);
                        wall1.castShadow = true;
                        wall1.receiveShadow = true;
                        objects.push({ mesh: wall1, type: 'wall', x: 10, z: 0 });

                        const wall2 = new THREE.Mesh(wallGeometry, wallMaterial);
                        wall2.position.set(-10, 4, 0);
                        wall2.castShadow = true;
                        wall2.receiveShadow = true;
                        objects.push({ mesh: wall2, type: 'wall', x: -10, z: 0 });

                        // King NPC (blue cube with crown)
                        const npcGeometry = new THREE.CylinderGeometry(0.5, 0.5, 2, 32);
                        const npcMaterial = new THREE.MeshStandardMaterial({ color: 0x00008b, metalness: 0.3, roughness: 0.6 });
                        const king = new THREE.Mesh(npcGeometry, npcMaterial);
                        king.position.set(15, 1, 15);
                        king.castShadow = true;
                        objects.push({ mesh: king, type: 'npc', x: 15, z: 15, role: 'king' });

                        // Crown (gold sphere on king)
                        const crownGeometry = new THREE.SphereGeometry(0.3, 16, 16);
                        const crownMaterial = new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 0.9, roughness: 0.2 });
                        const crown = new THREE.Mesh(crownGeometry, crownMaterial);
                        crown.position.set(15, 2.5, 15);
                        crown.castShadow = true;
                        objects.push({ mesh: crown, type: 'crown', x: 15, z: 15 });

                        // Door (red plane to exit)
                        const doorGeometry = new THREE.PlaneGeometry(2, 4);
                        const doorMaterial = new THREE.MeshStandardMaterial({ color: 0xff0000, side: THREE.DoubleSide });
                        const door = new THREE.Mesh(doorGeometry, doorMaterial);
                        door.position.set(-19, 2, -19); // Bottom-left exit
                        door.rotation.y = Math.PI / 2;
                        objects.push({ mesh: door, type: 'door', x: -19, z: -19, building: 'town' });

                        // Hidden artifact (purple orb)
                        const artifactGeometry = new THREE.SphereGeometry(0.5, 16, 16);
                        const artifactMaterial = new THREE.MeshStandardMaterial({ color: 0x9400d3, metalness: 0.5, roughness: 0.5 });
                        const artifact = new THREE.Mesh(artifactGeometry, artifactMaterial);
                        artifact.position.set(0, 0.5, 0);
                        artifact.castShadow = true;
                        objects.push({ mesh: artifact, type: 'artifact', x: 0, z: 0 });
                    } else if (scene === 'house') {
                        // House interior (multi-room design)
                        const roomGeometry = new THREE.BoxGeometry(20, 6, 20);
                        const roomMaterial = new THREE.MeshStandardMaterial({ color: 0xdeb887, metalness: 0.1, roughness: 0.8 });
                        const room = new THREE.Mesh(roomGeometry, roomMaterial);
                        room.position.set(0, 3, 0);
                        room.castShadow = true;
                        room.receiveShadow = true;
                        objects.push({ mesh: room, type: 'room', x: 0, z: 0 });

                        // Walls (to create rooms)
                        const wallGeometry = new THREE.BoxGeometry(2, 5, 20);
                        const wallMaterial = new THREE.MeshStandardMaterial({ color: 0x808080, metalness: 0.2, roughness: 0.7 });
                        const wall1 = new THREE.Mesh(wallGeometry, wallMaterial);
                        wall1.position.set(5, 2.5, 0);
                        wall1.castShadow = true;
                        wall1.receiveShadow = true;
                        objects.push({ mesh: wall1, type: 'wall', x: 5, z: 0 });

                        // Villager NPC (blue cube)
                        const npcGeometry = new THREE.CylinderGeometry(0.5, 0.5, 2, 32);
                        const npcMaterial = new THREE.MeshStandardMaterial({ color: 0x00008b, metalness: 0.3, roughness: 0.6 });
                        const villager = new THREE.Mesh(npcGeometry, npcMaterial);
                        villager.position.set(8, 1, 8);
                        villager.castShadow = true;
                        objects.push({ mesh: villager, type: 'npc', x: 8, z: 8, role: 'villager' });

                        // Door (red plane to exit)
                        const doorGeometry = new THREE.PlaneGeometry(2, 4);
                        const doorMaterial = new THREE.MeshStandardMaterial({ color: 0xff0000, side: THREE.DoubleSide });
                        const door = new THREE.Mesh(doorGeometry, doorMaterial);
                        door.position.set(-9, 2, -9); // Bottom-left exit
                        door.rotation.y = Math.PI / 2;
                        objects.push({ mesh: door, type: 'door', x: -9, z: -9, building: 'town' });
                    }
                    return objects;
                }
                createEnemies(scene) {
                    const enemies = [];
                    if (scene === 'town') {
                        const enemyGeometry = new THREE.SphereGeometry(0.8, 32, 32);
                        const enemyMaterial = new THREE.MeshStandardMaterial({ color: 0xff0000, metalness: 0.5, roughness: 0.5 });
                        const enemy = new THREE.Mesh(enemyGeometry, enemyMaterial);
                        enemy.position.set(15, 0.8, 15);
                        enemy.castShadow = true;
                        enemies.push({ mesh: enemy, x: 15, z: 15, speed: 0.2, health: 20 });
                    }
                    return enemies;
                }
                createNPCs(scene) {
                    const npcs = [];
                    if (scene === 'town') {
                        const npcGeometry = new THREE.CylinderGeometry(0.5, 0.5, 2, 32);
                        const npcMaterial = new THREE.MeshStandardMaterial({ color: 0x00008b, metalness: 0.3, roughness: 0.6 });
                        const guard = new THREE.Mesh(npcGeometry, npcMaterial);
                        guard.position.set(0, 1, 0);
                        guard.castShadow = true;
                        npcs.push({ mesh: guard, x: 0, z: 0, role: 'guard' });
                    }
                    return npcs;
                }
                updateObjects() {
                    scene.remove(...this.objects.map(obj => obj.mesh));
                    scene.remove(...this.enemies.map(enemy => enemy.mesh));
                    scene.remove(...this.npcs.map(npc => npc.mesh));
                    this.objects = this.createObjects(this.scene);
                    this.enemies = this.createEnemies(this.scene);
                    this.npcs = this.createNPCs(this.scene);
                    this.objects.forEach(obj => scene.add(obj.mesh));
                    this.enemies.forEach(enemy => scene.add(enemy.mesh));
                    this.npcs.forEach(npc => scene.add(npc.mesh));
                }
            }

            let game = new Game();

            // Camera setup
            camera.position.set(0, 10, 20);
            camera.lookAt(0, 0, 0);

            // Input handling
            const keys = {};
            document.addEventListener('keydown', (e) => keys[e.key] = true);
            document.addEventListener('keyup', (e) => keys[e.key] = false);

            document.addEventListener('mousedown', () => {
                document.body.requestPointerLock();
            });

            document.addEventListener('mousemove', (event) => {
                if (document.pointerLockElement === document.body) {
                    const movementX = event.movementX || event.mozMovementX || event.webkitMovementX || 0;
                    const movementY = event.movementY || event.mozMovementY || event.webkitMovementY || 0;
                    game.player.yaw += movementX * 0.002;
                    game.player.pitch = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, game.player.pitch + movementY * 0.002));
                }
            });

            // Update and render loop
            function update() {
                game.updateDayNight();

                let dx = 0, dz = 0;
                if (keys['ArrowUp']) dz -= game.player.speed;
                if (keys['ArrowDown']) dz += game.player.speed;
                if (keys['ArrowLeft']) dx -= game.player.speed;
                if (keys['ArrowRight']) dx += game.player.speed;

                const newX = game.player.x + dx * Math.cos(game.player.yaw) + dz * Math.sin(game.player.yaw);
                const newZ = game.player.z - dx * Math.sin(game.player.yaw) + dz * Math.cos(game.player.yaw);

                if (!game.objects.some(obj => {
                    const distX = Math.abs(obj.x - newX);
                    const distZ = Math.abs(obj.z - newZ);
                    return (obj.type === 'building' || obj.type === 'wall') && distX < 5 && distZ < 5;
                }) && !game.enemies.some(enemy => {
                    const distX = Math.abs(enemy.x - newX);
                    const distZ = Math.abs(enemy.z - newZ);
                    return distX < 2 && distZ < 2;
                })) {
                    game.player.x = newX;
                    game.player.z = newZ;
                }

                game.player.object.position.set(game.player.x, 1, game.player.z);
                game.player.object.rotation.y = -game.player.yaw;

                // Camera follows player with pitch control
                camera.position.set(
                    game.player.x + 10 * Math.sin(game.player.yaw) * Math.cos(game.player.pitch),
                    10 + 10 * Math.sin(game.player.pitch),
                    game.player.z + 10 * Math.cos(game.player.yaw) * Math.cos(game.player.pitch)
                );
                camera.lookAt(game.player.x, 1, game.player.z);

                // Enemy AI (simple pursuit)
                game.enemies.forEach(enemy => {
                    const dx = game.player.x - enemy.x;
                    const dz = game.player.z - enemy.z;
                    const distance = Math.sqrt(dx * dx + dz * dz);
                    if (distance < 20) {
                        enemy.x += dx / distance * enemy.speed;
                        enemy.z += dz / distance * enemy.speed;
                        enemy.mesh.position.set(enemy.x, 0.8, enemy.z);
                    }

                    // Check for combat
                    if (distance < 2) {
                        if (keys['Space']) {
                            if (game.mana >= 10) {
                                enemy.health -= 5;
                                game.mana -= 10;
                                game.showDialogue(`Attacked enemy! Enemy health: ${enemy.health}`);
                                if (enemy.health <= 0) {
                                    scene.remove(enemy.mesh);
                                    game.enemies = game.enemies.filter(e => e !== enemy);
                                    game.artifacts++;
                                    game.showDialogue('Enemy defeated! Gained an artifact!');
                                }
                            } else {
                                game.showDialogue('Not enough mana to attack!');
                            }
                        }
                    }
                });

                // NPC interactions
                game.npcs.forEach(npc => {
                    const distX = Math.abs(npc.x - game.player.x);
                    const distZ = Math.abs(npc.z - game.player.z);
                    if (distX < 2 && distZ < 2) {
                        if (npc.role === 'guard' && !game.quests.townGuard.completed) {
                            if (!game.quests.townGuard.active) {
                                game.showDialogue('Town Guard: Princess, a monster roams the town! Defeat it with your magic (press Space) and bring me an artifact.');
                                game.quests.townGuard.active = true;
                            } else if (game.artifacts > 0) {
                                game.showDialogue('Town Guard: Thank you! Here’s a key.');
                                game.keys++;
                                game.artifacts--;
                                game.quests.townGuard.completed = true;
                            } else {
                                game.showDialogue('Town Guard: Did you defeat the monster yet?');
                            }
                        } else if (npc.role === 'king' && !game.quests.castleKing.completed) {
                            if (!game.quests.castleKing.active && game.flowers > 0) {
                                game.showDialogue('King: Please, bring me a flower for the royal garden.');
                                game.quests.castleKing.active = true;
                            } else if (game.quests.castleKing.active && game.flowers > 0) {
                                game.showDialogue('King: Thank you! Here’s a gem.');
                                game.gems++;
                                game.flowers--;
                                game.quests.castleKing.completed = true;
                            } else {
                                game.showDialogue('King: I need a flower for the garden.');
                            }
                        } else if (npc.role === 'villager' && !game.quests.villager.completed) {
                            if (!game.quests.villager.active) {
                                game.showDialogue('Villager: I lost my gem in the house. Find it, and I’ll give you a potion!');
                                game.quests.villager.active = true;
                            } else if (game.gems > 0) {
                                game.showDialogue('Villager: Thank you! Here’s a potion.');
                                game.potions++;
                                game.gems--;
                                game.quests.villager.completed = true;
                            } else {
                                game.showDialogue('Villager: Did you find my gem?');
                            }
                        }
                    }
                });

                // Object interactions
                game.objects.forEach(obj => {
                    const distX = Math.abs(obj.x - game.player.x);
                    const distZ = Math.abs(obj.z - game.player.z);
                    if (distX < 1 && distZ < 1) {
                        if (obj.type === 'flower') {
                            game.flowers++;
                            scene.remove(obj.mesh);
                            game.objects = game.objects.filter(o => o !== obj);
                            game.showDialogue('You picked a flower! *Sparkle*');
                        } else if (obj.type === 'coin') {
                            game.coins++;
                            scene.remove(obj.mesh);
                            game.objects = game.objects.filter(o => o !== obj);
                            game.showDialogue('You found a coin!');
                        } else if (obj.type === 'gem') {
                            game.gems++;
                            scene.remove(obj.mesh);
                            game.objects = game.objects.filter(o => o !== obj);
                            game.showDialogue('You found a gem!');
                        } else if (obj.type === 'potion') {
                            game.potions++;
                            game.health = Math.min(100, game.health + 20);
                            scene.remove(obj.mesh);
                            game.objects = game.objects.filter(o => o !== obj);
                            game.showDialogue('You drank a potion! Health restored.');
                        } else if (obj.type === 'key') {
                            game.keys++;
                            scene.remove(obj.mesh);
                            game.objects = game.objects.filter(o => o !== obj);
                            game.showDialogue('You found a key!');
                        } else if (obj.type === 'artifact') {
                            game.artifacts++;
                            scene.remove(obj.mesh);
                            game.objects = game.objects.filter(o => o !== obj);
                            game.showDialogue('You found an artifact!');
                        } else if (obj.type === 'door') {
                            if (game.scene === 'town') {
                                if (obj.building === 'castle' && game.keys > 0) {
                                    game.scene = 'castle';
                                    game.keys--;
                                    game.player.x = 0;
                                    game.player.z = 0;
                                    game.player.yaw = 0;
                                    game.updateObjects();
                                    game.showDialogue('Entered the castle!');
                                } else if (obj.building === 'house') {
                                    game.scene = 'house';
                                    game.player.x = 0;
                                    game.player.z = 0;
                                    game.player.yaw = 0;
                                    game.updateObjects();
                                    game.showDialogue('Entered the house!');
                                } else {
                                    game.showDialogue('Need a key to enter the castle!');
                                }
                            } else if (game.scene !== 'town' && obj.building === 'town') {
                                game.scene = 'town';
                                game.player.x = obj.x;
                                game.player.z = obj.z;
                                game.player.yaw = 0;
                                game.updateObjects();
                                game.showDialogue('Returned to the town!');
                            }
                        } else if (obj.type === 'shop') {
                            if (game.coins >= 5) {
                                game.coins -= 5;
                                game.potions++;
                                game.health = Math.min(100, game.health + 20);
                                game.showDialogue('Shopkeeper: Bought a potion! Health restored.');
                            } else {
                                game.showDialogue('Shopkeeper: Need 5 coins for a potion!');
                            }
                        }
                    }
                });

                if (game.health <= 0) {
                    game.showDialogue('Game Over! You were defeated.');
                    game.health = 100;
                    game.mana = 50;
                    game.player.x = 0;
                    game.player.z = 0;
                    game.scene = 'town';
                    game.updateObjects();
                }

                if (Object.values(keys).some(k => k)) {
                    game.player.frame = (game.player.frame + 1) % 30;
                }

                // Update dialogue
                if (game.dialogueTimer > 0) {
                    game.dialogueTimer--;
                    if (game.dialogueTimer === 0) {
                        game.dialogue = '';
                    }
                }
                document.getElementById('dialogue').textContent = game.dialogue;

                // Update UI
                document.getElementById('flowers').textContent = game.flowers;
                document.getElementById('coins').textContent = game.coins;
                document.getElementById('gems').textContent = game.gems;
                document.getElementById('potions').textContent = game.potions;
                document.getElementById('keys').textContent = game.keys;
                document.getElementById('artifacts').textContent = game.artifacts;
                document.getElementById('health').textContent = game.health;
                document.getElementById('mana').textContent = game.mana;
                document.getElementById('time').textContent = game.time;
                document.getElementById('location').textContent = game.scene.charAt(0).toUpperCase() + game.scene.slice(1);
            }

            function animate() {
                requestAnimationFrame(animate);
                update();
                renderer.render(scene, camera);

                // Update sky color for day/night
                const sky = scene.getObjectByName('sky');
                if (sky) {
                    sky.material.color.set(game.time === 'Day' ? 0x87ceeb : 0x2f4f4f);
                }
            }

            animate();

            // Handle window resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        } catch (error) {
            console.error('WebGL Error:', error);
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('gameCanvas').style.display = 'none';
            document.getElementById('ui').style.display = 'none';
            document.getElementById('dialogue').style.display = 'none';
        }
    </script>
</body>
</html>
