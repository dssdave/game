<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=no">
  <title>Princess Donia’s Town – Enhanced RPG</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      background: #000;
      font-family: Arial, sans-serif;
      overflow: hidden;
      user-select: none;
      touch-action: manipulation;
    }
    #gameContainer {
      position: relative;
      width: 100vw;
      height: 100vh;
    }
    canvas { display: block; }
    #ui, #ballCount, #dialogue, #controls, #errorMessage, #guardPopup, #healthBar, #inventory {
      background: rgba(0,0,0,0.7);
      border: 4px solid #fff;
      border-radius: 5px;
      color: #fff;
      font-size: 28px;
      padding: 20px 30px;
      position: absolute;
      z-index: 10;
    }
    #ui         { top: 10px; left: 10px; }
    #ballCount  { top: 10px; right: 10px; }
    #dialogue   { bottom: 10px; left: 10px; max-width: 600px; display: none; }
    #controls   { bottom: 10px; right: 10px; }
    #errorMessage {
      top: 50%; left: 50%;
      transform: translate(-50%,-50%);
      display: none;
    }
    #guardPopup {
      bottom: 50%; left: 50%;
      transform: translate(-50%,50%);
      display: none; text-align: center;
    }
    #healthBar {
      top: 10px; left: 50%;
      transform: translateX(-50%);
      width: 300px; height: 20px;
      background: #333;
      border: 3px solid #fff;
      border-radius: 10px;
      overflow: hidden;
    }
    #healthFill {
      width: 100%; height: 100%;
      background: #00ff00;
      transition: width 0.3s, background 0.3s;
    }
    #toggleUIBtn {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 11;
      font-size: 24px;
      padding: 10px 20px;
      background: #333;
      color: #fff;
      border: 2px solid #fff;
      border-radius: 5px;
      cursor: pointer;
    }
    #inventory {
      display: none;
      top: 50%; left: 50%;
      transform: translate(-50%,-50%);
      padding: 30px;
      border: 4px solid #ffd700;
      border-radius: 15px;
      font-size: 24px;
      text-align: center;
    }
    @media (max-width: 768px) {
      #ui, #ballCount, #dialogue, #controls, #guardPopup, #errorMessage {
        font-size: 16px;
        padding: 10px 15px;
      }
      #toggleUIBtn { font-size: 16px; }
      #healthBar { width: 200px; }
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <button id="toggleUIBtn">Toggle UI</button>
    <div id="ui">
      Flowers: <span id="flowers">0</span> |
      Coins: <span id="coins">0</span> |
      Gems: <span id="gems">0</span> |
      Potions: <span id="potions">0</span> |
      Keys: <span id="keys">0</span> |
      Artifacts: <span id="artifacts">0</span> |
      Health: <span id="health">100</span> |
      Time: <span id="time">Day</span> |
      Location: <span id="location">Town</span>
    </div>
    <div id="ballCount">Magic Orbs Thrown: <span id="ballCountValue">0</span></div>
    <div id="dialogue"></div>
    <div id="controls">
      Controls:<br>
      [Desktop] WASD/Arrows = move/turn, Space = throw orb, B = jump, I = inventory<br>
      [Mobile] Left joystick = move, Right side tap = throw orb, Bottom right B = jump
    </div>
    <div id="errorMessage">WebGL not supported in your browser.</div>
    <div id="guardPopup"></div>
    <div id="healthBar"><div id="healthFill"></div></div>
    <div id="inventory">
      <div>Flowers Collected: <span id="invFlowers">0</span></div>
      <div style="margin-top:20px;">Quest: Collect 10 flowers to restore the garden's magic!</div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    // Toggle UI
    document.getElementById('toggleUIBtn').addEventListener('click', () => {
      const ids = ["ui", "ballCount", "dialogue", "controls", "guardPopup", "errorMessage", "healthBar"];
      ids.forEach(id => {
        const el = document.getElementById(id);
        el.style.display = (el.style.display === "none") ? "block" : "none";
      });
    });

    // Mobile Joystick
    const joystick = {
      active: false, startX: 0, startY: 0, currentX: 0, currentY: 0,
      forward: 0, strafe: 0, element: null, nipple: null
    };

    function createJoystick() {
      const joy = document.createElement('div');
      joy.style.position = 'absolute';
      joy.style.left = '5vw';
      joy.style.bottom = '16vh';
      joy.style.width = '120px';
      joy.style.height = '120px';
      joy.style.background = 'rgba(255,255,255,0.1)';
      joy.style.border = '3px solid #fff';
      joy.style.borderRadius = '50%';
      joy.style.zIndex = '15';

      const nipple = document.createElement('div');
      nipple.style.position = 'absolute';
      nipple.style.width = '50px';
      nipple.style.height = '50px';
      nipple.style.background = 'rgba(255,255,255,0.4)';
      nipple.style.borderRadius = '50%';
      nipple.style.left = '35px';
      nipple.style.top = '35px';
      nipple.style.transition = '0.1s';

      joy.appendChild(nipple);
      document.getElementById('gameContainer').appendChild(joy);
      joystick.element = joy;
      joystick.nipple = nipple;

      const start = (e) => {
        e.preventDefault();
        joystick.active = true;
        const rect = joy.getBoundingClientRect();
        joystick.startX = rect.left + 60;
        joystick.startY = rect.top + 60;
        move(e);
      };
      const move = (e) => {
        if (!joystick.active) return;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const dx = clientX - joystick.startX;
        const dy = clientY - joystick.startY;
        const dist = Math.min(Math.hypot(dx, dy), 50);
        const angle = Math.atan2(dx, dy);
        joystick.currentX = dist * Math.sin(angle);
        joystick.currentY = dist * Math.cos(angle);
        nipple.style.transform = `translate(${joystick.currentX}px, ${joystick.currentY}px)`;
        joystick.forward = joystick.currentY / 50;
        joystick.strafe = joystick.currentX / 50;
      };
      const end = () => {
        joystick.active = false;
        nipple.style.transform = 'translate(0px,0px)';
        joystick.forward = joystick.strafe = 0;
      };

      joy.addEventListener('touchstart', start, {passive:false});
      joy.addEventListener('touchmove', move, {passive:false});
      joy.addEventListener('touchend', end);
      joy.addEventListener('mousedown', start);
      joy.addEventListener('mousemove', move);
      joy.addEventListener('mouseup', end);
      joy.addEventListener('mouseleave', end);
    }
    createJoystick();

    // Action buttons (Throw = A, Jump = B)
    const actionContainer = document.createElement('div');
    actionContainer.style.position = 'absolute';
    actionContainer.style.bottom = '16vh';
    actionContainer.style.right = '5vw';
    actionContainer.style.display = 'flex';
    actionContainer.style.flexDirection = 'column';
    actionContainer.style.gap = '15px';
    actionContainer.style.zIndex = '15';

    const btnThrow = document.createElement('button');
    btnThrow.textContent = 'A (Orb)';
    btnThrow.style.width = '70px'; btnThrow.style.height = '70px';
    btnThrow.style.background = 'rgba(255,100,100,0.6)';
    btnThrow.style.border = '3px solid #fff';
    btnThrow.style.borderRadius = '50%';
    btnThrow.style.fontSize = '16px'; btnThrow.style.color = '#fff';

    const btnJump = document.createElement('button');
    btnJump.textContent = 'B (Jump)';
    btnJump.style.width = '70px'; btnJump.style.height = '70px';
    btnJump.style.background = 'rgba(100,100,255,0.6)';
    btnJump.style.border = '3px solid #fff';
    btnJump.style.borderRadius = '50%';
    btnJump.style.fontSize = '16px'; btnJump.style.color = '#fff';

    actionContainer.appendChild(btnThrow);
    actionContainer.appendChild(btnJump);
    document.getElementById('gameContainer').appendChild(actionContainer);

    // Global variables
    const outsideScene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 3000);
    let game = null;
    const keysPressed = {};

    class Game {
      constructor() {
        this.renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('gameCanvas'), antialias: true });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        this.renderer.shadowMap.enabled = true;

        this.player = { x:0, y:0.5, z:0, yaw:0, jumpVelocity:0, object:null, bobTime:0 };
        this.flowers = 0; this.coins = 0;
        this.health = 100; this.ballCount = 0;
        this.thrownBalls = []; // reused for sparks too
        this.dayNightCounter = 0; this.time = "Day";
        this.outsideObjects = [];
        this.questActive = false; this.questComplete = false;

        this.initScene();
        this.createPlayer();
        this.createWater();
        this.createFireflies();
        this.startAnimation();
        this.initInput();
      }

      initScene() {
        outsideScene.background = new THREE.Color(0x87CEEB);
        const ground = new THREE.Mesh(
          new THREE.PlaneGeometry(400,400),
          new THREE.MeshStandardMaterial({color:0x6bb26b})
        );
        ground.rotation.x = -Math.PI/2;
        ground.receiveShadow = true;
        outsideScene.add(ground);

        const ambient = new THREE.AmbientLight(0xffffff, 0.6);
        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(50,100,50);
        dirLight.castShadow = true;
        outsideScene.add(ambient, dirLight);

        this.createSun();
        this.createMoon();
        this.createStars();
        this.createCastle();
        this.createHouse();
        this.createCafe();
        this.createFountain();
        this.createBlueNPC();
        this.createFlowers(20);
      }

      createPlayer() {
        const group = new THREE.Group();
        const dress = new THREE.Mesh(new THREE.ConeGeometry(0.6,1.6,16), new THREE.MeshStandardMaterial({color:0xff69b4}));
        dress.position.y = 0.7;
        group.add(dress);

        const torso = new THREE.Mesh(new THREE.CylinderGeometry(0.35,0.4,0.8,16), new THREE.MeshStandardMaterial({color:0xffa0d0}));
        torso.position.y = 1.2;
        group.add(torso);

        const head = new THREE.Mesh(new THREE.SphereGeometry(0.3,16,16), new THREE.MeshStandardMaterial({color:0xffddc1}));
        head.position.y = 1.8;
        group.add(head);

        const hair = new THREE.Mesh(new THREE.CylinderGeometry(0.35,0.45,1.2,16), new THREE.MeshStandardMaterial({color:0xb5651d}));
        hair.position.y = 1.9;
        group.add(hair);

        const crown = new THREE.Mesh(new THREE.TorusGeometry(0.32,0.08,8,16), new THREE.MeshStandardMaterial({color:0xffd700, emissive:0xffd700, emissiveIntensity:0.8}));
        crown.rotation.x = Math.PI/2;
        crown.position.y = 2.15;
        group.add(crown);

        const armGeo = new THREE.CylinderGeometry(0.1,0.1,0.9,8);
        const armMat = new THREE.MeshStandardMaterial({color:0xffddc1});
        const leftArm = new THREE.Mesh(armGeo, armMat);
        leftArm.position.set(-0.5,1.3,0);
        leftArm.rotation.z = 0.3;
        leftArm.userData.arm = true;
        const rightArm = leftArm.clone();
        rightArm.position.x = 0.5;
        rightArm.rotation.z = -0.3;
        group.add(leftArm, rightArm);

        group.position.set(this.player.x, this.player.y, this.player.z);
        this.player.object = group;
        outsideScene.add(group);
      }

      createWater() {
        const geo = new THREE.PlaneGeometry(300,80);
        const mat = new THREE.MeshStandardMaterial({color:0x1e90ff, transparent:true, opacity:0.7});
        const water = new THREE.Mesh(geo, mat);
        water.rotation.x = -Math.PI/2;
        water.position.set(0,0.1,-70);
        water.userData.time = 0;
        outsideScene.add(water);
        this.waterMesh = water;
      }

      createFireflies() {
        const count = 80;
        const positions = new Float32Array(count*3);
        for(let i=0;i<count;i++){
          positions[i*3] = (Math.random()-0.5)*200;
          positions[i*3+1] = 5 + Math.random()*20;
          positions[i*3+2] = (Math.random()-0.5)*200;
        }
        const geo = new THREE.BufferGeometry();
        geo.setAttribute('position', new THREE.BufferAttribute(positions,3));
        const mat = new THREE.PointsMaterial({color:0xffff88, size:3, transparent:true});
        const flies = new THREE.Points(geo, mat);
        flies.visible = false;
        outsideScene.add(flies);
        this.fireflies = flies;
      }

      createSun() {
        const sun = new THREE.Mesh(new THREE.SphereGeometry(10,16,16), new THREE.MeshBasicMaterial({color:0xffee00}));
        sun.position.set(0,200,-200);
        this.sunMesh = sun;
        outsideScene.add(sun);
      }

      createMoon() {
        const moon = new THREE.Mesh(new THREE.SphereGeometry(6,16,16), new THREE.MeshBasicMaterial({color:0xddddff}));
        moon.position.set(-100,150,100);
        moon.visible = false;
        this.moonMesh = moon;
        outsideScene.add(moon);
      }

      createStars() {
        const count = 300;
        const positions = new Float32Array(count*3);
        for(let i=0;i<count;i++){
          const r = 300 + Math.random()*200;
          const a = Math.random()*Math.PI*2;
          positions[i*3] = Math.cos(a)*r;
          positions[i*3+1] = 50 + Math.random()*100;
          positions[i*3+2] = Math.sin(a)*r;
        }
        const geo = new THREE.BufferGeometry();
        geo.setAttribute('position', new THREE.BufferAttribute(positions,3));
        const mat = new THREE.PointsMaterial({color:0xffffff, size:1.5});
        const stars = new THREE.Points(geo, mat);
        stars.visible = false;
        this.starsMesh = stars;
        outsideScene.add(stars);
      }

      createCastle() { /* Keep your original castle code or simplified version */ 
        const group = new THREE.Group();
        const stoneTex = this.generateStoneTexture();
        const mat = new THREE.MeshStandardMaterial({map:stoneTex});
        const base = new THREE.Mesh(new THREE.BoxGeometry(20,10,20), mat);
        base.position.y = 5;
        group.add(base);
        group.position.set(40,0,40);
        outsideScene.add(group);
        this.outsideObjects.push({type:'building', x:40, z:40, boundingRadius:12});
      }

      generateStoneTexture() {
        const canvas = document.createElement('canvas');
        canvas.width = canvas.height = 256;
        const ctx = canvas.getContext('2d');
        for(let y=0;y<256;y+=16)for(let x=0;x<256;x+=16){
          const shade = 100 + Math.random()*60;
          ctx.fillStyle = `rgb(${shade},${shade},${shade})`;
          ctx.fillRect(x,y,16,16);
        }
        return new THREE.CanvasTexture(canvas);
      }

      createHouse() { /* Simplified or keep yours */ }
      createCafe() { /* Simplified */ }
      createFountain() { /* Simplified */ }

      createBlueNPC() {
        // Simple blue NPC for quest
        const group = new THREE.Group();
        const body = new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.5,1.2,16), new THREE.MeshStandardMaterial({color:0x0000ff}));
        body.position.y = 0.6;
        group.add(body);
        group.position.set(20,0.5,20);
        outsideScene.add(group);
      }

      createFlowers(count) {
        for(let i=0;i<count;i++){
          const x = Math.random()*160-80;
          const z = Math.random()*160-80;
          const flower = new THREE.Group();
          const stem = new THREE.Mesh(new THREE.CylinderGeometry(0.05,0.05,1,8), new THREE.MeshStandardMaterial({color:0x008000}));
          stem.position.y = 0.5;
          const bloom = new THREE.Mesh(new THREE.SphereGeometry(0.25,12,12), new THREE.MeshStandardMaterial({color:0xff1493}));
          bloom.position.y = 1;
          flower.add(stem,bloom);
          flower.position.set(x,0,z);
          outsideScene.add(flower);
          this.outsideObjects.push({type:'flower', mesh:flower, x, z});
        }
      }

      update() {
        this.updateDayNight();
        this.updateWater();
        this.updateFireflies();
        this.updateMovement();
        this.updateCamera();
        this.updatePickups();
        this.updateQuest();
        this.updateBalls();
        document.getElementById('healthFill').style.width = this.health + '%';
        document.getElementById('healthFill').style.background = this.health < 30 ? '#ff0000' : '#00ff00';
      }

      updateDayNight() {
        this.dayNightCounter = (this.dayNightCounter + 1) % 18000;
        this.time = this.dayNightCounter < 9000 ? "Day" : "Night";
        document.getElementById('time').textContent = this.time;
        outsideScene.background = new THREE.Color(this.time === "Day" ? 0x87CEEB : 0x000033);
        this.sunMesh.visible = this.time === "Day";
        this.moonMesh.visible = this.time === "Night";
        this.starsMesh.visible = this.time === "Night";
        this.fireflies.visible = this.time === "Night";
      }

      updateWater() {
        if(this.waterMesh){
          this.waterMesh.userData.time += 0.01;
          const pos = this.waterMesh.geometry.attributes.position;
          for(let i=0;i<pos.count;i++){
            const vx = pos.getX(i);
            const vz = pos.getZ(i);
            const y = Math.sin(vx*0.1 + this.waterMesh.userData.time)*0.3 + Math.sin(vz*0.15 + this.waterMesh.userData.time*1.2)*0.2;
            pos.setY(i, y);
          }
          pos.needsUpdate = true;
        }
      }

      updateFireflies() {
        if(!this.fireflies.visible) return;
        const pos = this.fireflies.geometry.attributes.position.array;
        const t = Date.now()*0.001;
        for(let i=0;i<pos.length;i+=3) pos[i+1] += Math.sin(t*2 + i)*0.03;
        this.fireflies.geometry.attributes.position.needsUpdate = true;
      }

      updateMovement() {
        let forward = 0, strafe = 0, turn = 0;
        if(keysPressed['w'] || keysPressed['ArrowUp']) forward += 1;
        if(keysPressed['s'] || keysPressed['ArrowDown']) forward -= 1;
        if(keysPressed['a'] || keysPressed['ArrowLeft']) turn += 1;
        if(keysPressed['d'] || keysPressed['ArrowRight']) turn -= 1;

        forward += joystick.forward;
        strafe += joystick.strafe;

        const speed = 0.12;
        const dir = new THREE.Vector3(Math.sin(this.player.yaw), 0, Math.cos(this.player.yaw));
        const right = new THREE.Vector3(Math.cos(this.player.yaw), 0, -Math.sin(this.player.yaw));
        const move = dir.multiplyScalar(forward*speed).add(right.multiplyScalar(strafe*speed));

        this.player.x += move.x;
        this.player.z += move.z;
        this.player.yaw -= turn * 0.03;

        if(this.player.jumpVelocity){
          this.player.jumpVelocity -= 0.02;
          this.player.y += this.player.jumpVelocity;
          if(this.player.y < 0.5){
            this.player.y = 0.5;
            this.player.jumpVelocity = 0;
          }
        }

        if(Math.abs(forward)+Math.abs(strafe) > 0.1){
          this.player.bobTime += 0.15;
          this.player.object.position.y = 0.5 + Math.sin(this.player.bobTime)*0.05;
        } else {
          this.player.object.position.y = this.player.y;
        }

        this.player.object.position.x = this.player.x;
        this.player.object.position.z = this.player.z;
        this.player.object.rotation.y = this.player.yaw;

        this.player.object.traverse(c => {
          if(c.userData.arm){
            c.rotation.z = Math.sin(this.player.bobTime)*0.6 * (c.position.x > 0 ? -1 : 1);
          }
        });
      }

      updateCamera() {
        const offset = new THREE.Vector3(-Math.sin(this.player.yaw)*18, 12, -Math.cos(this.player.yaw)*18);
        camera.position.lerp(this.player.object.position.clone().add(offset), 0.1);
        camera.lookAt(this.player.object.position.x, this.player.object.position.y + 1.5, this.player.object.position.z);
      }

      updatePickups() {
        for(let i=this.outsideObjects.length-1;i>=0;i--){
          const o = this.outsideObjects[i];
          if(o.type === 'flower'){
            const dx = this.player.x - o.x;
            const dz = this.player.z - o.z;
            if(dx*dx + dz*dz < 2){
              this.flowers++;
              document.getElementById('flowers').textContent = this.flowers;
              document.getElementById('invFlowers').textContent = this.flowers;
              this.createSparkles(o.x, 1, o.z);
              outsideScene.remove(o.mesh);
              this.outsideObjects.splice(i,1);
            }
          }
        }
      }

      createSparkles(x,y,z) {
        for(let i=0;i<15;i++){
          const s = new THREE.Mesh(new THREE.SphereGeometry(0.1,8,8), new THREE.MeshBasicMaterial({color:0xffff00}));
          s.position.set(x + (Math.random()-0.5), y + Math.random(), z + (Math.random()-0.5));
          s.userData = {vel:new THREE.Vector3((Math.random()-0.5)*0.1, 0.1+Math.random()*0.1, (Math.random()-0.5)*0.1), life:60};
          outsideScene.add(s);
          this.thrownBalls.push(s);
        }
      }

      updateQuest() {
        if(!this.questActive && this.flowers >= 1){
          this.showDialogue("Blue Spirit: Princess! Please collect 10 flowers to restore the garden's magic!");
          this.questActive = true;
        }
        if(this.questActive && !this.questComplete && this.flowers >= 10){
          this.showDialogue("Blue Spirit: Thank you! The garden blooms again! Your magic grows stronger.");
          this.questComplete = true;
          this.health = 100;
        }
      }

      throwBall() {
        const dir = new THREE.Vector3(Math.sin(this.player.yaw), 0.3, Math.cos(this.player.yaw)).normalize().multiplyScalar(0.8);
        const ball = new THREE.Mesh(new THREE.SphereGeometry(0.3,16,16), new THREE.MeshStandardMaterial({color:0xff4500, emissive:0xff4500, emissiveIntensity:2}));
        ball.position.copy(this.player.object.position);
        ball.position.y += 1;
        const light = new THREE.PointLight(0xff4500, 2, 15);
        ball.add(light);
        ball.userData = {velocity:dir, timer:0};
        outsideScene.add(ball);
        this.thrownBalls.push(ball);
        this.ballCount++;
        document.getElementById('ballCountValue').textContent = this.ballCount;
        this.showDialogue("Magic Orb!");
      }

      jump() {
        if(this.player.y <= 0.51){
          this.player.jumpVelocity = 0.35;
          this.showDialogue("♪ Jump! ♪");
        }
      }

      updateBalls() {
        for(let i=this.thrownBalls.length-1;i>=0;i--){
          const b = this.thrownBalls[i];
          if(b.userData.velocity){
            b.position.add(b.userData.velocity);
            b.userData.velocity.y -= 0.015;
            b.userData.timer++;
            if(b.userData.timer > 200 || b.position.y < 0){
              outsideScene.remove(b);
              this.thrownBalls.splice(i,1);
            }
          } else if(b.userData.life){
            b.userData.life--;
            b.position.add(b.userData.vel);
            b.scale.multiplyScalar(0.95);
            if(b.userData.life <= 0){
              outsideScene.remove(b);
              this.thrownBalls.splice(i,1);
            }
          }
        }
      }

      showDialogue(text) {
        const d = document.getElementById('dialogue');
        d.textContent = text;
        d.style.display = 'block';
        clearTimeout(this.dlgTimeout);
        this.dlgTimeout = setTimeout(() => d.style.display = 'none', 2500);
      }

      initInput() {
        document.addEventListener('keydown', e => {
          keysPressed[e.key.toLowerCase()] = true;
          if(e.key === ' ') this.throwBall();
          if(e.key.toLowerCase() === 'b') this.jump();
          if(e.key.toLowerCase() === 'i'){
            const inv = document.getElementById('inventory');
            inv.style.display = inv.style.display === 'none' ? 'block' : 'none';
          }
        });
        document.addEventListener('keyup', e => { keysPressed[e.key.toLowerCase()] = false; });

        btnThrow.addEventListener('click', () => this.throwBall());
        btnThrow.addEventListener('touchstart', e => { e.preventDefault(); this.throwBall(); });
        btnJump.addEventListener('click', () => this.jump());
        btnJump.addEventListener('touchstart', e => { e.preventDefault(); this.jump(); });
      }

      startAnimation() {
        const animate = () => {
          requestAnimationFrame(animate);
          this.update();
          this.renderer.render(outsideScene, camera);
        };
        animate();
      }
    }

    window.onload = () => {
      try {
        game = new Game();
        window.game = game;
      } catch(e) {
        console.error(e);
        document.getElementById('errorMessage').style.display = 'block';
      }
    };
  </script>
</body>
</html>
