<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Princess D - Maximum Adventure</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #87ceeb;
            overflow: hidden;
        }
        canvas {
            border: 1px solid black;
            background-color: #7cfc00;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="1920" height="1080"></canvas>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let score = 0;
        let jumps = 0;
        let lives = 3;
        let gameState = 'title';
        let level = 1;
        const maxLevels = 3;

        // Princess properties
        let princess = {
            x: 100,
            y: 900,
            width: 50,
            height: 50,
            speed: 6,
            velY: 0,
            jumping: false,
            grounded: false,
            invincible: false,
            speedBoost: false,
            crown: null // For crown toss attack
        };

        // Physics
        const gravity = 0.9;
        const jumpPower = -18;

        // Platforms (level-specific)
        let platforms = [
            {x: 0, y: 1000, width: 1920, height: 80, type: 'ground'},
            {x: 300, y: 800, width: 250, height: 20, type: 'static'},
            {x: 700, y: 600, width: 200, height: 20, type: 'moving', dx: 2, minX: 700, maxX: 900},
            {x: 1200, y: 400, width: 300, height: 20, type: 'static'}
        ];

        // Enemies
        let enemies = [
            {x: 400, y: 950, width: 40, height: 40, speed: 3, direction: 1, type: 'bat'},
            {x: 800, y: 950, width: 50, height: 30, speed: 4, direction: -1, type: 'roller'}
        ];

        // Collectibles/Power-Ups
        let collectibles = [
            {x: 350, y: 750, size: 30, type: 'coin', points: 10},
            {x: 750, y: 550, size: 30, type: 'tiara', effect: 'invincible'},
            {x: 1300, y: 350, size: 30, type: 'slippers', effect: 'speed'}
        ];

        // Weather effect (simulated)
        let weather = {active: false, type: 'rain', slowFactor: 0.7};

        // Input handling
        const keys = {};
        document.addEventListener('keydown', (e) => keys[e.key] = true);
        document.addEventListener('keyup', (e) => keys[e.key] = false);

        // Collision detection
        function rectIntersect(r1, r2) {
            return !(r1.x + r1.width < r2.x || r1.x > r2.x + r2.width ||
                     r1.y + r1.height < r2.y || r1.y > r2.y + r2.height);
        }

        // Platform collision
        function checkPlatformCollision() {
            princess.grounded = false;
            for (let plat of platforms) {
                if (rectIntersect(princess, plat) && princess.velY >= 0) {
                    princess.y = plat.y - princess.height;
                    princess.velY = 0;
                    princess.grounded = true;
                    princess.jumping = false;
                }
                // Move with moving platforms
                if (plat.type === 'moving' && princess.grounded && plat === platforms.find(p => rectIntersect(princess, p))) {
                    princess.x += plat.dx;
                }
            }
        }

        // Collectible pickup
        function checkCollectibles() {
            for (let i = collectibles.length - 1; i >= 0; i--) {
                let col = collectibles[i];
                if (rectIntersect(princess, {x: col.x, y: col.y, width: col.size, height: col.size})) {
                    if (col.type === 'coin') score += col.points;
                    else if (col.type === 'tiara') {
                        princess.invincible = true;
                        setTimeout(() => princess.invincible = false, 5000);
                    } else if (col.type === 'slippers') {
                        princess.speedBoost = true;
                        setTimeout(() => princess.speedBoost = false, 7000);
                    }
                    collectibles.splice(i, 1);
                }
            }
        }

        // Enemy collision
        function checkEnemyCollision() {
            for (let enemy of enemies) {
                if (rectIntersect(princess, enemy) && !princess.invincible) {
                    lives--;
                    princess.x = 100;
                    princess.y = 900;
                    if (lives <= 0) gameState = 'gameover';
                }
            }
        }

        // Move enemies
        function moveEnemies() {
            for (let enemy of enemies) {
                enemy.x += enemy.speed * enemy.direction;
                if (enemy.x < 0 || enemy.x > canvas.width - enemy.width) enemy.direction *= -1;
            }
        }

        // Move platforms
        function movePlatforms() {
            for (let plat of platforms) {
                if (plat.type === 'moving') {
                    plat.x += plat.dx;
                    if (plat.x < plat.minX || plat.x > plat.maxX) plat.dx *= -1;
                }
            }
        }

        // Crown toss
        function tossCrown() {
            if (!princess.crown && keys['c']) {
                princess.crown = {x: princess.x + princess.width, y: princess.y, width: 20, height: 20, speed: 10};
            }
            if (princess.crown) {
                princess.crown.x += princess.crown.speed;
                for (let i = enemies.length - 1; i >= 0; i--) {
                    if (rectIntersect(princess.crown, enemies[i])) {
                        enemies.splice(i, 1);
                        princess.crown = null;
                        score += 20;
                        break;
                    }
                }
                if (princess.crown && princess.crown.x > canvas.width) princess.crown = null;
            }
        }

        // Update princess
        function updatePrincess() {
            let currentSpeed = princess.speedBoost ? princess.speed * 1.5 : princess.speed;
            if (weather.active) currentSpeed *= weather.slowFactor;

            if (keys['ArrowLeft']) princess.x -= currentSpeed;
            if (keys['ArrowRight']) princess.x += currentSpeed;
            if (keys[' '] && princess.grounded) {
                princess.velY = jumpPower;
                princess.jumping = true;
                princess.grounded = false;
                jumps++;
            }

            princess.velY += gravity;
            princess.y += princess.velY;

            princess.x = Math.max(0, Math.min(canvas.width - princess.width, princess.x));
            checkPlatformCollision();
            tossCrown();

            if (princess.y > canvas.height) {
                lives--;
                princess.x = 100;
                princess.y = 900;
                if (lives <= 0) gameState = 'gameover';
            }
        }

        // Drawing functions
        function drawPrincess() {
            ctx.fillStyle = princess.invincible ? '#ffd700' : '#ff69b4';
            ctx.fillRect(princess.x, princess.y, princess.width, princess.height);
            // Crown
            ctx.fillStyle = '#ffd700';
            ctx.fillRect(princess.x + 15, princess.y - 10, 20, 10);
            if (princess.crown) {
                ctx.fillRect(princess.crown.x, princess.crown.y, princess.crown.width, princess.crown.height);
            }
        }

        function drawPlatforms() {
            for (let plat of platforms) {
                ctx.fillStyle = plat.type === 'ground' ? '#8b4513' : '#228b22';
                ctx.fillRect(plat.x, plat.y, plat.width, plat.height);
            }
        }

        function drawEnemies() {
            for (let enemy of enemies) {
                ctx.fillStyle = enemy.type === 'bat' ? '#4b0082' : '#ff4500';
                ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
            }
        }

        function drawCollectibles() {
            for (let col of collectibles) {
                if (col.type === 'coin') {
                    ctx.fillStyle = '#ffd700';
                    ctx.beginPath();
                    ctx.arc(col.x + col.size / 2, col.y + col.size / 2, col.size / 2, 0, Math.PI * 2);
                    ctx.fill();
                } else if (col.type === 'tiara') {
                    ctx.fillStyle = '#00ffff';
                    ctx.fillRect(col.x, col.y, col.size, col.size);
                } else if (col.type === 'slippers') {
                    ctx.fillStyle = '#ff00ff';
                    ctx.fillRect(col.x, col.y, col.size, col.size);
                }
            }
        }

        function drawWeather() {
            if (weather.active && weather.type === 'rain') {
                ctx.fillStyle = 'rgba(0, 0, 255, 0.3)';
                for (let i = 0; i < 100; i++) {
                    let x = Math.random() * canvas.width;
                    let y = Math.random() * canvas.height;
                    ctx.fillRect(x, y, 2, 10);
                }
            }
        }

        function drawUI() {
            ctx.fillStyle = 'black';
            ctx.font = '32px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(`Score: ${score}`, 20, 40);
            ctx.fillText(`Jumps: ${jumps}`, 20, 80);
            ctx.fillText(`Lives: ${lives}`, 20, 120);
            ctx.fillText(`Level: ${level}`, 20, 160);
        }

        // Level progression
        function loadLevel() {
            platforms = [
                {x: 0, y: 1000, width: 1920, height: 80, type: 'ground'},
                {x: 300 + level * 100, y: 800 - level * 50, width: 250, height: 20, type: 'static'},
                {x: 700 + level * 100, y: 600 - level * 50, width: 200, height: 20, type: 'moving', dx: 2 + level, minX: 700 + level * 100, maxX: 900 + level * 100},
                {x: 1200 + level * 100, y: 400 - level * 50, width: 300, height: 20, type: 'static'}
            ];
            enemies = [
                {x: 400 + level * 150, y: 950, width: 40, height: 40, speed: 3 + level, direction: 1, type: 'bat'},
                {x: 800 + level * 150, y: 950, width: 50, height: 30, speed: 4 + level, direction: -1, type: 'roller'}
            ];
            collectibles = [
                {x: 350 + level * 150, y: 750 - level * 50, size: 30, type: 'coin', points: 10},
                {x: 750 + level * 150, y: 550 - level * 50, size: 30, type: 'tiara', effect: 'invincible'},
                {x: 1300 + level * 150, y: 350 - level * 50, size: 30, type: 'slippers', effect: 'speed'}
            ];
            weather.active = level > 1; // Rain starts at level 2
        }

        // Game loop
        function gameLoop() {
            if (gameState === 'playing') {
                updatePrincess();
                moveEnemies();
                movePlatforms();
                checkCollectibles();
                checkEnemyCollision();

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawWeather();
                drawPlatforms();
                drawCollectibles();
                drawEnemies();
                drawPrincess();
                drawUI();

                if (collectibles.length === 0) {
                    level++;
                    if (level > maxLevels) {
                        gameState = 'gameover';
                    } else {
                        loadLevel();
                        princess.x = 100;
                        princess.y = 900;
                    }
                }
            } else if (gameState === 'title') {
                ctx.fillStyle = 'black';
                ctx.font = '80px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Princess D: Royal Quest', canvas.width / 2, canvas.height / 2 - 100);
                ctx.font = '40px Arial';
                ctx.fillText('Press any key to start', canvas.width / 2, canvas.height / 2 + 50);
                ctx.fillText('Controls: ← → to move, Space to jump, C to toss crown', canvas.width / 2, canvas.height / 2 + 100);
                if (Object.values(keys).some(k => k)) gameState = 'playing';
            } else if (gameState === 'gameover') {
                ctx.fillStyle = 'black';
                ctx.font = '80px Arial';
                ctx.textAlign = 'center';
                if (level > maxLevels) {
                    ctx.fillText('Victory!', canvas.width / 2, canvas.height / 2 - 100);
                    // Victory dance (simple animation)
                    ctx.fillStyle = '#ff69b4';
                    let danceX = canvas.width / 2 - 25 + Math.sin(Date.now() / 100) * 20;
                    ctx.fillRect(danceX, canvas.height / 2 + 50, 50, 50);
                } else {
                    ctx.fillText('Game Over', canvas.width / 2, canvas.height / 2 - 100);
                }
                ctx.font = '40px Arial';
                ctx.fillText(`Score: ${score}`, canvas.width / 2, canvas.height / 2);
                ctx.fillText(`Jumps: ${jumps}`, canvas.width / 2, canvas.height / 2 + 50);
                ctx.fillText('Press any key to restart', canvas.width / 2, canvas.height / 2 + 100);
                if (Object.values(keys).some(k => k)) {
                    score = 0;
                    jumps = 0;
                    lives = 3;
                    level = 1;
                    princess = {x: 100, y: 900, width: 50, height: 50, speed: 6, velY: 0, jumping: false, grounded: false, invincible: false, speedBoost: false, crown: null};
                    loadLevel();
                    gameState = 'title';
                }
            }
            requestAnimationFrame(gameLoop);
        }

        loadLevel();
        gameLoop();
    </script>
</body>
</html>
