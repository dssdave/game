<!DOCTYPE html>
<html>
<head>
    <title>Enhanced Princess RPG</title>
    <style>
        #gameContainer {
            text-align: center;
            font-family: Arial, sans-serif;
        }
        canvas {
            border: 1px solid black;
        }
        #ui {
            margin-top: 10px;
            font-size: 18px;
        }
        #dialogue {
            margin-top: 10px;
            font-size: 16px;
            color: #333;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div id="ui">
            Flowers: <span id="flowers">0</span> |
            Coins: <span id="coins">0</span> |
            Gems: <span id="gems">0</span> |
            Potions: <span id="potions">0</span> |
            Location: <span id="location">Town</span>
        </div>
        <div id="dialogue"></div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const TILE_SIZE = 32;
        const GRID_WIDTH = 25;
        const GRID_HEIGHT = 18;

        // Game state
        class Game {
            constructor() {
                this.scene = 'town';
                this.flowers = 0;
                this.coins = 0;
                this.gems = 0;
                this.potions = 0;
                this.player = {
                    x: 12 * TILE_SIZE,
                    y: 9 * TILE_SIZE,
                    speed: 4,
                    frame: 0,
                    direction: 'down',
                    questStatus: { townGuard: false, castleKing: false }
                };
                this.dialogue = '';
                this.dialogueTimer = 0;
            }
            showDialogue(text) {
                this.dialogue = text;
                this.dialogueTimer = 120; // Display for 2 seconds (60 FPS)
            }
        }

        let game = new Game();

        // Expanded tile map (0=grass, 1=path, 2=water, 3=building wall, 4=door, 5=flower, 6=coin, 7=gem, 8=potion, 9=NPC)
        const maps = {
            town: [
                [2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],
                [2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
                [2,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,2],
                [2,0,1,0,0,0,0,0,0,0,0,0,0,9,0,0,0,0,0,1,0,0,0,0,2],
                [2,0,1,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,2],
                [2,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,6,0,2],
                [2,0,1,0,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0,1,0,0,0,0,2],
                [2,0,1,0,0,0,0,0,0,0,3,4,3,0,0,0,0,0,0,1,0,0,0,0,2],
                [2,0,1,0,0,0,0,0,0,0,3,3,3,0,0,0,0,0,0,1,0,0,0,0,2],
                [2,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,2],
                [2,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,1,0,5,0,0,2],
                [2,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,7,0,2],
                [2,0,1,0,0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,1,0,0,0,0,2],
                [2,0,1,0,0,0,0,0,0,0,0,3,4,0,0,0,0,0,0,1,0,0,0,0,2],
                [2,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,1,0,0,0,0,2],
                [2,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,2],
                [2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
                [2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2]
            ],
            castle: [
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
                [0,1,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,1,0],
                [0,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0],
                [0,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0],
                [0,1,3,0,0,0,0,9,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0],
                [0,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0],
                [0,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0],
                [0,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0],
                [0,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0],
                [0,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0],
                [0,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0],
                [0,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0],
                [0,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0],
                [0,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0],
                [0,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,1,0],
                [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],
            house: [
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
                [0,1,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,1,0],
                [0,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0],
                [0,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0],
                [0,1,3,0,0,0,0,9,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0],
                [0,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0],
                [0,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0],
                [0,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0],
                [0,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0],
                [0,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0],
                [0,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0],
                [0,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0],
                [0,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0],
                [0,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0],
                [0,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,1,0],
                [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ]
        };

        // Input handling
        const keys = {};
        document.addEventListener('keydown', (e) => keys[e.key] = true);
        document.addEventListener('keyup', (e) => keys[e.key] = false);

        // Enhanced drawing functions for detailed sprites
        function drawTile(type, x, y) {
            ctx.save();
            switch(type) {
                case 0: // Grass (detailed with texture-like pattern)
                    ctx.fillStyle = '#90ee90';
                    ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
                    ctx.fillStyle = '#7b9e7b';
                    ctx.fillRect(x, y, TILE_SIZE/2, TILE_SIZE/2);
                    break;
                case 1: // Path (cobblestone-like)
                    ctx.fillStyle = '#d2b48c';
                    ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
                    ctx.fillStyle = '#c68e6e';
                    for (let i = 0; i < 2; i++) {
                        for (let j = 0; j < 2; j++) {
                            ctx.fillRect(x + i * TILE_SIZE/2, y + j * TILE_SIZE/2, TILE_SIZE/4, TILE_SIZE/4);
                        }
                    }
                    break;
                case 2: // Water (wavy blue)
                    ctx.fillStyle = '#87ceeb';
                    ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
                    ctx.strokeStyle = '#4169e1';
                    ctx.beginPath();
                    ctx.moveTo(x, y + TILE_SIZE/2);
                    ctx.quadraticCurveTo(x + TILE_SIZE/2, y, x + TILE_SIZE, y + TILE_SIZE/2);
                    ctx.stroke();
                    break;
                case 3: // Building wall (stone with texture)
                    ctx.fillStyle = '#808080';
                    ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
                    ctx.fillStyle = '#666666';
                    for (let i = 0; i < 2; i++) {
                        for (let j = 0; j < 2; j++) {
                            ctx.fillRect(x + i * TILE_SIZE/2, y + j * TILE_SIZE/2, TILE_SIZE/4, TILE_SIZE/4);
                        }
                    }
                    break;
                case 4: // Door (ornate wood)
                    ctx.fillStyle = '#8b4513';
                    ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
                    ctx.fillStyle = '#5c2f00';
                    ctx.fillRect(x + TILE_SIZE/4, y + TILE_SIZE/4, TILE_SIZE/2, TILE_SIZE/2);
                    ctx.fillStyle = '#ff8c00';
                    ctx.fillRect(x + TILE_SIZE/2 - 2, y + TILE_SIZE/4, 4, 8);
                    break;
                case 5: // Flower (detailed petals)
                    ctx.fillStyle = '#ff00ff';
                    ctx.beginPath();
                    ctx.arc(x + TILE_SIZE/2, y + TILE_SIZE/2, TILE_SIZE/3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#ff69b4';
                    for (let i = 0; i < 4; i++) {
                        ctx.beginPath();
                        ctx.moveTo(x + TILE_SIZE/2, y + TILE_SIZE/2);
                        ctx.lineTo(x + TILE_SIZE/2 + Math.cos(i * Math.PI/2) * TILE_SIZE/2, y + TILE_SIZE/2 + Math.sin(i * Math.PI/2) * TILE_SIZE/2);
                        ctx.lineTo(x + TILE_SIZE/2 + Math.cos(i * Math.PI/2 + Math.PI/8) * TILE_SIZE/3, y + TILE_SIZE/2 + Math.sin(i * Math.PI/2 + Math.PI/8) * TILE_SIZE/3);
                        ctx.fill();
                    }
                    ctx.fillStyle = '#00ff00';
                    ctx.beginPath();
                    ctx.arc(x + TILE_SIZE/2, y + TILE_SIZE/2, TILE_SIZE/6, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                case 6: // Coin (shiny gold)
                    ctx.fillStyle = '#ffd700';
                    ctx.beginPath();
                    ctx.arc(x + TILE_SIZE/2, y + TILE_SIZE/2, TILE_SIZE/3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.strokeStyle = '#daa520';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    ctx.fillStyle = '#ffffff';
                    ctx.beginPath();
                    ctx.arc(x + TILE_SIZE/2, y + TILE_SIZE/2, TILE_SIZE/6, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                case 7: // Gem (sparkling)
                    ctx.fillStyle = '#00ffff';
                    ctx.beginPath();
                    ctx.moveTo(x + TILE_SIZE/2, y + TILE_SIZE/4);
                    ctx.lineTo(x + TILE_SIZE/4, y + 3*TILE_SIZE/4);
                    ctx.lineTo(x + 3*TILE_SIZE/4, y + 3*TILE_SIZE/4);
                    ctx.closePath();
                    ctx.fill();
                    ctx.strokeStyle = '#00c0c0';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    ctx.fillStyle = '#ffffff';
                    ctx.beginPath();
                    ctx.arc(x + TILE_SIZE/2, y + TILE_SIZE/2, TILE_SIZE/8, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                case 8: // Potion (bottle with liquid)
                    ctx.fillStyle = '#ff4500';
                    ctx.fillRect(x + TILE_SIZE/4, y + TILE_SIZE/4, TILE_SIZE/2, TILE_SIZE/2);
                    ctx.fillStyle = '#ff8c00';
                    ctx.fillRect(x + TILE_SIZE/3, y + TILE_SIZE/3, TILE_SIZE/3, TILE_SIZE/3);
                    ctx.fillStyle = '#ffffff';
                    ctx.beginPath();
                    ctx.arc(x + TILE_SIZE/2, y + TILE_SIZE/4, TILE_SIZE/8, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                case 9: // NPC (guard or villager)
                    ctx.fillStyle = '#00008b';
                    ctx.fillRect(x + 8, y + 8, 16, 24);
                    ctx.fillStyle = '#ff4500';
                    ctx.fillRect(x + 12, y + 10, 8, 8); // Helmet or hat
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(x + 14, y + 12, 4, 4); // Eyes
                    break;
            }
            ctx.restore();
        }

        function drawPlayer(x, y, frame, direction) {
            ctx.save();
            // Body (elaborate pink dress with gold trim)
            ctx.fillStyle = '#ff69b4';
            ctx.fillRect(x + 8, y + 8, 16, 24);
            ctx.strokeStyle = '#ffd700';
            ctx.lineWidth = 2;
            ctx.strokeRect(x + 8, y + 8, 16, 24);
            // Crown (ornate gold with jewels)
            ctx.fillStyle = '#ffd700';
            ctx.fillRect(x + 6, y, 20, 8);
            ctx.fillStyle = '#00ffff';
            ctx.beginPath();
            ctx.arc(x + 10, y + 4, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x + 22, y + 4, 4, 0, Math.PI * 2);
            ctx.fill();
            // Face (detailed peach with blush)
            ctx.fillStyle = '#ffe4c4';
            ctx.fillRect(x + 12, y + 10, 8, 6);
            ctx.fillStyle = '#ff69b4';
            ctx.beginPath();
            ctx.arc(x + 14, y + 12, 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x + 18, y + 12, 2, 0, Math.PI * 2);
            ctx.fill();
            // Walking animation (detailed legs and arms)
            if (frame > 15) {
                ctx.fillStyle = '#ff69b4';
                if (direction === 'left') {
                    ctx.fillRect(x + 4, y + 24, 8, 8); // Left leg
                    ctx.fillRect(x + 24, y + 16, 8, 8); // Right arm
                } else if (direction === 'right') {
                    ctx.fillRect(x + 20, y + 24, 8, 8); // Right leg
                    ctx.fillRect(x + 4, y + 16, 8, 8); // Left arm
                } else if (direction === 'up') {
                    ctx.fillRect(x + 12, y + 16, 8, 8); // Legs together
                    ctx.fillRect(x + 8, y + 8, 8, 8); // Arms up
                } else if (direction === 'down') {
                    ctx.fillRect(x + 12, y + 24, 8, 8); // Legs down
                    ctx.fillRect(x + 16, y + 8, 8, 8); // Arms down
                }
            }
            ctx.restore();
        }

        // Collision detection
        function isCollision(x, y) {
            const gridX = Math.floor(x / TILE_SIZE);
            const gridY = Math.floor(y / TILE_SIZE);
            const tile = maps[game.scene][gridY][gridX];
            return tile === 2 || tile === 3; // Water or building wall
        }

        function update() {
            let newX = game.player.x;
            let newY = game.player.y;

            if (keys['ArrowUp']) {
                newY -= game.player.speed;
                game.player.direction = 'up';
            }
            if (keys['ArrowDown']) {
                newY += game.player.speed;
                game.player.direction = 'down';
            }
            if (keys['ArrowLeft']) {
                newX -= game.player.speed;
                game.player.direction = 'left';
            }
            if (keys['ArrowRight']) {
                newX += game.player.speed;
                game.player.direction = 'right';
            }

            if (!isCollision(newX, newY) && !isCollision(newX + TILE_SIZE - 1, newY) &&
                !isCollision(newX, newY + TILE_SIZE - 1) && !isCollision(newX + TILE_SIZE - 1, newY + TILE_SIZE - 1)) {
                game.player.x = Math.max(0, Math.min(canvas.width - TILE_SIZE, newX));
                game.player.y = Math.max(0, Math.min(canvas.height - TILE_SIZE, newY));
            }

            const gridX = Math.floor(game.player.x / TILE_SIZE);
            const gridY = Math.floor(game.player.y / TILE_SIZE);
            const tile = maps[game.scene][gridY][gridX];

            if (tile === 4) { // Door
                if (game.scene === 'town') {
                    game.scene = gridY === 7 ? 'castle' : 'house';
                } else {
                    game.scene = 'town';
                }
                game.player.x = 12 * TILE_SIZE;
                game.player.y = 9 * TILE_SIZE;
            } else if (tile === 5) { // Flower
                game.flowers++;
                maps[game.scene][gridY][gridX] = 0;
                game.showDialogue('You picked a flower! So pretty!');
            } else if (tile === 6) { // Coin
                game.coins++;
                maps[game.scene][gridY][gridX] = 0;
                game.showDialogue('You found a shiny coin!');
            } else if (tile === 7) { // Gem
                game.gems++;
                maps[game.scene][gridY][gridX] = 0;
                game.showDialogue('A sparkling gem! Valuable!');
            } else if (tile === 8) { // Potion
                game.potions++;
                maps[game.scene][gridY][gridX] = 0;
                game.showDialogue('You found a healing potion!');
            } else if (tile === 9) { // NPC
                if (game.scene === 'town' && !game.questStatus.townGuard) {
                    game.showDialogue('Town Guard: Help! The king needs a flower for his crown. Bring one to the castle!');
                    game.questStatus.townGuard = true;
                } else if (game.scene === 'town' && game.questStatus.townGuard) {
                    game.showDialogue('Town Guard: Have you delivered the flower to the king?');
                } else if (game.scene === 'castle' && !game.questStatus.castleKing && game.flowers > 0) {
                    game.showDialogue('King: Thank you, princess! Here’s a gem as reward.');
                    game.gems++;
                    game.flowers--;
                    game.questStatus.castleKing = true;
                } else if (game.scene === 'castle' && game.questStatus.castleKing) {
                    game.showDialogue('King: You’re a hero, princess!');
                } else if (game.scene === 'house') {
                    game.showDialogue('Villager: Welcome! Want a potion? I have extras.');
                }
            }

            if (Object.values(keys).some(k => k)) {
                game.player.frame = (game.player.frame + 1) % 30;
            }

            // Update dialogue
            if (game.dialogueTimer > 0) {
                game.dialogueTimer--;
                if (game.dialogueTimer === 0) {
                    game.dialogue = '';
                }
            }
            document.getElementById('dialogue').textContent = game.dialogue;
        }

        function draw() {
            ctx.fillStyle = game.scene === 'town' ? '#90ee90' : '#deb887';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            for (let y = 0; y < GRID_HEIGHT; y++) {
                for (let x = 0; x < GRID_WIDTH; x++) {
                    drawTile(maps[game.scene][y][x], x * TILE_SIZE, y * TILE_SIZE);
                }
            }

            drawPlayer(game.player.x, game.player.y, game.player.frame, game.player.direction);

            document.getElementById('flowers').textContent = game.flowers;
            document.getElementById('coins').textContent = game.coins;
            document.getElementById('gems').textContent = game.gems;
            document.getElementById('potions').textContent = game.potions;
            document.getElementById('location').textContent = game.scene.charAt(0).toUpperCase() + game.scene.slice(1);
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        gameLoop();
    </script>
</body>
</html>
