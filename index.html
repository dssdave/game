<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Princess Adventure - Enhanced Edition</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: linear-gradient(to bottom, #87ceeb, #e0ffff); /* Gradient sky */
        }
        canvas {
            border: 1px solid black;
            background-color: #228b22; /* Forest green base */
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="640" height="480"></canvas>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const tileSize = 16; // Smaller tiles for detailed graphics
        let score = 0;
        let currentScene = 'town';
        let fadeAlpha = 0;
        let isFading = false;
        let fadeDirection = 1;
        let targetScene = '';

        // Maps for different scenes
        const townMap = {
            grid: [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            items: [
                {x: 4 * tileSize, y: 4 * tileSize, type: 'flower', points: 10, collected: false},
                {x: 6 * tileSize, y: 8 * tileSize, type: 'coin', points: 5, collected: false},
                {x: 12 * tileSize, y: 5 * tileSize, type: 'flower', points: 10, collected: false},
                {x: 14 * tileSize, y: 9 * tileSize, type: 'coin', points: 5, collected: false}
            ],
            doors: [
                {x: 2 * tileSize, y: 2 * tileSize, width: tileSize, height: tileSize, target: 'castle'},
                {x: 16 * tileSize, y: 2 * tileSize, width: tileSize, height: tileSize, target: 'house'}
            ]
        };

        const castleMap = {
            grid: [
                [1,1,1,1,1,1,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,2,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,1,1,1,1,1,1]
            ],
            items: [],
            doors: [
                {x: 3 * tileSize, y: 3 * tileSize, width: tileSize, height: tileSize, target: 'town'}
            ]
        };

        const houseMap = {
            grid: [
                [1,1,1,1,1],
                [1,0,0,0,1],
                [1,0,0,0,1],
                [1,0,2,0,1],
                [1,1,1,1,1]
            ],
            items: [],
            doors: [
                {x: 2 * tileSize, y: 3 * tileSize, width: tileSize, height: tileSize, target: 'town'}
            ]
        };

        // Princess object with animation
        let princess = {
            x: 5 * tileSize,
            y: 5 * tileSize,
            width: tileSize,
            height: tileSize,
            speed: 2,
            direction: 'down',
            frame: 0,
            animationCounter: 0
        };

        // Keyboard input handling
        const keys = {};
        document.addEventListener('keydown', (e) => keys[e.key] = true);
        document.addEventListener('keyup', (e) => keys[e.key] = false);

        // Helper functions
        function getCurrentMap() {
            return currentScene === 'town' ? townMap : currentScene === 'castle' ? castleMap : houseMap;
        }

        function checkCollision(x, y) {
            const map = getCurrentMap().grid;
            const col = Math.floor(x / tileSize);
            const row = Math.floor(y / tileSize);
            return row < 0 || row >= map.length || col < 0 || col >= map[0].length || map[row][col] === 1;
        }

        function checkItemCollection() {
            const items = getCurrentMap().items;
            for (let item of items) {
                if (!item.collected &&
                    princess.x < item.x + tileSize &&
                    princess.x + princess.width > item.x &&
                    princess.y < item.y + tileSize &&
                    princess.y + princess.height > item.y) {
                    item.collected = true;
                    score += item.points;
                }
            }
        }

        function checkDoorInteraction() {
            const doors = getCurrentMap().doors;
            for (let door of doors) {
                if (princess.x < door.x + door.width &&
                    princess.x + princess.width > door.x &&
                    princess.y < door.y + door.height &&
                    princess.y + princess.height > door.y) {
                    targetScene = door.target;
                    isFading = true;
                    fadeDirection = 1;
                    return;
                }
            }
        }

        // Enhanced drawing functions
        function drawMap() {
            const map = getCurrentMap().grid;
            for (let row = 0; row < map.length; row++) {
                for (let col = 0; col < map[row].length; col++) {
                    if (map[row][col] === 0) {
                        // Grass with texture
                        ctx.fillStyle = '#32cd32';
                        ctx.fillRect(col * tileSize, row * tileSize, tileSize, tileSize);
                        ctx.fillStyle = '#228b22';
                        ctx.fillRect(col * tileSize + 2, row * tileSize + 2, tileSize - 4, tileSize - 4);
                    } else if (map[row][col] === 1) {
                        // Stone wall with detail
                        ctx.fillStyle = '#808080';
                        ctx.fillRect(col * tileSize, row * tileSize, tileSize, tileSize);
                        ctx.fillStyle = '#a9a9a9';
                        ctx.fillRect(col * tileSize + 1, row * tileSize + 1, tileSize - 2, tileSize - 2);
                    } else if (map[row][col] === 2) {
                        // Door with wood texture
                        ctx.fillStyle = '#0000ff';
                        ctx.fillRect(col * tileSize, row * tileSize, tileSize, tileSize);
                        ctx.fillStyle = '#00008b';
                        ctx.fillRect(col * tileSize + 2, row * tileSize + 2, tileSize - 4, tileSize - 4);
                    }
                }
            }
            // Building details in town
            if (currentScene === 'town') {
                // Castle
                ctx.fillStyle = '#696969';
                ctx.fillRect(1 * tileSize, 1 * tileSize, tileSize * 2, tileSize * 2);
                ctx.fillStyle = '#ff0000';
                ctx.fillRect(1 * tileSize + 2, 1 * tileSize - 4, tileSize * 2 - 4, 4);
                // House
                ctx.fillStyle = '#8b4513';
                ctx.fillRect(15 * tileSize, 1 * tileSize, tileSize * 2, tileSize * 2);
                ctx.fillStyle = '#cd853f';
                ctx.fillRect(15 * tileSize + 2, 1 * tileSize - 4, tileSize * 2 - 4, 4);
            }
        }

        function drawItems() {
            const items = getCurrentMap().items;
            for (let item of items) {
                if (!item.collected) {
                    if (item.type === 'flower') {
                        // Detailed flower sprite
                        ctx.fillStyle = '#ffff00';
                        ctx.fillRect(item.x + 4, item.y + 4, 8, 8);
                        ctx.fillStyle = '#ff4500';
                        ctx.fillRect(item.x + 6, item.y + 6, 4, 4);
                        ctx.fillStyle = '#006400';
                        ctx.fillRect(item.x + 7, item.y + 10, 2, 6);
                    } else {
                        // Detailed coin sprite
                        ctx.fillStyle = '#ffa500';
                        ctx.fillRect(item.x + 4, item.y + 4, 8, 8);
                        ctx.fillStyle = '#ffd700';
                        ctx.fillRect(item.x + 5, item.y + 5, 4, 4);
                    }
                }
            }
        }

        function drawPrincess() {
            princess.animationCounter++;
            if (princess.animationCounter % 10 === 0) {
                princess.frame = (princess.frame + 1) % 2;
            }
            // Dress
            ctx.fillStyle = '#ff69b4';
            ctx.fillRect(princess.x + 2, princess.y + 4, 12, 10);
            // Head
            ctx.fillStyle = '#ffdab9';
            ctx.fillRect(princess.x + 4, princess.y, 8, 6);
            // Crown
            ctx.fillStyle = '#ffd700';
            ctx.fillRect(princess.x + 6, princess.y - 2, 4, 2);
            // Legs animation
            ctx.fillStyle = '#000000';
            if (princess.frame === 0) {
                ctx.fillRect(princess.x + 4, princess.y + 14, 2, 2);
                ctx.fillRect(princess.x + 10, princess.y + 14, 2, 2);
            } else {
                ctx.fillRect(princess.x + 6, princess.y + 14, 2, 2);
                ctx.fillRect(princess.x + 8, princess.y + 14, 2, 2);
            }
        }

        function handleFade() {
            if (isFading) {
                fadeAlpha += 0.05 * fadeDirection;
                if (fadeAlpha >= 1 && fadeDirection === 1) {
                    currentScene = targetScene;
                    if (currentScene === 'town') {
                        princess.x = targetScene === 'castle' ? 2 * tileSize : 16 * tileSize;
                        princess.y = 3 * tileSize;
                    } else if (currentScene === 'castle') {
                        princess.x = 3 * tileSize;
                        princess.y = 2 * tileSize;
                    } else if (currentScene === 'house') {
                        princess.x = 2 * tileSize;
                        princess.y = 2 * tileSize;
                    }
                    fadeDirection = -1;
                } else if (fadeAlpha <= 0 && fadeDirection === -1) {
                    isFading = false;
                    fadeAlpha = 0;
                }
                ctx.fillStyle = `rgba(0, 0, 0, ${fadeAlpha})`;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
        }

        // Game loop
        function gameLoop() {
            if (!isFading) {
                let dx = 0, dy = 0;
                if (keys['ArrowLeft']) { dx -= princess.speed; princess.direction = 'left'; }
                if (keys['ArrowRight']) { dx += princess.speed; princess.direction = 'right'; }
                if (keys['ArrowUp']) { dy -= princess.speed; princess.direction = 'up'; }
                if (keys['ArrowDown']) { dy += princess.speed; princess.direction = 'down'; }

                const newX = princess.x + dx;
                const newY = princess.y + dy;
                if (!checkCollision(newX, princess.y)) princess.x = newX;
                if (!checkCollision(princess.x, newY)) princess.y = newY;

                checkItemCollection();
                checkDoorInteraction();
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawMap();
            drawItems();
            drawPrincess();
            handleFade();

            // Score display
            ctx.fillStyle = '#ffffff';
            ctx.font = '16px Arial'; // Use "Press Start 2P" via Google Fonts for retro style if desired
            ctx.fillText(`Score: ${score}`, 10, 30);

            requestAnimationFrame(gameLoop);
        }

        gameLoop();
    </script>
</body>
</html>
